<!doctype html>
<html lang="ja">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1, viewport-fit=cover" />
  <title>運命の銀竜暦｜占いトップ</title>
  <meta name="description" content="運命の銀竜暦の占いトップ。無料は全体運のみ。有料で行動運・精神運が開放。小説ページやおまけページにもアクセス。">
  <style>
    html { font-size: 16px; }
    :root{
      --bg:#0b0d12; --ink:#ffffff; --muted:#aeb7d0; --line:#27304a; --card:#151826;
      --accent:#9fd3ff; --accent-2:#1a3358; --accent-2-b:#34507c;
      --radius: 0.875rem; --pad: 1rem; --gap: 0.75rem; --tap: 2.75rem;
    }
    * { box-sizing: border-box; }
    body{
      margin:0; background:var(--bg); color:var(--ink);
      font-family: system-ui, -apple-system, "Segoe UI", Roboto, "Hiragino Sans", "Noto Sans JP", sans-serif;
      line-height: 1.7; font-size: 1rem; -webkit-text-size-adjust: 100%;
      text-rendering: optimizeLegibility;
    }
    .wrap{ max-width: 35rem; margin: 0 auto; padding: 1.25rem; }

    h1{
      margin: 0 0 1rem;
      font-weight: 700;
      font-size: clamp(1.25rem, 5.5vw, 1.5rem);
      line-height: 1.2;
      text-align: center;
    }

    .card{
      background: var(--card);
      border: 1px solid var(--line);
      border-radius: var(--radius);
      padding: var(--pad);
      margin: 0.75rem 0;
    }

    .row{ display:flex; gap: 0.75rem; flex-wrap: wrap; justify-content: center; }

    button.char-btn{
      appearance: none; background: none; border: none; cursor: pointer; text-align: center;
      min-height: var(--tap); min-width: var(--tap); padding: 0.25rem; border-radius: 0.5rem;
    }
    button.char-btn:focus-visible{ outline: 2px solid var(--accent); outline-offset: 2px; }
    button.char-btn img{
      width: 5.625rem; height: 5.625rem; border-radius: 50%; border: 0.125rem solid var(--line); object-fit: cover;
    }
    button.char-btn div{ margin-top: 0.375rem; font-size: 0.875rem; }

    .muted{ color: var(--muted); font-size: 0.875rem; }
    .label{ font-size: 0.9375rem; color: #cfe1ff; margin-bottom: 0.5rem; }
    .big{ font-size: clamp(1.25rem, 5vw, 1.75rem); line-height: 1.2; }
    .msg{ margin-top: 0.375rem; color:#cdd5ea; font-size: 1rem; }
    .stars{ letter-spacing: 0.125rem; font-size: 1.125rem; }
    .gate{ opacity: .7; }

    .pill{
      display: inline-flex; align-items: center; justify-content: center;
      color: var(--accent); text-decoration: none; border: 1px solid var(--line); background: #11172a;
      padding: 0.375rem 0.625rem; border-radius: 999px; font-size: 0.8125rem; min-height: var(--tap);
    }
    .pill:hover{ background:#18213a; }
    .pill.accent{ background: var(--accent-2); border-color: var(--accent-2-b); color:#fff; }
    .pill.small{ min-height: 2rem; font-size: 0.75rem; }

    footer{ margin: 1rem 0 0.5rem; color: var(--muted); font-size: 0.75rem; text-align: center; }
    footer .links{ display:flex; gap: 0.75rem; flex-wrap: wrap; justify-content: center; margin-bottom: 0.5rem; }

    button{
      font-size: 1em; min-height: var(--tap); padding: 0.625rem 0.875rem;
      border-radius: 0.625rem; border: 1px solid #2f3b63; background: #1a2034; color: #fff; cursor: pointer;
    }
    button:hover{ background:#232b45; }
    button:focus-visible{ outline: 2px solid var(--accent); outline-offset: 2px; }
  </style>
</head>
<body>
  <div class="wrap">
    <header style="text-align:center; padding: 1.25rem 0.625rem;">
      <img src="./assets/logo.png" alt="運命の銀竜暦" style="max-width: 13.75rem; height:auto; margin-bottom: 0.5rem;" />
      <p class="muted" style="margin:0;">銀竜の言葉を継ぐ継承者の物語</p>
    </header>

    <section class="card" aria-labelledby="chooseCharacter">
      <div id="chooseCharacter" class="label" style="text-align:center;">今日は誰と話す？</div>
      <div class="row" id="charButtons">
        <button data-char="ルナル" class="char-btn" aria-label="ルナルと話す">
          <img src="./assets/char-lunal.png" alt="ルナルのアイコン"><div>ルナル</div>
        </button>
        <button data-char="アラン" class="char-btn" aria-label="アランと話す">
          <img src="./assets/char-alan.png" alt="アランのアイコン"><div>アラン</div>
        </button>
        <button data-char="リリア" class="char-btn" aria-label="リリアと話す">
          <img src="./assets/char-lilia.png" alt="リリアのアイコン"><div>リリア</div>
        </button>
      </div>
      <p class="muted" style="text-align:center; margin-top: 0.5rem;">※選ぶたびに当日の結果を表示。日付が変わると更新されます。</p>
    </section>

    <section id="result" aria-live="polite"></section>

    <section class="card" aria-labelledby="memberStatus">
      <div id="memberStatus" class="label">会員ステータス</div>
      <div class="row" style="justify-content:flex-start;">
        <span class="pill" id="statusPill" aria-live="polite">無料会員</span>
        <button id="toggleDemo" aria-pressed="false" aria-label="有料/無料のデモ切替">（デモ）有料/無料 切替</button>
      </div>
      <p class="muted">※本番ではキャリア決済完了後にサーバ側で有料フラグを付与してください。</p>
    </section>

    <footer>
      <div class="links">
        <a href="./list.html" class="pill">おまけページ</a>
        <a href="./novel.html" class="pill">小説ページ</a>
        <a href="./zodiac.html" class="pill">星座別診断表</a>
        <a href="./signup.html" class="pill accent">会員登録</a>
      </div>
      <div class="links">
        <a href="./terms.html" class="pill small">利用規約</a>
        <a href="./law.html" class="pill small">特定商取引</a>
        <a href="./privacy.html" class="pill small">個人情報保護方針</a>
        <a href="./devices.html" class="pill small">対応機種</a>
      </div>
      <div style="margin-top:0.5rem;">© 運命の銀竜暦</div>
    </footer>
  </div>

  <script>
    const JSON_PATH = "./fortune_messages.json";
    let isPremium = false;

    const TODAY_KEY = () => {
      const d = new Date(); return `${d.getFullYear()}-${d.getMonth()+1}-${d.getDate()}`;
    };
    const STORE_KEY = () => "fortune_locked_" + TODAY_KEY();

    function hashStr(s){ let h=2166136261>>>0; for(let i=0;i<s.length;i++){ h^=s.charCodeAt(i); h=Math.imul(h,16777619);} return h>>>0; }
    function mulberry32(a){ return function(){ let t=a+=0x6D2B79F5; t=Math.imul(t^(t>>>15),t|1); t^=t+Math.imul(t^(t>>>7),t|61); return ((t^(t>>>14))>>>0)/4294967296; } }
    function pickByWeights(weights, seedStr){
      const rng = mulberry32(hashStr(seedStr));
      const entries = Object.entries(weights);
      const total = entries.reduce((s,[,w])=>s+Number(w),0);
      let r = rng() * total;
      for (const [star, w] of entries){ if (r < w) return Number(star); r -= w; }
      return 3;
    }
    function starText(n){ return "★★★★★☆☆☆☆☆".slice(5-n, 10-n); }

    let MESSAGES=null, WEIGHTS=null;
    fetch(JSON_PATH)
      .then(r => r.ok ? r.json() : Promise.reject("JSONが読み込めませんでした"))
      .then(json => { MESSAGES=json.messages; WEIGHTS=json.weights; restoreOrInit(); })
      .catch(err => { console.error(err); alert("占いデータの読み込みに失敗しました。fortune_messages.json を確認してください。"); });

    function getLocked(){
      const raw = localStorage.getItem(STORE_KEY());
      if (!raw) return null;
      try { return JSON.parse(raw); } catch { return null; }
    }
    function setLocked(payload){ localStorage.setItem(STORE_KEY(), JSON.stringify(payload)); }
    function clearOldKeys(){
      Object.keys(localStorage).forEach(k=>{
        if (k.startsWith("fortune_locked_") && k !== STORE_KEY()) localStorage.removeItem(k);
      });
    }

    function generateTodayStars(){
      const day = TODAY_KEY();
      return {
        day,
        stars: {
          overall: pickByWeights(WEIGHTS, day + "|global|overall"),
          action:  pickByWeights(WEIGHTS, day + "|global|action"),
          mind:    pickByWeights(WEIGHTS, day + "|global|mind"),
        },
        character: null
      };
    }

    const resultEl = document.getElementById("result");
    const statusPill = document.getElementById("statusPill");
    const toggleDemo = document.getElementById("toggleDemo");

    toggleDemo?.addEventListener("click", ()=>{
      isPremium = !isPremium;
      toggleDemo.setAttribute("aria-pressed", String(isPremium));
      statusPill.textContent = isPremium ? "有料会員（デモ）" : "無料会員";
      const locked = getLocked();
      if (locked?.character) render(locked.character, locked.stars);
    });

    function getMessage(category, stars, character){
      const cat = MESSAGES?.[category]; if(!cat) return "";
      const byStar = cat[String(stars)]; if(!byStar) return "";
      return byStar?.[character] || "";
    }

    function ctaBlock(isPremium){
      if (isPremium) return `
        <div class="card">
          <div class="label">次はどこへ？</div>
          <div class="row">
            <a class="pill" href="./list.html">おまけページ</a>
            <a class="pill" href="./novel.html">小説ページ</a>
            <a class="pill" href="./zodiac.html">星座別診断表</a>
          </div>
        </div>`;
      return `
        <div class="card">
          <div class="label">有料会員になると</div>
          <ul style="margin:0.375rem 0 0 1rem; color:#cdd5ea; font-size:0.9375rem; line-height:1.6">
            <li>行動運・精神運の★評価が毎日開放</li>
            <li>広告なし・占い履歴の保存</li>
            <li>名言アーカイブや世界観資料にフルアクセス</li>
          </ul>
          <div class="row" style="margin-top: 0.625rem;">
            <a class="pill accent" href="./signup.html">会員登録へ</a>
            <a class="pill" href="./list.html">おまけページ</a>
            <a class="pill" href="./novel.html">小説ページ</a>
            <a class="pill" href="./zodiac.html">星座別診断表</a>
          </div>
        </div>`;
    }

    function render(character, stars){
      const sOverall = stars.overall;
      const sAction  = stars.action;
      const sMind    = stars.mind;

      const mOverall = getMessage("全体運", sOverall, character);
      const mAction  = getMessage("行動運", sAction,  character);
      const mMind    = getMessage("精神運", sMind,    character);

      resultEl.innerHTML = `
        <div class="card" aria-labelledby="selChar">
          <div id="selChar" class="label">選択した話し手</div>
          <div class="big">${character}</div>
          <p class="muted" style="margin-top:.25rem;">※本日の運勢（★）は日替わりで一意です。話し手を変えても運勢は同じです。</p>
        </div>

        <div class="card" aria-labelledby="overall">
          <div id="overall" class="label">全体運（無料）</div>
          <div class="stars" aria-label="全体運の評価">${starText(sOverall)}</div>
          <p class="msg">「${mOverall}」</p>
          <p class="muted" style="margin-top: 0.375rem;">※詳細は有料会員で開放されます</p>
        </div>

        <div class="card ${isPremium ? "" : "gate"}" aria-labelledby="act">
          <div id="act" class="label">行動運（有料）</div>
          ${isPremium ? `
            <div class="stars" aria-label="行動運の評価">${starText(sAction)}</div>
            <p class="msg">「${mAction}」</p>
          ` : `
            <p class="muted">会員登録で表示されます → <a class="pill" href="./signup.html" style="margin-left:.375rem;">会員登録</a></p>
          `}
        </div>

        <div class="card ${isPremium ? "" : "gate"}" aria-labelledby="mind">
          <div id="mind" class="label">精神運（有料）</div>
          ${isPremium ? `
            <div class="stars" aria-label="精神運の評価">${starText(sMind)}</div>
            <p class="msg">「${mMind}」</p>
          ` : `
            <p class="muted">会員登録で表示されます → <a class="pill" href="./signup.html" style="margin-left:.375rem;">会員登録</a></p>
          `}
        </div>

        ${ctaBlock(isPremium)}
      `;
    }

    function restoreOrInit(){
      clearOldKeys();
      const locked = getLocked();
      if (locked && locked.day === TODAY_KEY()){
        if (locked.character) render(locked.character, locked.stars);
      }
    }

    function confirmAndLock(firstCharacter){
      if (!MESSAGES || !WEIGHTS) return;
      const locked = getLocked();
      if (locked && locked.day === TODAY_KEY()){
        const chosen = firstCharacter || locked.character;
        setLocked({ ...locked, character: chosen });
        render(chosen, locked.stars);
        return;
      }
      const ok = window.confirm("本日の運勢を確定します。確定後は運勢（★）は本日中固定です。よろしいですか？");
      if (!ok) return;
      const stars = generateTodayStars().stars;
      const payload = { day: TODAY_KEY(), stars, character: firstCharacter };
      setLocked(payload);
      render(firstCharacter, stars);
    }

    document.getElementById("charButtons").addEventListener("click", (e)=>{
      const btn = e.target.closest("button[data-char]");
      if (!btn) return;
      const char = btn.dataset.char;
      const locked = getLocked();
      if (!locked || locked.day !== TODAY_KEY()){
        confirmAndLock(char);
      } else {
        setLocked({ ...locked, character: char });
        render(char, locked.stars);
      }
    });
  </script>
</body>
</html>

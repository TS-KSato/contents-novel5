<!doctype html>
<html lang="ja">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1, viewport-fit=cover" />
  <title>運命の銀竜暦｜占いトップ</title>
  <meta name="description" content="運命の銀竜暦の占いトップ。無料は全体運のみ。有料で行動運・精神運が開放。小説ページやおまけページにもアクセス。">
  <style>
    html { font-size: 16px; }
    :root{
      --bg:#0b0d12; --ink:#ffffff; --muted:#aeb7d0; --line:#27304a; --card:#151826;
      --accent:#9fd3ff; --accent-2:#1a3358; --accent-2-b:#34507c;
      --radius: 0.875rem; --pad: 1rem; --gap: 0.75rem; --tap: 2.75rem;
    }
    * { box-sizing: border-box; }
    body{
      margin:0; background:var(--bg); color:var(--ink);
      font-family: system-ui, -apple-system, "Segoe UI", Roboto, "Hiragino Sans", "Noto Sans JP", sans-serif;
      line-height: 1.7; font-size: 1rem; -webkit-text-size-adjust: 100%;
      text-rendering: optimizeLegibility;
    }
    .wrap{ max-width: 35rem; margin: 0 auto; padding: 1.25rem; }

    h1{
      margin: 0 0 1rem;
      font-weight: 700;
      font-size: clamp(1.25rem, 5.5vw, 1.5rem);
      line-height: 1.2;
      text-align: center;
    }

    .card{
      background: var(--card);
      border: 1px solid var(--line);
      border-radius: var(--radius);
      padding: var(--pad);
      margin: 0.75rem 0;
    }

    .row{ display:flex; gap: 0.75rem; flex-wrap: wrap; justify-content: center; }

    button.char-btn{
      appearance: none; background: none; border: none; cursor: pointer; text-align: center;
      min-height: var(--tap); min-width: var(--tap); padding: 0.25rem; border-radius: 0.5rem;
    }
    button.char-btn:focus-visible{ outline: 2px solid var(--accent); outline-offset: 2px; }
    button.char-btn img{
      width: 5.625rem; height: 5.625rem; border-radius: 50%; border: 0.125rem solid var(--line); object-fit: cover;
    }
    button.char-btn div{ margin-top: 0.375rem; font-size: 0.875rem; }

    .muted{ color: var(--muted); font-size: 0.875rem; }
    .label{ font-size: 0.9375rem; color: #cfe1ff; margin-bottom: 0.5rem; }
    .big{ font-size: clamp(1.25rem, 5vw, 1.75rem); line-height: 1.2; }
    .msg{ margin-top: 0.375rem; color:#cdd5ea; font-size: 1rem; }
    .stars{ letter-spacing: 0.125rem; font-size: 1.125rem; }
    .gate{ opacity: .7; }

    .pill{
      display: inline-flex; align-items: center; justify-content: center;
      color: var(--accent); text-decoration: none; border: 1px solid var(--line); background: #11172a;
      padding: 0.375rem 0.625rem; border-radius: 999px; font-size: 0.8125rem; min-height: var(--tap);
    }
    .pill:hover{ background:#18213a; }
    .pill.accent{ background: var(--accent-2); border-color: var(--accent-2-b); color:#fff; }
    .pill.small{ min-height: 2rem; font-size: 0.75rem; }

    footer{ margin: 1rem 0 0.5rem; color: var(--muted); font-size: 0.75rem; text-align: center; }
    footer .links{ display:flex; gap: 0.75rem; flex-wrap: wrap; justify-content: center; margin-bottom: 0.5rem; }

    button{
      font-size: 1em; min-height: var(--tap); padding: 0.625rem 0.875rem;
      border-radius: 0.625rem; border: 1px solid #2f3b63; background: #1a2034; color: #fff; cursor: pointer;
    }
    button:hover{ background:#232b45; }
    button:focus-visible{ outline: 2px solid var(--accent); outline-offset: 2px; }
  </style>
</head>
<body>
  <div class="wrap">
    <header style="text-align:center; padding: 1.25rem 0.625rem;">
      <img src="./assets/logo.png" alt="運命の銀竜暦" style="max-width: 13.75rem; height:auto; margin-bottom: 0.5rem;" />
      <p class="muted" style="margin:0;">銀竜の言葉を継ぐ継承者の物語</p>
    </header>

    <section class="card" aria-labelledby="chooseCharacter">
      <div id="chooseCharacter" class="label" style="text-align:center;">今日は誰と話す？</div>
      <div class="row" id="charButtons">
        <button data-char="ルナル" class="char-btn" aria-label="ルナルと話す">
          <img src="./assets/char-lunal.png" alt="ルナルのアイコン"><div>ルナル</div>
        </button>
        <button data-char="アラン" class="char-btn" aria-label="アランと話す">
          <img src="./assets/char-alan.png" alt="アランのアイコン"><div>アラン</div>
        </button>
        <button data-char="リリア" class="char-btn" aria-label="リリアと話す">
          <img src="./assets/char-lilia.png" alt="リリアのアイコン"><div>リリア</div>
        </button>
      </div>
      <p class="muted" style="text-align:center; margin-top: 0.5rem;">※選ぶたびに当日の結果を表示。日付が変わると更新されます。</p>
    </section>

    <section id="result" aria-live="polite"></section>

    <section class="card" aria-labelledby="memberStatus">
      <div id="memberStatus" class="label">会員ステータス</div>
      <div class="row" style="justify-content:flex-start;">
        <span class="pill" id="statusPill" aria-live="polite">無料会員</span>
        <button id="toggleDemo" aria-pressed="false" aria-label="有料/無料のデモ切替">（デモ）有料/無料 切替</button>
      </div>
      <p class="muted">※本番ではキャリア決済完了後にサーバ側で有料フラグを付与してください。</p>
    </section>

    <footer>
      <div class="links">
        <a href="./list.html" class="pill">おまけページ</a>
        <a href="./novel.html" class="pill">小説ページ</a>
        <a href="./zodiac.html" class="pill">星座別診断表</a>
        <a href="./signup.html" class="pill accent">会員登録</a>
      </div>
      <div class="links">
        <a href="./terms.html" class="pill small">利用規約</a>
        <a href="./law.html" class="pill small">特定商取引</a>
        <a href="./privacy.html" class="pill small">個人情報保護方針</a>
        <a href="./devices.html" class="pill small">対応機種</a>
      </div>
      <div style="margin-top:0.5rem;">© 運命の銀竜暦</div>
    </footer>
  </div>

<script>
  // ===== 設定 =====
  const JSON_PATH = "./fortune_messages.json";
  let isPremium = false; // 本番はサーバ判定

  // ===== 日付キー（同日一意） =====
  const TODAY_KEY = () => {
    const d = new Date();
    return `${d.getFullYear()}-${d.getMonth()+1}-${d.getDate()}`;
  };
  const STORE_KEY = () => "fortune_locked_v2_" + TODAY_KEY(); // v2キーに更新（旧v1と分離）

  // ===== 乱数（安定シード） =====
  function hashStr(s){ let h=2166136261>>>0; for(let i=0;i<s.length;i++){ h^=s.charCodeAt(i); h=Math.imul(h,16777619);} return h>>>0; }
  function mulberry32(a){ return function(){ let t=a+=0x6D2B79F5; t=Math.imul(t^(t>>>15),t|1); t^=t+Math.imul(t^(t>>>7),t|61); return ((t^(t>>>14))>>>0)/4294967296; } }
  function pickByWeights(weights, seedStr){
    const rng = mulberry32(hashStr(seedStr));
    const entries = Object.entries(weights);
    const total = entries.reduce((s,[,w])=>s+Number(w),0);
    let r = rng() * total;
    for (const [star, w] of entries){ if (r < w) return Number(star); r -= w; }
    return 3;
  }
  function starText(n){ return "★★★★★☆☆☆☆☆".slice(5-n, 10-n); }

  // ===== データ読込 =====
  let META=null, MESSAGES=null, WEIGHTS=null, CATEGORIES=null, CHARACTERS=null, FREE_KEYS=new Set(["総合"]);
  fetch(JSON_PATH)
    .then(r => r.ok ? r.json() : Promise.reject("JSONが読み込めませんでした"))
    .then(json => {
      META = json.meta||{};
      WEIGHTS = json.weights||{"5":18,"4":32,"3":30,"2":15,"1":5};
      MESSAGES = json.messages||{};
      CATEGORIES = (json.categories||[
        {"key":"総合","paid":false},{"key":"健康","paid":true},{"key":"平穏","paid":true},{"key":"生活","paid":true},
        {"key":"対人","paid":true},{"key":"成長","paid":true},{"key":"目的","paid":true},{"key":"自由","paid":true},
        {"key":"娯楽","paid":true},{"key":"評価","paid":true}
      ]);
      CHARACTERS = (META.characters||["ルナル","アラン","リリア"]);
      if (Array.isArray(META.free_categories)) FREE_KEYS = new Set(META.free_categories);
      restoreOrInit();
    })
    .catch(err => { console.error(err); alert("占いデータの読み込みに失敗しました。fortune_messages.json を確認してください。"); });

  // ===== localStorage =====
  function getLocked(){
    const raw = localStorage.getItem(STORE_KEY());
    if (!raw) return null;
    try { return JSON.parse(raw); } catch { return null; }
  }
  function setLocked(payload){ localStorage.setItem(STORE_KEY(), JSON.stringify(payload)); }
  function clearOldKeys(){
    Object.keys(localStorage).forEach(k=>{
      if (k.startsWith("fortune_locked_") && k !== STORE_KEY()) localStorage.removeItem(k);
    });
  }

  // ===== ★生成（全カテゴリ一括） =====
  function generateTodayStars(){
    const day = TODAY_KEY();
    const stars = {};
    for (const {key} of CATEGORIES){
      stars[key] = pickByWeights(WEIGHTS, `${day}|v2|${key}`); // カテゴリごとに安定
    }
    return { day, stars, character: null };
  }

  // ===== UI要素 =====
  const resultEl = document.getElementById("result");
  const statusPill = document.getElementById("statusPill");
  const toggleDemo = document.getElementById("toggleDemo");
  toggleDemo?.addEventListener("click", ()=>{
    isPremium = !isPremium;
    toggleDemo.setAttribute("aria-pressed", String(isPremium));
    statusPill.textContent = isPremium ? "有料会員（デモ）" : "無料会員";
    const locked = getLocked();
    if (locked?.character) renderAll(locked.character, locked.stars);
  });

  // ===== メッセージ取得（不足時はフォールバック生成） =====
  function getMessage(category, stars, character){
    const cat = MESSAGES?.[category];
    const byStar = cat?.[String(stars)];
    const text = byStar?.[character];
    if (text) return text;

    // --- フォールバック（短文, 1〜2行） ---
    // カテゴリ別の語彙セット（世界観ワードなし・誰でもわかる言葉）
    const tone = {
      good: ["いい流れ。","手応えあり。","安心して進もう。"],
      fair: ["ほどよい日。","基本を丁寧に。","焦らず一歩。"],
      low:  ["無理は禁物。","守りを優先。","小さく整えよう。"]
    };
    const cuts = {
      "総合": {pos:"全体が噛み合う。", mid:"平常運。基礎を固めよう。", low:"今日は流れ待ち。休息も力。"},
      "健康": {pos:"体と心に余力あり。", mid:"水分と休憩を忘れずに。", low:"負荷を軽めに。"},
      "平穏": {pos:"不安は薄い。落ち着いて過ごせる。", mid:"小さな波はあるが問題なし。", low:"周囲の情報を絞って心を守ろう。"},
      "生活": {pos:"段取りが冴える。片付けと家計に吉。", mid:"やるべき事を淡々と。", low:"予定は詰めすぎない。"},
      "対人": {pos:"会話がスムーズ。相談も吉。", mid:"礼儀を大切に。", low:"距離感を意識して負担減。"},
      "成長": {pos:"学びが伸びる。少し難しいことに挑戦。", mid:"基礎固めの日。", low:"復習・メモ整理が効く。"},
      "目的": {pos:"進む方向がはっきりする。", mid:"目標を言語化して整えよう。", low:"今日は確認に留めてOK。"},
      "自由": {pos:"自分のペースで動ける。", mid:"空き時間をうまく使おう。", low:"無理な約束は避けて自分を守る。"},
      "娯楽": {pos:"小さな楽しみが満ちる。", mid:"短時間でも気分転換を。", low:"静かな趣味が心に合う。"},
      "評価": {pos:"周囲の目に届く日。", mid:"目立たず実直に。", low:"無理に背伸びせず誠実に。"}
    };
    const bucket = stars >= 4 ? "good" : (stars === 3 ? "fair" : "low");
    const lead = cuts[category]?.[stars >= 4 ? "pos" : stars === 3 ? "mid" : "low"] || "";
    const tail = tone[bucket][ hashStr(character+category+stars) % tone[bucket].length ];
    // キャラの言い回しを軽く差分（口調だけ柔らかく）
    const wrap = {
      "ルナル": (s) => `「${s}」`,
      "アラン": (s) => `「${s}」`,
      "リリア": (s) => `「${s}」`
    }[character] || ((s)=>`「${s}」`);
    return wrap(`${lead} ${tail}`);
  }

  // ===== 表示 =====
  function sectionCard(title, content){ return `<div class="card"><div class="label">${title}</div>${content}</div>`; }

  function renderAll(character, starsMap){
    // 1) ヘッダ（選択話者）
    let html = `
      <div class="card" aria-labelledby="selChar">
        <div id="selChar" class="label">選択した話し相手</div>
        <div class="big">${character}</div>
        <p class="muted" style="margin-top:.25rem;">※本日の運勢（★）は日替わりで一意です。話し手を変えても★は同じです。</p>
      </div>
    `;

    // 2) 総合（無料）
    const sOverall = starsMap["総合"];
    const mOverall = getMessage("総合", sOverall, character);
    html += sectionCard(
      "総合（無料）",
      `<div class="stars" aria-label="総合の評価">${starText(sOverall)}</div>
       <p class="msg">${mOverall}</p>`
    );

    // 3) そのほか9項目
    for (const {key, paid} of CATEGORIES){
      if (key === "総合") continue;
      const st = starsMap[key];
      const msg = getMessage(key, st, character);
      if (paid && !isPremium){
        html += sectionCard(`${key}（有料）`,
          `<p class="muted">会員登録で表示されます → <a class="pill" href="./signup.html" style="margin-left:.375rem;">会員登録</a></p>`
        );
      } else {
        html += sectionCard(`${key}${paid ? "（有料）" : "（無料）"}`,
          `<div class="stars" aria-label="${key}の評価">${starText(st)}</div>
           <p class="msg">${msg}</p>`
        );
      }
    }

    // 4) CTA
    html += (isPremium
      ? sectionCard("次はどこへ？",
          `<div class="row">
             <a class="pill" href="./list.html">おまけページ</a>
             <a class="pill" href="./novel.html">小説ページ</a>
             <a class="pill" href="./zodiac.html">星座別診断表</a>
           </div>`)
      : sectionCard("有料会員になると",
          `<ul style="margin:0.375rem 0 0 1rem; color:#cdd5ea; font-size:0.9375rem; line-height:1.6">
             <li>9項目（健康/平穏/生活/対人/成長/目的/自由/娯楽/評価）が開放</li>
             <li>広告なし・占い履歴の保存（拡張予定）</li>
           </ul>
           <div class="row" style="margin-top: 0.625rem;">
             <a class="pill accent" href="./signup.html">会員登録へ</a>
             <a class="pill" href="./zodiac.html">星座別診断表</a>
           </div>`)
    );

    resultEl.innerHTML = html;
  }

  // ===== 初期化 & ロック =====
  function restoreOrInit(){
    clearOldKeys();
    const locked = getLocked();
    if (locked && locked.day === TODAY_KEY()){
      if (locked.character) renderAll(locked.character, locked.stars);
    }
  }

  function confirmAndLock(firstCharacter){
    const locked = getLocked();
    if (locked && locked.day === TODAY_KEY()){
      const chosen = firstCharacter || locked.character;
      setLocked({ ...locked, character: chosen });
      renderAll(chosen, locked.stars);
      return;
    }
    const ok = window.confirm("本日の運勢（全10カテゴリ）を確定します。本日中は★が固定されます。よろしいですか？");
    if (!ok) return;
    const payload = generateTodayStars();
    payload.character = firstCharacter;
    setLocked(payload);
    renderAll(firstCharacter, payload.stars);
  }

  // ===== 既存のキャラ選択ボタンに接続 =====
  document.getElementById("charButtons").addEventListener("click", (e)=>{
    const btn = e.target.closest("button[data-char]");
    if (!btn) return;
    const char = btn.dataset.char;
    const locked = getLocked();
    if (!locked || locked.day !== TODAY_KEY()){
      confirmAndLock(char);  // 初回確定（10カテゴリまとめて★確定）
    } else {
      setLocked({ ...locked, character: char });
      renderAll(char, locked.stars);
    }
  });
</script>

</body>
</html>

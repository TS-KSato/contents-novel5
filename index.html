<!doctype html>
<html lang="ja">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1, viewport-fit=cover" />
  <title>運命の銀竜暦｜占いトップ</title>
  <meta name="description" content="運命の銀竜暦の占いトップ。無料は全体運のみ。有料で行動運・精神運が開放。小説ページやおまけページにもアクセス。">
  <style>
    html { font-size: 16px; }
    :root{
      --bg:#0b0d12; --ink:#ffffff; --muted:#aeb7d0; --line:#27304a; --card:#151826;
      --accent:#9fd3ff; --accent-2:#1a3358; --accent-2-b:#34507c;
      --radius: 0.875rem; --pad: 1rem; --gap: 0.75rem; --tap: 2.75rem;
    }
    * { box-sizing: border-box; }
    body{
      margin:0; background:var(--bg); color:var(--ink);
      font-family: system-ui, -apple-system, "Segoe UI", Roboto, "Hiragino Sans", "Noto Sans JP", sans-serif;
      line-height: 1.7; font-size: 1rem; -webkit-text-size-adjust: 100%;
      text-rendering: optimizeLegibility;
    }
    .wrap{ max-width: 35rem; margin: 0 auto; padding: 1.25rem; }

    h1{
      margin: 0 0 1rem;
      font-weight: 700;
      font-size: clamp(1.25rem, 5.5vw, 1.5rem);
      line-height: 1.2;
      text-align: center;
    }

    .card{
      background: var(--card);
      border: 1px solid var(--line);
      border-radius: var(--radius);
      padding: var(--pad);
      margin: 0.75rem 0;
    }

    .row{ display:flex; gap: 0.75rem; flex-wrap: wrap; justify-content: center; }

    button.char-btn{
      appearance: none; background: none; border: none; cursor: pointer; text-align: center;
      min-height: var(--tap); min-width: var(--tap); padding: 0.25rem; border-radius: 0.5rem;
    }
    button.char-btn:focus-visible{ outline: 2px solid var(--accent); outline-offset: 2px; }
    button.char-btn img{
      width: 5.625rem; height: 5.625rem; border-radius: 50%; border: 0.125rem solid var(--line); object-fit: cover;
    }
    button.char-btn div{ margin-top: 0.375rem; font-size: 0.875rem; }

    .muted{ color: var(--muted); font-size: 0.875rem; }
    .label{ font-size: 0.9375rem; color: #cfe1ff; margin-bottom: 0.5rem; }
    .big{ font-size: clamp(1.25rem, 5vw, 1.75rem); line-height: 1.2; }
    .msg{ margin-top: 0.375rem; color:#cdd5ea; font-size: 1rem; }
    .stars{ letter-spacing: 0.125rem; font-size: 1.125rem; }
    .gate{ opacity: .7; }

    .pill{
      display: inline-flex; align-items: center; justify-content: center;
      color: var(--accent); text-decoration: none; border: 1px solid var(--line); background: #11172a;
      padding: 0.375rem 0.625rem; border-radius: 999px; font-size: 0.8125rem; min-height: var(--tap);
    }
    .pill:hover{ background:#18213a; }
    .pill.accent{ background: var(--accent-2); border-color: var(--accent-2-b); color:#fff; }
    .pill.small{ min-height: 2rem; font-size: 0.75rem; }

    footer{ margin: 1rem 0 0.5rem; color: var(--muted); font-size: 0.75rem; text-align: center; }
    footer .links{ display:flex; gap: 0.75rem; flex-wrap: wrap; justify-content: center; margin-bottom: 0.5rem; }

    button{
      font-size: 1em; min-height: var(--tap); padding: 0.625rem 0.875rem;
      border-radius: 0.625rem; border: 1px solid #2f3b63; background: #1a2034; color: #fff; cursor: pointer;
    }
    button:hover{ background:#232b45; }
    button:focus-visible{ outline: 2px solid var(--accent); outline-offset: 2px; }
  </style>
</head>
<body>
  <div class="wrap">
    <header style="text-align:center; padding: 1.25rem 0.625rem;">
      <img src="./assets/logo.png" alt="運命の銀竜暦" style="max-width: 13.75rem; height:auto; margin-bottom: 0.5rem;" />
      <p class="muted" style="margin:0;">銀竜の言葉を継ぐ継承者の物語</p>
    </header>

    <section class="card" aria-labelledby="chooseCharacter">
      <div id="chooseCharacter" class="label" style="text-align:center;">今日は誰と話す？</div>
      <div class="row" id="charButtons">
        <button data-char="ルナル" class="char-btn" aria-label="ルナルと話す">
          <img src="./assets/char-lunal.png" alt="ルナルのアイコン"><div>ルナル</div>
        </button>
        <button data-char="アラン" class="char-btn" aria-label="アランと話す">
          <img src="./assets/char-alan.png" alt="アランのアイコン"><div>アラン</div>
        </button>
        <button data-char="リリア" class="char-btn" aria-label="リリアと話す">
          <img src="./assets/char-lilia.png" alt="リリアのアイコン"><div>リリア</div>
        </button>
      </div>
      <p class="muted" style="text-align:center; margin-top: 0.5rem;">※選ぶたびに当日の結果を表示。日付が変わると更新されます。</p>
    </section>

    <section id="result" aria-live="polite"></section>

    <section class="card" aria-labelledby="memberStatus">
      <div id="memberStatus" class="label">会員ステータス</div>
      <div class="row" style="justify-content:flex-start;">
        <span class="pill" id="statusPill" aria-live="polite">無料会員</span>
        <button id="toggleDemo" aria-pressed="false" aria-label="有料/無料のデモ切替">（デモ）有料/無料 切替</button>
      </div>
      <p class="muted">※本番ではキャリア決済完了後にサーバ側で有料フラグを付与してください。</p>
    </section>

    <footer>
      <div class="links">
        <a href="./list.html" class="pill">おまけページ</a>
        <a href="./novel.html" class="pill">小説ページ</a>
        <a href="./zodiac.html" class="pill">星座別診断表</a>
        <a href="./partner.html" class="pill">今日のパートナー</a>
        <a href="./signup.html" class="pill accent">会員登録</a>
      </div>
      <div class="links">
        <a href="./terms.html" class="pill small">利用規約</a>
        <a href="./law.html" class="pill small">特定商取引</a>
        <a href="./privacy.html" class="pill small">個人情報保護方針</a>
        <a href="./devices.html" class="pill small">対応機種</a>
      </div>
      <div style="margin-top:0.5rem;">© 運命の銀竜暦</div>
    </footer>
  </div>

<script>
  // ===== フォールバック（fetch失敗時に使う最小データ） =====
  const FALLBACK_JSON = {
    meta: { version: 2, characters: ["ルナル","アラン","リリア"], free_categories: ["総合"] },
    weights: { "5": 18, "4": 32, "3": 30, "2": 15, "1": 5 },
    categories: [
      {"key":"総合","paid":false},{"key":"健康","paid":true},{"key":"平穏","paid":true},{"key":"生活","paid":true},
      {"key":"対人","paid":true},{"key":"成長","paid":true},{"key":"目的","paid":true},{"key":"自由","paid":true},
      {"key":"娯楽","paid":true},{"key":"評価","paid":true}
    ],
    messages: {
      "総合": {
        "5": { "ルナル": "今日は追い風だ。遠慮なく行こう。", "アラン": "思った以上に進む日。素直に踏み出そう。", "リリア": "光があなたを包む日。小さな奇跡を拾って。" },
        "4": { "ルナル": "整っている。いつもより一歩深く。", "アラン": "流れは良好。段取りを意識すると吉。", "リリア": "澄んだ空気。迷ったら軽い方を。" },
        "3": { "ルナル": "平常運。足場を固めておけ。", "アラン": "可もなく不可もなく。基本を丁寧に。", "リリア": "静かな日。無理せず整えて。" },
        "2": { "ルナル": "焦りは不要。今日は守りを優先。", "アラン": "無理は禁物。小目標で十分。", "リリア": "休む勇気を。心に余白を。" },
        "1": { "ルナル": "退くも勇。明日に力を残せ。", "アラン": "今日は小休止。最低限でOK。", "リリア": "やさしく過ごして。自分を責めないで。" }
      }
    }
  };

  const JSON_PATH = "./fortune_messages.json";
  let isPremium = false;

  const TODAY_KEY = () => {
    const d = new Date();
    return `${d.getFullYear()}-${d.getMonth()+1}-${d.getDate()}`;
  };
  const STORE_KEY = () => "fortune_locked_v2_" + TODAY_KEY();

  function hashStr(s){ let h=2166136261>>>0; for(let i=0;i<s.length;i++){ h^=s.charCodeAt(i); h=Math.imul(h,16777619);} return h>>>0; }
  function mulberry32(a){ return function(){ let t=a+=0x6D2B79F5; t=Math.imul(t^(t>>>15),t|1); t^=t+Math.imul(t^(t>>>7),t|61); return ((t^(t>>>14))>>>0)/4294967296; } }
  function pickByWeights(weights, seedStr){
    const rng = mulberry32(hashStr(seedStr));
    const entries = Object.entries(weights);
    const total = entries.reduce((s,[,w])=>s+Number(w),0);
    let r = rng() * total;
    for (const [star, w] of entries){ if (r < w) return Number(star); r -= w; }
    return 3;
  }
  function starText(n){ return "★★★★★☆☆☆☆☆".slice(5-n, 10-n); }

  let META=null, MESSAGES=null, WEIGHTS=null, CATEGORIES=null, CHARACTERS=null, FREE_KEYS=new Set(["総合"]);
  function initWithJson(json){
    META = json.meta||{};
    WEIGHTS = json.weights||{"5":18,"4":32,"3":30,"2":15,"1":5};
    MESSAGES = json.messages||{};
    CATEGORIES = json.categories||[];
    CHARACTERS = META.characters||["ルナル","アラン","リリア"];
    if (Array.isArray(META.free_categories)) FREE_KEYS = new Set(META.free_categories);
    restoreOrInit();
  }

  fetch(JSON_PATH)
    .then(r => r.ok ? r.json() : Promise.reject("fetch not ok"))
    .then(initWithJson)
    .catch(err => {
      console.warn("fortune_messages.json 読込失敗。フォールバックで続行します。", err);
      initWithJson(FALLBACK_JSON);
    });

  // （以下は結果描画やイベント処理部分、元コードと同じ）
</script>
</body>
</html>

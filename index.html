<!doctype html>
<html lang="ja">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>運命の銀竜暦｜占いトップ</title>
  <meta name="description" content="運命の銀竜暦の占いトップ。無料は全体運のみ。有料で行動運・精神運が開放。小説ページやおまけページにもアクセス。">
  <style>
    body{font-family:system-ui,-apple-system,"Segoe UI",Roboto,"Hiragino Sans","Noto Sans JP",sans-serif;margin:0;background:#0b0d12;color:#fff}
    .wrap{max-width:560px;margin:0 auto;padding:20px}
    h1{font-size:20px;font-weight:700;margin:8px 0 16px}
    .card{background:#151826;border:1px solid #27304a;border-radius:14px;padding:16px;margin:12px 0}
    .row{display:flex;gap:8px;flex-wrap:wrap}
    button{appearance:none;border:1px solid #2f3b63;background:#1a2034;color:#fff;padding:10px 14px;border-radius:10px;cursor:pointer}
    button:hover{background:#232b45}
    .muted{color:#aeb7d0;font-size:12px}
    .stars{letter-spacing:2px;font-size:18px}
    .pill{color:#9fd3ff;text-decoration:none;border:1px solid #27304a;padding:6px 10px;border-radius:999px;background:#11172a;font-size:13px}
    .pill:hover{background:#18213a}
    .pill.accent{background:#1a3358;border-color:#34507c}
    .pill.ghost{opacity:.8}
    .big{font-size:28px}
    .msg{margin-top:6px;color:#cdd5ea}
    .gate{opacity:.7}
    footer{margin:16px 0 8px;color:#aeb7d0;font-size:12px}
  </style>
</head>
<body>
  <div class="wrap">
    <h1>運命の銀竜暦</h1>

    <!-- 基本導線 -->
    <nav class="nav-basic" style="margin:8px 0 12px; display:flex; flex-wrap:wrap; gap:8px">
      <a href="./list.html" class="pill">おまけページ</a>
      <a href="./novel.html" class="pill">小説ページ</a>
      <a href="./signup.html" class="pill accent">会員登録</a>
      <a href="./terms.html" class="pill ghost">利用規約</a>
      <a href="./law.html" class="pill ghost">特定商取引</a>
      <a href="./privacy.html" class="pill ghost">個人情報保護方針</a>
      <a href="./devices.html" class="pill ghost">対応機種</a>
    </nav>

    <!-- キャラ選択 -->
    <div class="card">
      <div class="label">今日は誰と話す？</div>
      <div class="row" id="charButtons">
        <button data-char="ルナル">ルナル（銀竜）</button>
        <button data-char="アラン">アラン（人間）</button>
        <button data-char="リリア">リリア（妖精）</button>
      </div>
      <div class="muted">※選ぶたびに当日の結果を表示。日付が変わると更新されます。</div>
    </div>

    <div id="result" class="grid"></div>

    <div class="card">
      <div class="label">会員ステータス</div>
      <div>
        <span class="pill" id="statusPill">無料会員</span>
        <button id="toggleDemo">（デモ）有料/無料 切替</button>
      </div>
      <div class="muted">※本番ではキャリア決済完了後にサーバ側で有料フラグを付与してください。</div>
    </div>

    <!-- フッター -->
    <footer>
      <div style="display:flex;gap:12px;flex-wrap:wrap">
        <a href="./terms.html" class="pill" style="font-size:12px">利用規約</a>
        <a href="./law.html" class="pill" style="font-size:12px">特定商取引</a>
        <a href="./privacy.html" class="pill" style="font-size:12px">個人情報保護方針</a>
        <a href="./devices.html" class="pill" style="font-size:12px">対応機種</a>
      </div>
      <div style="margin-top:8px">© 運命の銀竜暦</div>
    </footer>
  </div>

  <script>
    const CSV_PATH = "./fortune_messages.csv";
    const STAR_WEIGHTS = {5:15, 4:30, 3:35, 2:15, 1:5};
    let isPremium = false;

    // 簡易CSVパーサ
    function parseCSV(text){
      const rows = [];
      let cur = [], val = "", inQ = false;
      for (let i=0;i<text.length;i++){
        const c = text[i], n = text[i+1];
        if (inQ){
          if (c === '"' && n === '"'){ val += '"'; i++; }
          else if (c === '"'){ inQ = false; }
          else { val += c; }
        } else {
          if (c === '"'){ inQ = true; }
          else if (c === ','){ cur.push(val); val=""; }
          else if (c === '\n'){ cur.push(val); rows.push(cur); cur=[]; val=""; }
          else if (c === '\r'){ }
          else { val += c; }
        }
      }
      if (val.length || cur.length) { cur.push(val); rows.push(cur); }
      const header = rows.shift();
      return rows.map(r => Object.fromEntries(header.map((h,idx)=>[h, r[idx] ?? ""])));
    }

    function hashStr(s){
      let h = 2166136261>>>0;
      for (let i=0;i<s.length;i++){ h ^= s.charCodeAt(i); h = Math.imul(h,16777619); }
      return h>>>0;
    }
    function mulberry32(a){
      return function(){
        let t = a += 0x6D2B79F5;
        t = Math.imul(t ^ (t >>> 15), t | 1);
        t ^= t + Math.imul(t ^ (t >>> 7), t | 61);
        return ((t ^ (t >>> 14)) >>> 0) / 4294967296;
      }
    }
    function pickStarsDeterministic(character){
      const today = new Date();
      const key = `${today.getFullYear()}-${today.getMonth()+1}-${today.getDate()}|${character}`;
      const rng = mulberry32(hashStr(key));
      const entries = Object.entries(STAR_WEIGHTS);
      const total = entries.reduce((s,[,w])=>s+Number(w),0);
      let r = rng() * total;
      for (const [stars, weight] of entries){
        if (r < weight) return Number(stars);
        r -= weight;
      }
      return 3;
    }

    let records = [];
    fetch(CSV_PATH)
      .then(r => r.ok ? r.text() : Promise.reject("CSVが読み込めませんでした"))
      .then(text => { records = parseCSV(text); })
      .catch(err => {
        console.error(err);
        alert("占いデータの読み込みに失敗しました。CSVの配置を確認してください。");
      });

    const resultEl = document.getElementById("result");
    const statusPill = document.getElementById("statusPill");
    const toggleDemo = document.getElementById("toggleDemo");
    toggleDemo.addEventListener("click", ()=>{ isPremium = !isPremium; statusPill.textContent = isPremium ? "有料会員（デモ）" : "無料会員"; if (lastChar) showFor(lastChar); });

    function starText(n){
      return "★★★★★☆☆☆☆☆".slice(5-n, 10-n);
    }
    function findMessage(category, stars, character){
      return records.find(r => r.category===category && Number(r.stars)===Number(stars) && r.character===character)?.message || "";
    }

    function ctaBlock(isPremium){
      if (isPremium) return `
        <div class="card">
          <div class="label">次はどこへ？</div>
          <div class="row">
            <a class="pill" href="./list.html">おまけページ</a>
            <a class="pill" href="./novel.html">小説ページ</a>
          </div>
        </div>`;
      return `
        <div class="card">
          <div class="label">有料会員になると</div>
          <ul style="margin:6px 0 0 18px; color:#cdd5ea; font-size:13px; line-height:1.6">
            <li>行動運・精神運の★評価が毎日開放</li>
            <li>広告なし・占い履歴の保存</li>
            <li>名言アーカイブや世界観資料にフルアクセス</li>
          </ul>
          <div style="margin-top:10px" class="row">
            <a class="pill accent" href="./signup.html">会員登録へ</a>
            <a class="pill" href="./list.html">おまけページ</a>
            <a class="pill" href="./novel.html">小説ページ</a>
          </div>
        </div>`;
    }

    let lastChar = null;
    function showFor(character){
      lastChar = character;
      if (!records.length){ resultEl.innerHTML = `<div class="card">データ読込中...</div>`; return; }

      const starsOverall = pickStarsDeterministic(character);
      const starsAction  = pickStarsDeterministic(character + "|act");
      const starsMind    = pickStarsDeterministic(character + "|mind");

      const msgOverall = findMessage("全体運", starsOverall, character);
      const msgAction  = findMessage("行動運", starsAction,  character);
      const msgMind    = findMessage("精神運", starsMind,    character);

      resultEl.innerHTML = `
        <div class="card">
          <div class="label">選択したキャラクター</div>
          <div class="big">${character}</div>
        </div>

        <div class="card">
          <div class="label">全体運（無料）</div>
          <div class="stars">${starText(starsOverall)}</div>
          <div class="msg">「${msgOverall}」</div>
          <div class="muted" style="margin-top:6px">※詳細は有料会員で開放されます</div>
        </div>

        <div class="card ${isPremium ? "" : "gate"}">
          <div class="label">行動運（有料）</div>
          ${isPremium ? `
            <div class="stars">${starText(starsAction)}</div>
            <div class="msg">「${msgAction}」</div>
          ` : `
            <div class="muted">会員登録で表示されます → <a href="./signup.html" class="pill" style="margin-left:6px">会員登録</a></div>
          `}
        </div>

        <div class="card ${isPremium ? "" : "gate"}">
          <div class="label">精神運（有料）</div>
          ${isPremium ? `
            <div class="stars">${starText(starsMind)}</div>
            <div class="msg">「${msgMind}」</div>
          ` : `
            <div class="muted">会員登録で表示されます → <a href="./signup.html" class="pill" style="margin-left:6px">会員登録</a></div>
          `}
        </div>

        ${ctaBlock(isPremium)}
      `;
    }

    document.getElementById("charButtons").addEventListener("click", (e)=>{
      const btn = e.target.closest("button[data-char]");
      if (!btn) return;
      showFor(btn.dataset.char);
    });
  </script>
</body>
</html>

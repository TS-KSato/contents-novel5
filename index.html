<!doctype html>
<html lang="ja">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>運命の銀竜暦｜占いトップ</title>
  <meta name="description" content="運命の銀竜暦の占いトップ。無料は全体運のみ。有料で行動運・精神運が開放。小説ページやおまけページにもアクセス。">
  <style>
    body{font-family:system-ui,-apple-system,"Segoe UI",Roboto,"Hiragino Sans","Noto Sans JP",sans-serif;margin:0;background:#0b0d12;color:#fff}
    .wrap{max-width:560px;margin:0 auto;padding:20px}
    .card{background:#151826;border:1px solid #27304a;border-radius:14px;padding:16px;margin:12px 0}
    .row{display:flex;gap:12px;flex-wrap:wrap;justify-content:center}
    button.char-btn{background:none;border:none;cursor:pointer;text-align:center}
    button.char-btn img{width:90px;height:90px;border-radius:50%;border:2px solid #27304a}
    button.char-btn div{margin-top:6px;color:#fff;font-size:14px}
    .muted{color:#aeb7d0;font-size:12px}
    .stars{letter-spacing:2px;font-size:18px}
    .pill{color:#9fd3ff;text-decoration:none;border:1px solid #27304a;padding:6px 10px;border-radius:999px;background:#11172a;font-size:13px}
    .pill:hover{background:#18213a}
    .pill.accent{background:#1a3358;border-color:#34507c}
    .big{font-size:28px}
    .msg{margin-top:6px;color:#cdd5ea}
    .gate{opacity:.7}
    footer{margin:16px 0 8px;color:#aeb7d0;font-size:12px;text-align:center}
    footer .links{display:flex;gap:12px;flex-wrap:wrap;justify-content:center;margin-bottom:6px}
  </style>
</head>
<body>
  <div class="wrap">
    <!-- ヘッダー（上部はシンプルに画像で演出） -->
    <header style="text-align:center; padding:20px 10px">
      <img src="./assets/logo.png" alt="運命の銀竜暦" style="max-width:220px; height:auto; margin-bottom:8px">
      <p style="font-size:14px; color:#aeb7d0; margin:0">銀竜の言葉を継ぐ継承者の物語</p>
    </header>

    <!-- キャラ選択（画像ボタン） -->
    <div class="card">
      <div class="label" style="text-align:center;margin-bottom:8px">今日は誰と話す？</div>
      <div class="row" id="charButtons">
        <button data-char="ルナル" class="char-btn">
          <img src="./assets/char-lunal.png" alt="ルナル"><div>ルナル</div>
        </button>
        <button data-char="アラン" class="char-btn">
          <img src="./assets/char-alan.png" alt="アラン"><div>アラン</div>
        </button>
        <button data-char="リリア" class="char-btn">
          <img src="./assets/char-lilia.png" alt="リリア"><div>リリア</div>
        </button>
      </div>
      <div class="muted" style="text-align:center;margin-top:8px">※選ぶたびに当日の結果を表示。日付が変わると更新されます。</div>
    </div>

    <!-- 占い結果 -->
    <div id="result"></div>

    <!-- 会員ステータス（デモ切替） -->
    <div class="card">
      <div class="label">会員ステータス</div>
      <div>
        <span class="pill" id="statusPill">無料会員</span>
        <button id="toggleDemo">（デモ）有料/無料 切替</button>
      </div>
      <div class="muted">※本番ではキャリア決済完了後にサーバ側で有料フラグを付与してください。</div>
    </div>

    <!-- フッター（導線と法務） -->
    <footer>
      <div class="links">
        <a href="./list.html" class="pill">おまけページ</a>
        <a href="./novel.html" class="pill">小説ページ</a>
        <a href="./signup.html" class="pill accent">会員登録</a>
      </div>
      <div class="links">
        <a href="./terms.html" class="pill" style="font-size:12px">利用規約</a>
        <a href="./law.html" class="pill" style="font-size:12px">特定商取引</a>
        <a href="./privacy.html" class="pill" style="font-size:12px">個人情報保護方針</a>
        <a href="./devices.html" class="pill" style="font-size:12px">対応機種</a>
      </div>
      <div style="margin-top:8px">© 運命の銀竜暦</div>
    </footer>
  </div>

  <script>
    // ===== 設定 =====
    const JSON_PATH = "./fortune_messages.json";
    let isPremium = false; // 本番はサーバ側で判定して埋め込む

    // ===== starの確率（JSONのweightsに従う）+ 日付固定乱数 =====
    function hashStr(s){ let h=2166136261>>>0; for(let i=0;i<s.length;i++){ h^=s.charCodeAt(i); h=Math.imul(h,16777619);} return h>>>0; }
    function mulberry32(a){ return function(){ let t=a+=0x6D2B79F5; t=Math.imul(t^(t>>>15),t|1); t^=t+Math.imul(t^(t>>>7),t|61); return ((t^(t>>>14))>>>0)/4294967296; } }
    function pickStarsDeterministic(character, weights){
      const d = new Date();
      const key = `${d.getFullYear()}-${d.getMonth()+1}-${d.getDate()}|${character}`;
      const rng = mulberry32(hashStr(key));
      const entries = Object.entries(weights); // [["5",15],...]
      const total = entries.reduce((s,[,w])=>s+Number(w),0);
      let r = rng() * total;
      for(const [star, w] of entries){ if(r < w) return Number(star); r -= w; }
      return 3;
    }

    // ===== データ読込 =====
    let MESSAGES = null;
    let WEIGHTS = null;

    fetch(JSON_PATH)
      .then(r => r.ok ? r.json() : Promise.reject("JSONが読み込めませんでした"))
      .then(json => {
        MESSAGES = json.messages;
        WEIGHTS = json.weights;
      })
      .catch(err => {
        console.error(err);
        alert("占いデータの読み込みに失敗しました。fortune_messages.json の配置を確認してください。");
      });

    // ===== 便利関数 =====
    const resultEl = document.getElementById("result");
    const statusPill = document.getElementById("statusPill");
    const toggleDemo = document.getElementById("toggleDemo");
    toggleDemo.addEventListener("click", ()=>{ isPremium = !isPremium; statusPill.textContent = isPremium ? "有料会員（デモ）" : "無料会員"; if (lastChar) showFor(lastChar); });

    function starText(n){ return "★★★★★☆☆☆☆☆".slice(5-n, 10-n); }
    function getMessage(category, stars, character){
      const cat = MESSAGES?.[category]; if(!cat) return "";
      const byStar = cat[String(stars)]; if(!byStar) return "";
      return byStar?.[character] || "";
    }
    function ctaBlock(isPremium){
      if (isPremium) return `
        <div class="card">
          <div class="label">次はどこへ？</div>
          <div class="row">
            <a class="pill" href="./list.html">おまけページ</a>
            <a class="pill" href="./novel.html">小説ページ</a>
          </div>
        </div>`;
      return `
        <div class="card">
          <div class="label">有料会員になると</div>
          <ul style="margin:6px 0 0 18px; color:#cdd5ea; font-size:13px; line-height:1.6">
            <li>行動運・精神運の★評価が毎日開放</li>
            <li>広告なし・占い履歴の保存</li>
            <li>名言アーカイブや世界観資料にフルアクセス</li>
          </ul>
          <div style="margin-top:10px" class="row">
            <a class="pill accent" href="./signup.html">会員登録へ</a>
            <a class="pill" href="./list.html">おまけページ</a>
            <a class="pill" href="./novel.html">小説ページ</a>
          </div>
        </div>`;
    }

    // ===== 表示 =====
    let lastChar = null;
    function showFor(character){
      lastChar = character;
      if (!MESSAGES || !WEIGHTS){ resultEl.innerHTML = `<div class="card">データ読込中...</div>`; return; }

      const sOverall = pickStarsDeterministic(character, WEIGHTS);
      const sAction  = pickStarsDeterministic(character + "|act", WEIGHTS);
      const sMind    = pickStarsDeterministic(character + "|mind", WEIGHTS);

      const mOverall = getMessage("全体運", sOverall, character);
      const mAction  = getMessage("行動運", sAction,  character);
      const mMind    = getMessage("精神運", sMind,    character);

      resultEl.innerHTML = `
        <div class="card">
          <div class="label">選択したキャラクター</div>
          <div class="big">${character}</div>
        </div>

        <div class="card">
          <div class="label">全体運（無料）</div>
          <div class="stars">${starText(sOverall)}</div>
          <div class="msg">「${mOverall}」</div>
          <div class="muted" style="margin-top:6px">※詳細は有料会員で開放されます</div>
        </div>

        <div class="card ${isPremium ? "" : "gate"}">
          <div class="label">行動運（有料）</div>
          ${isPremium ? `
            <div class="stars">${starText(sAction)}</div>
            <div class="msg">「${mAction}」</div>
          ` : `
            <div class="muted">会員登録で表示されます → <a href="./signup.html" class="pill" style="margin-left:6px">会員登録</a></div>
          `}
        </div>

        <div class="card ${isPremium ? "" : "gate"}">
          <div class="label">精神運（有料）</div>
          ${isPremium ? `
            <div class="stars">${starText(sMind)}</div>
            <div class="msg">「${mMind}」</div>
          ` : `
            <div class="muted">会員登録で表示されます → <a href="./signup.html" class="pill" style="margin-left:6px">会員登録</a></div>
          `}
        </div>

        ${ctaBlock(isPremium)}
      `;
    }

    // キャラ選択
    document.getElementById("charButtons").addEventListener("click", (e)=>{
      const btn = e.target.closest("button[data-char]");
      if (!btn) return;
      showFor(btn.dataset.char);
    });
  </script>
</body>
</html>

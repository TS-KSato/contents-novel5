<!doctype html>
<html lang="ja">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1, viewport-fit=cover" />
  <title>運命の銀竜暦｜竜の食卓</title>
  <meta name="description" content="エテルナリアの人々が口にする素朴な料理を、人間界の食材で再現した記録。今日の一品とキャラクター別の食卓。">
  <style>
    html { font-size: 16px; }
    :root{
      --bg:#0b0d12; --ink:#ffffff; --muted:#aeb7d0; --line:#27304a; --card:#151826;
      --accent:#9fd3ff; --accent-2:#1a3358; --accent-2-b:#34507c;
      --radius:.875rem; --pad:1rem; --gap:.75rem; --tap:2.75rem;
    }
    *{ box-sizing:border-box }
    body{
      margin:0; background:var(--bg); color:var(--ink);
      font-family:system-ui,-apple-system,"Segoe UI",Roboto,"Hiragino Sans","Noto Sans JP",sans-serif;
      line-height:1.8; font-size:1rem; -webkit-text-size-adjust:100%;
      text-rendering: optimizeLegibility;
      padding-bottom:4.5rem; /* 下部ナビ分の余白 */
    }
    .wrap{ max-width:40rem; margin:0 auto; padding:1.0rem 1.0rem 0; }

    header{ text-align:center; padding:.5rem .25rem .5rem; }
    header h1{ margin:.25rem 0 .25rem; font-size:clamp(1.15rem,5vw,1.5rem); font-weight:700; }
    header .muted{ color:var(--muted); font-size:.875rem; margin:0; }

    .card{ background:var(--card); border:1px solid var(--line); border-radius:var(--radius); padding:var(--pad); margin:.75rem 0; }
    .label{ font-size:.9375rem; color:#cfe1ff; margin-bottom:.5rem }
    .title{ font-size:1.125rem; font-weight:700; line-height:1.4; margin:.25rem 0 .25rem; }
    .meta{ color:var(--muted); font-size:.8125rem; }
    .lead{ color:#e8eeff; font-size:1rem; margin:.25rem 0 .5rem; }
    .body{ color:#e0e6ff; font-size:1rem; }
    .sep{ height:1px; background:var(--line); margin:.75rem 0; }

    .article-head{
      display:grid; grid-template-columns:auto 1fr; gap:.75rem; align-items:center; margin-bottom:.5rem;
    }
    .avatar{
      width:3.25rem; height:3.25rem; border-radius:50%; border:1px solid var(--line);
      background:#10172a center/cover no-repeat; display:flex; align-items:center; justify-content:center;
      font-weight:700; color:#cfe1ff; flex-shrink:0;
    }
    .avatar.fallback{ background:#10172a; }

    .list{ display:grid; gap:.75rem; }
    .item{
      display:grid; grid-template-columns:auto 1fr auto; gap:.75rem; align-items:center;
      background:#11172a; border:1px solid var(--line); border-radius:.75rem; padding:.5rem .625rem;
      text-decoration:none; color:inherit;
    }
    .item:hover{ background:#16203a }
    .item .name{ font-size:1rem; font-weight:700; }
    .item .sub{ font-size:.8125rem; color:var(--muted); }

    .pill{
      display:inline-flex; align-items:center; justify-content:center; color:#d7e6ff;
      background:#13203a; border:1px solid #2b3b61; border-radius:999px; padding:.25rem .5rem; font-size:.75rem;
      text-decoration:none;
    }

    /* 下部固定ナビ（コンパクト） */
    .bottom-nav{
      position:fixed; left:0; right:0; bottom:0; z-index:50;
      background:rgba(10,14,22,.9); backdrop-filter:blur(8px);
      border-top:1px solid var(--line);
    }
    .bn-grid{ max-width:40rem; margin:0 auto; display:grid; grid-template-columns:repeat(5,1fr); }
    .bn-btn{
      appearance:none; background:none; border:0; color:#cfe1ff; text-decoration:none;
      display:flex; flex-direction:column; align-items:center; justify-content:center;
      padding:.375rem 0; min-height:3.25rem; font-size:.75rem;
    }
    .bn-btn:focus-visible{ outline:2px solid var(--accent); outline-offset:-2px; }
    .bn-icon{
      width:20px; height:20px; margin-bottom:.125rem; border-radius:4px; border:1px solid var(--line); background:#16213c;
      display:flex; align-items:center; justify-content:center; font-size:.75rem;
    }
    .bn-accent{ color:#fff; }

    footer{ text-align:center; color:var(--muted); font-size:.75rem; margin:1rem 0 .75rem }
  </style>
</head>
<body>
  <div class="wrap">
    <header>
      <h1>竜の食卓</h1>
      <p class="muted">再現は易しく、物語は深く。エテルナリアの食卓から一皿。</p>
    </header>

    <!-- 今日の一品 -->
    <section class="card" aria-label="今日の一品">
      <div class="label">今日の一品</div>
      <div id="todayDish"></div>
      <p class="meta" style="margin-top:.5rem;">※ 日付にもとづいて毎日固定の一皿を表示します。</p>
    </section>

    <!-- キャラ別導線 -->
    <section class="card" aria-label="キャラクターの食卓">
      <div class="label">キャラクターの食卓</div>
      <div id="charLinks" class="list">
        <!-- JSでリンク生成（アラン／ドレイク／ライラ／ネスター） -->
      </div>
    </section>

    <footer>© 運命の銀竜暦</footer>
  </div>

  <!-- 下部固定ナビ -->
  <nav class="bottom-nav" aria-label="主要ナビゲーション">
    <div class="bn-grid">
      <a class="bn-btn" href="./index.html" aria-label="占いトップ">
        <span class="bn-icon">占</span><span>占い</span>
      </a>
      <a class="bn-btn" href="./list.html" aria-label="おまけページ">
        <span class="bn-icon">お</span><span>おまけ</span>
      </a>
      <a class="bn-btn" href="./serial.html" aria-label="七夜の語り巻">
        <span class="bn-icon">巻</span><span>語り巻</span>
      </a>
      <a class="bn-btn bn-accent" href="./food.html" aria-current="page" aria-label="竜の食卓">
        <span class="bn-icon">食</span><span>食卓</span>
      </a>
      <a class="bn-btn" href="./signup.html" aria-label="会員登録">
        <span class="bn-icon">会</span><span>会員</span>
      </a>
    </div>
  </nav>

<script>
const JSON_PATH = "./recipe.json";

/* ---------- ユーティリティ ---------- */
function esc(s){ return String(s||"").replace(/[&<>]/g, m=>({'&':'&amp;','<':'&lt;','>':'&gt;'}[m]); }
function todaySeed(){
  const d = new Date();
  // ユーザーの端末日付に基づき日替わり固定
  return `${d.getFullYear()}-${d.getMonth()+1}-${d.getDate()}`;
}
function hashStr(s){ let h=2166136261>>>0; for(let i=0;i<s.length;i++){ h^=s.charCodeAt(i); h=Math.imul(h,16777619);} return h>>>0; }
function mulberry32(a){ return function(){ let t=a+=0x6D2B79F5; t=Math.imul(t^(t>>>15),t|1); t^=t+Math.imul(t^(t>>>7),t|61); return ((t^(t>>>14))>>>0)/4294967296; } }
function pickOneDet(arr, seedStr){
  if(!arr.length) return null;
  const rng = mulberry32(hashStr(seedStr));
  const idx = Math.floor(rng()*arr.length);
  return arr[idx];
}

/* ---------- 「今日の一品」描画 ---------- */
const todayEl = document.getElementById("todayDish");

function renderToday(dish){
  if(!dish){
    todayEl.innerHTML = `<div class="meta">料理が見つかりませんでした。後ほど再度お試しください。</div>`;
    return;
  }
  const initials = (dish.character||"").slice(0,2) || "食";
  const avatar = dish.avatar ? `<div class="avatar" style="background-image:url('${esc(dish.avatar)}');" aria-hidden="true"></div>`
                             : `<div class="avatar fallback" aria-hidden="true">${esc(initials)}</div>`;

  todayEl.innerHTML = `
    <div class="article-head">
      ${avatar}
      <div>
        <div class="title">${esc(dish.title)}</div>
        <div class="meta">${esc(dish.real_name||"")}${dish.character?` / 語り手：${esc(dish.character)}`:""}</div>
      </div>
    </div>
    ${ dish.intro ? `<p class="lead">${esc(dish.intro)}</p>` : "" }
    <div class="sep"></div>
    <div class="body">
      <h3 style="margin:.25rem 0 .25rem; font-size:1rem;">材料</h3>
      <ul style="margin:.25rem 0 .5rem; padding-left:1.25rem;">
        ${(dish.ingredients||[]).map(i=>`<li>${esc(i)}</li>`).join("")}
      </ul>
      <h3 style="margin:.25rem 0 .25rem; font-size:1rem;">作り方</h3>
      <ol style="margin:.25rem 0 .5rem; padding-left:1.25rem;">
        ${(dish.steps||[]).map(s=>`<li>${esc(s)}</li>`).join("")}
      </ol>
    </div>
    ${ dish.comment ? `<div class="sep"></div><p class="meta">${esc(dish.comment)}</p>` : "" }
  `;
}

/* ---------- キャラ別導線 ---------- */
const charEl = document.getElementById("charLinks");
const CHAR_ORDER = ["アラン","ドレイク","ライラ","ネスター"];
const CHAR_LINK = {
  "アラン":"./food_alan.html",
  "ドレイク":"./food_drake.html",
  "ライラ":"./food_laila.html",
  "ネスター":"./food_nester.html"
};

function renderCharLinks(recipes){
  const byChar = {};
  recipes.forEach(r => {
    const c = r.character || "その他";
    (byChar[c] ||= []).push(r);
  });

  const itemsHtml = CHAR_ORDER.map(c=>{
    const arr = byChar[c]||[];
    const initials = c.slice(0,2);
    // 代表アバター（最初のアイテムのavatarがあれば採用）
    const av = (arr.find(x=>x.avatar)||{}).avatar || "";
    const avatar = av
      ? `<div class="avatar" style="width:2.5rem;height:2.5rem;background-image:url('${esc(av)}');" aria-hidden="true"></div>`
      : `<div class="avatar fallback" style="width:2.5rem;height:2.5rem;" aria-hidden="true">${esc(initials)}</div>`;

    // 先頭2件のタイトルをプレビュー
    const preview = arr.slice(0,2).map(x=>x.title).join("・");
    const link = CHAR_LINK[c] || "#";

    return `
      <a class="item" href="${esc(link)}" aria-label="${esc(c)}の食卓へ">
        ${avatar}
        <div>
          <div class="name">${esc(c)}の食卓</div>
          <div class="sub">${arr.length}品 / ${esc(preview || "準備中")}</div>
        </div>
        <span class="pill">見る →</span>
      </a>
    `;
  }).join("");

  charEl.innerHTML = itemsHtml;
}

/* ---------- 起動 ---------- */
(async function init(){
  try{
    const res = await fetch(JSON_PATH, {cache:"no-cache"});
    if(!res.ok) throw new Error("fetch failed");
    const data = await res.json();

    // 想定フォーマット：配列
    const recipes = Array.isArray(data) ? data : (Array.isArray(data.items) ? data.items : []);
    if(!recipes.length){ throw new Error("no recipes"); }

    // 今日の一品（同日固定シード）
    const dish = pickOneDet(recipes, "food|"+todaySeed());
    renderToday(dish);

    // キャラ別導線
    renderCharLinks(recipes);

  }catch(e){
    console.warn("recipe.json読み込み失敗:", e);
    todayEl.innerHTML = `<div class="meta">レシピの読み込みに失敗しました。<br>recipe.json をご確認ください。</div>`;
    charEl.innerHTML = `
      <div class="meta">キャラクター別の食卓は、データが読み込め次第表示します。</div>
    `;
  }
})();
</script>
</body>
</html>

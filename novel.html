<!doctype html>
<html lang="ja">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width, initial-scale=1, viewport-fit=cover" />
<title>運命の銀竜暦｜小説『銀竜の言葉を継ぐもの』</title>
<meta name="description" content="短編『銀竜の言葉を継ぐもの』。章セレクト・進捗・再開ボタン対応。">
<link href="https://fonts.googleapis.com/css2?family=Noto+Serif+JP:wght@400;700&display=swap" rel="stylesheet">
<style>

:root{
  --bg:#0b0d12; --ink:#ffffff; --muted:#aeb7d0; --line:#27304a; --card:#151826;
  --accent:#9fd3ff; --accent-2:#1a3358; --accent-2-b:#34507c;
  --radius:.875rem; --pad:1rem; --gap:.75rem; --tap:2.75rem;
}
*{box-sizing:border-box}
html,body{height:100%}
body{
  margin:0; color:var(--ink); background:var(--bg);
  font-family:system-ui,-apple-system,"Segoe UI",Roboto,"Helvetica Neue","Noto Sans JP","Hiragino Sans","Hiragino Kaku Gothic ProN","Yu Gothic UI","Meiryo",sans-serif;
  -webkit-text-size-adjust:100%; text-rendering:optimizeLegibility;
}
.wrap{max-width:40rem;margin:0 auto;padding:1rem;}
h1,h2,h3{margin:.25rem 0 .5rem}
h1{font-size:1.25rem}
h2{font-size:1.05rem;color:#d7e6ff}
p{margin:.5rem 0}
a{color:var(--accent)}
a:focus-visible, button:focus-visible, select:focus-visible{outline:2px solid var(--accent);outline-offset:2px;border-radius:.5rem}

/* Buttons (index-like) */
.btn{appearance:none;border:1px solid var(--accent-2-b);background:linear-gradient(180deg,#1b2a49,#0e1a33);color:#e7f2ff;border-radius:.8rem;padding:.6rem .9rem;min-height:var(--tap);font-size:1rem;cursor:pointer}
.btn:focus-visible{outline:2px solid var(--accent);outline-offset:2px}
.btn.ghost{background:#11172a;border-color:#2f3b63;color:#d7e6ff}

/* Pills */
.pills{display:flex;gap:.5rem;flex-wrap:wrap;margin-top:.5rem}
.pill{display:inline-flex;align-items:center;justify-content:center;background:#0e1a33;color:#d7e6ff;border:1px solid #2f3b63;border-radius:999px;padding:.25rem .6rem;font-size:.8rem}

/* Card */
.card{border:1px solid var(--line);background:var(--card);border-radius:calc(var(--radius) * 1.2);padding:var(--pad)}

/* A11y: visually hidden but accessible */
.visually-hidden{position:absolute!important;width:1px;height:1px;padding:0;margin:-1px;overflow:hidden;clip:rect(0,0,0,0);white-space:nowrap;border:0}

/* Endcap (next chapter prompt) */
.endcap{border:1px solid var(--line);background:linear-gradient(180deg,#121726 0%, #0e1322 100%);border-radius:calc(var(--radius) * 1.2);padding:var(--pad);margin-top:1rem}
.endcap h3{margin:.25rem 0 .5rem;font-size:1rem;color:#d7e6ff}
.endcap .preview{color:var(--muted);font-size:.95rem;margin:.25rem 0 .75rem}
.endcap .actions{display:flex;gap:.5rem;flex-wrap:wrap}
.endcap .actions .btn{flex:1 1 auto}
.endcap .actions .btn.ghost{flex:0 0 auto}

/* Tools */
.tools{display:flex;gap:.5rem;flex-wrap:wrap;align-items:center;justify-content:space-between;margin:.25rem 0 1rem}
select, .mini-btn{appearance:none;border:1px solid var(--line);background:#11172a;color:#d7e6ff;border-radius:.6rem;padding:.5rem .65rem;font-size:.95rem}
.mini-btn{cursor:pointer}

/* Top progress */
.progress-top{position:fixed;left:0;top:0;width:100%;height:3px;background:rgba(255,255,255,.08);z-index:50}
.progress-top .bar{height:100%;width:0;background:var(--accent)}

/* Resume button */
.resume-btn{position:fixed;right:.75rem;bottom:4.25rem;border:1px solid var(--accent-2-b);background:#0d1424;color:#e7f2ff;border-radius:.8rem;padding:.5rem .7rem;font-size:.9rem;z-index:40;display:none}

/* Bottom nav (copy from index) */
.bottom-nav{position:fixed;left:0;right:0;bottom:0;z-index:30;background:rgba(10,13,20,.9);backdrop-filter:blur(8px);border-top:1px solid var(--line)}
.bn-grid{max-width:40rem;margin:0 auto;display:grid;grid-template-columns:repeat(3,1fr)}
.bn-btn{appearance:none;background:none;border:0;color:#cfe1ff;text-decoration:none;display:flex;flex-direction:column;align-items:center;justify-content:center;padding:.375rem 0;min-height:3.25rem;font-size:.75rem}
.bn-icon{width:20px;height:20px;margin-bottom:.125rem;display:inline-flex;align-items:center;justify-content:center;font-size:.9rem}

</style>
</head>
<body>

<!-- Top progress bar -->
<div class="progress-top" aria-hidden="true"><div class="bar" id="progressBar"></div></div>

<div class="wrap">
  <header style="margin:.25rem 0 1rem">
    <h1 id="novelTitle">銀竜の言葉を継ぐもの</h1>
    <div class="pills" aria-hidden="true">
      <span class="pill">読了位置は自動で保存されます</span>
    </div>
  </header>

  <!-- Tools -->
  <div class="tools">
    <div>
      <label for="chapterSelector" class="visually-hidden">章の選択</label>
      <select id="chapterSelector" aria-label="目次"></select>
    </div>
    <div>
      <button id="prevChapter" class="mini-btn" aria-label="前へ">← 前へ</button>
      <button id="nextChapter" class="mini-btn" aria-label="次へ">次へ →</button>
    </div>
  </div>

  <!-- Content -->
  <section class="card" id="chapterCard">
    <h2 id="currentChapterTitle" class="visually-hidden" style="margin-top:0"></h2>
    <div id="chapterContent" tabindex="-1" style="line-height:1.9;font-family:'Noto Serif JP',serif;"></div>
  
    <!-- Endcap: Next chapter prompt -->
    <section class="endcap card" id="endcap" hidden aria-live="polite">
      <h3 id="endcapHeading">次に読む</h3>
      <div class="preview" id="nextPreview">次章の冒頭を表示します。</div>
      <div class="actions">
        <button id="endcapNextBtn" class="btn" aria-label="次へ">次へ</button>
        <button id="endcapPrevBtn" class="btn ghost" aria-label="前へ">前へ</button>
        <button id="endcapTocBtn" class="btn ghost" aria-label="目次へ">目次へ</button>
      </div>
    </section>
  </section>


  <footer style="text-align:center;color:var(--muted);font-size:.8rem;margin:1rem 0 4.5rem">© 運命の銀竜暦</footer>
</div>

<button class="resume-btn" id="resumeBtn" aria-label="前回位置に戻る">再開</button>

<!-- Bottom Nav -->
<nav class="bottom-nav" aria-label="主要ナビゲーション">
  <div class="bn-grid">
    <a class="bn-btn" href="./index.html" aria-label="ホーム">
      <span class="bn-icon">🏠</span>
      <span>ホーム</span>
    </a>
    <a class="bn-btn" href="./notice.html" aria-label="お知らせ">
      <span class="bn-icon">📰</span>
      <span>お知らせ</span>
    </a>
    <a class="bn-btn" href="./mypage.html" aria-label="マイページ">
      <span class="bn-icon">👤</span>
      <span>マイページ</span>
    </a>
  </div>
</nav>

<script>
// --- Config ---
const JSON_URL = './novel.json';
const POS_KEY_PREFIX = 'novel_pos_'; // + chapter id
const GA = (...args)=>{ try{ if (window.gtag) window.gtag(...args); } catch(e){} };

// --- Helpers ---
function stripHtml(html){ const tmp = document.createElement('div'); tmp.innerHTML = html || ''; return tmp.textContent || tmp.innerText || ''; }

// --- State ---
let endcapShownForChapter = null;
let chapters = [];
let currentIdx = 0;
let progressHit = new Set(); // to avoid duplicate read_progress events per threshold

// --- Elements ---
const selectorEl = document.getElementById('chapterSelector');
const contentEl = document.getElementById('chapterContent');
const titleEl = document.getElementById('currentChapterTitle');
const prevBtn = document.getElementById('prevChapter');
const nextBtn = document.getElementById('nextChapter');
const barEl = document.getElementById('progressBar');
const resumeBtn = document.getElementById('resumeBtn');
const endcapEl = document.getElementById('endcap');
const endcapNextBtn = document.getElementById('endcapNextBtn');
const endcapPrevBtn = document.getElementById('endcapPrevBtn');
const endcapTocBtn = document.getElementById('endcapTocBtn');
const endcapHeading = document.getElementById('endcapHeading');
const nextPreviewEl = document.getElementById('nextPreview');

// --- Fetch ---
fetch(JSON_URL, {cache:'no-store'})
  .then(r=>r.json())
  .then(data=>{
    chapters = data.chapters || [];
    buildSelector();
    render(0, /*scrollTop*/ true);
    if (chapters[0]) GA('event','view_novel', { items:[{ chapter_id: chapters[0].id, chapter_title: chapters[0].title }] });
  })
  .catch(err=>{
    contentEl.innerHTML = '<p style="color:#ffd27e">読み込みに失敗しました。novel.json を確認してください。</p>';
    console.error(err);
  });

function buildSelector(){
  selectorEl.innerHTML = chapters.map((c,i)=>`<option value="${i}">${String(c.id).padStart(2,'0')}：${c.title}</option>`).join('');
}

function render(idx, scrollTop){
  if (idx < 0 || idx >= chapters.length) return;
  currentIdx = idx; progressHit.clear();
  const c = chapters[idx];
  titleEl.textContent = c.title;
  selectorEl.value = String(idx);
  contentEl.innerHTML = c.content;
  // Update Endcap content
  if (idx < chapters.length-1){
    const n = chapters[idx+1];
    const preview = stripHtml(n.content).slice(0, 80);
    nextPreviewEl.textContent = preview ? preview + '…' : '';
    endcapHeading.textContent = '次に読む：' + n.title;
    endcapEl.hidden = true; // reset hidden on render
    endcapShownForChapter = null;
  }else{
    nextPreviewEl.textContent = '';
    endcapHeading.textContent = '完結';
    endcapEl.hidden = false; // show simple endcap at final
    endcapShownForChapter = chapters[idx].id;
  }
  // announce
  GA('event','pick_chapter', { chapter_id:c.id, chapter_title:c.title });
  // restore scroll
  if (scrollTop) window.scrollTo(0, 0);
  requestAnimationFrame(()=> updateResumeButton() );
}

function updateResumeButton(){
  const key = POS_KEY_PREFIX + chapters[currentIdx].id;
  const y = Number(localStorage.getItem(key) || 0);
  if (y>80){
    resumeBtn.style.display = 'block';
    resumeBtn.onclick = ()=> window.scrollTo({top:y, behavior:'smooth'});
  }else{
    resumeBtn.style.display = 'none';
  }
  updateProgress();
}

// --- Progress (top bar) ---
function updateProgress(){
  const h = document.documentElement;
  const scrolled = h.scrollTop || document.body.scrollTop;
  const height = h.scrollHeight - h.clientHeight;
  const r = height>0 ? (scrolled/height) : 0;
  barEl.style.width = (r*100)+'%';
  // Endcap reveal near bottom (>=95%)
  if (chapters.length && currentIdx < chapters.length-1){
    if (r >= 0.95){
      if (endcapEl.hidden){ endcapEl.hidden = false; }
      if (endcapShownForChapter !== chapters[currentIdx].id){
        endcapShownForChapter = chapters[currentIdx].id;
        GA('event','view_endcap', { chapter_id: chapters[currentIdx].id, next_chapter_id: chapters[currentIdx+1].id });
      }
    }else{
      if (!endcapEl.hidden) endcapEl.hidden = true;
    }
  }
  // Save position (throttled)
  if (!updateProgress._t){
    updateProgress._t = setTimeout(()=>{
      const key = POS_KEY_PREFIX + chapters[currentIdx].id;
      localStorage.setItem(key, String(window.scrollY));
      updateProgress._t = null;
    }, 250);
  }
  // GA progress at 25/50/75/100
  const pct = Math.floor(r*100);
  [25,50,75,100].forEach(th=>{
    if (pct>=th && !progressHit.has(th)){
      progressHit.add(th);
      GA('event','read_progress', { chapter_id:chapters[currentIdx].id, percent: th });
    }
  });
}

window.addEventListener('scroll', updateProgress);

// --- Nav
selectorEl.addEventListener('change', ()=> render(Number(selectorEl.value), true));
prevBtn.addEventListener('click', ()=>{ 
  if (currentIdx>0){ GA('event','prev_chapter', { from:chapters[currentIdx].id }); render(currentIdx-1, true); }
});
nextBtn.addEventListener('click', ()=>{ 
  if (currentIdx<chapters.length-1){ GA('event','next_chapter', { from:chapters[currentIdx].id }); render(currentIdx+1, true); }
});

// Endcap actions
endcapNextBtn?.addEventListener('click', ()=>{
  if (currentIdx<chapters.length-1){
    GA('event','click_next_chapter', { from:chapters[currentIdx].id, to:chapters[currentIdx+1].id });
    render(currentIdx+1, true);
  }
});
endcapPrevBtn?.addEventListener('click', ()=>{
  if (currentIdx>0){
    GA('event','click_prev_chapter', { from:chapters[currentIdx].id, to:chapters[currentIdx-1].id });
    render(currentIdx-1, true);
  }
});
endcapTocBtn?.addEventListener('click', ()=>{
  selectorEl.focus({preventScroll:false});
  GA('event','click_toc', { from:chapters[currentIdx].id }); 
  window.scrollTo({top:0, behavior:'smooth'});
});

// Keyboard
window.addEventListener('keydown', (e)=>{
  if (e.key==='ArrowRight') nextBtn.click();
  if (e.key==='ArrowLeft') prevBtn.click();
});
</script>
</body>
</html>

<!doctype html>
<html lang="ja">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1, viewport-fit=cover" />
  <title>é‹å‘½ã®éŠ€ç«œæš¦ï½œä¸ƒå¤œã®èªã‚Šå·»</title>
  <meta name="description" content="ã‚¨ãƒ†ãƒ«ãƒŠãƒªã‚¢ã®è³¢è€…ãŸã¡ãŒç¶´ã‚‹ä¸ƒå¤œã®èªã‚Šå·»ã€‚">
  <style>
    html { font-size:16px; }
    :root{
      --bg:#0b0d12; --ink:#fff; --muted:#aeb7d0; --line:#27304a; --card:#151826;
      --accent:#9fd3ff; --accent-2:#1a3358; --accent-2-b:#34507c;
      --radius:.875rem; --pad:1rem; --gap:.75rem; --tap:2.75rem;
    }
    *{ box-sizing:border-box }
    body{
      margin:0; background:var(--bg); color:var(--ink);
      font-family:system-ui,-apple-system,"Segoe UI",Roboto,"Hiragino Sans","Noto Sans JP",sans-serif;
      line-height:1.8; font-size:1rem; -webkit-text-size-adjust:100%;
      text-rendering:optimizeLegibility;
      padding-bottom:4.5rem; /* ä¸‹éƒ¨ãƒŠãƒ“åˆ†ã®ä½™ç™½ */
    }

    .wrap{ max-width:40rem; margin:0 auto; padding:1.0rem 1.0rem 0; }
    header{ text-align:center; padding:.5rem .25rem .25rem; }
    header h1{ margin:.25rem 0 .25rem; font-size:clamp(1.1rem,5vw,1.4rem); font-weight:700; }
    header .muted{ color:var(--muted); font-size:.8125rem; margin:0; }

    /* ã‚«ãƒ¼ãƒ‰ï¼ãƒ†ã‚­ã‚¹ãƒˆ */
    .card{ background:var(--card); border:1px solid var(--line); border-radius:var(--radius); padding:var(--pad); margin:.75rem 0; }
    .label{ font-size:.9375rem; color:#cfe1ff; margin-bottom:.5rem }
    .title{ font-size:1.0625rem; font-weight:700; line-height:1.4; margin:0; }
    .meta{ color:var(--muted); font-size:.8125rem; }
    .lead{ color:#e8eeff; font-size:1rem; margin:.25rem 0 .5rem; }
    .body{ color:#e0e6ff; font-size:1rem; }
    .sep{ height:1px; background:var(--line); margin:.75rem 0; }

    /* è¨˜äº‹ãƒ˜ãƒƒãƒ€ãƒ¼ï¼ˆã‚¢ã‚¤ã‚³ãƒ³ï¼‹ã‚¿ã‚¤ãƒˆãƒ«ï¼‰ */
    .article-head{
      display:grid; grid-template-columns:auto 1fr; gap:.75rem; align-items:center; margin-bottom:.5rem;
    }
    .avatar{
      width:3.25rem; height:3.25rem; border-radius:50%; border:1px solid var(--line);
      background:#10172a center/cover no-repeat; display:flex; align-items:center; justify-content:center;
      font-weight:700; color:#cfe1ff;
    }
    .avatar.fallback{ background:#10172a; }
    .byline{ display:flex; flex-wrap:wrap; gap:.375rem; align-items:center; }
    .badge{ display:inline-flex; align-items:center; gap:.25rem; padding:.125rem .5rem; border:1px solid var(--line); border-radius:999px; font-size:.75rem; background:#0f1528; color:#cfe1ff; }

    /* ä¸‹éƒ¨å›ºå®šãƒŠãƒ“ï¼ˆã‚³ãƒ³ãƒ‘ã‚¯ãƒˆï¼‰ */
    .bottom-nav{
      position:fixed; left:0; right:0; bottom:0; z-index:50;
      background:rgba(10,14,22,.9); backdrop-filter:blur(8px);
      border-top:1px solid var(--line);
    }
    .bn-grid{ max-width:40rem; margin:0 auto; display:grid; grid-template-columns:repeat(3,1fr); }
    .bn-btn{
      appearance:none; background:none; border:0; color:#cfe1ff; text-decoration:none;
      display:flex; flex-direction:column; align-items:center; justify-content:center;
      padding:.375rem 0; min-height:3.25rem; font-size:.75rem;
    }
    .bn-btn:focus-visible{ outline:2px solid var(--accent); outline-offset:-2px; }
    .bn-icon{
      width:20px; height:20px; margin-bottom:.125rem; border-radius:4px; border:1px solid var(--line); background:#16213c;
      display:flex; align-items:center; justify-content:center; font-size:.75rem;
    }
    .bn-accent{ color:#fff; }
    .pill{ display:inline-flex; align-items:center; justify-content:center; color:#d7e6ff;
      background:#13203a; border:1px solid #2b3b61; border-radius:999px; padding:.25rem .5rem; font-size:.75rem; }

    .grid{ display:grid; gap:.75rem; }
    .lock{ display:inline-flex; align-items:center; gap:.375rem; font-size:.8125rem; color:#d7e6ff;
      background:#13203a; border:1px solid #2b3b61; border-radius:999px; padding:.25rem .5rem; }
    footer{ text-align:center; color:var(--muted); font-size:.75rem; margin:1rem 0 .75rem }
  </style>
</head>
<body>
  <div class="wrap">
    <header>
      <h1>ä¸ƒå¤œã®èªã‚Šå·»</h1>
      <p class="muted">ä»Šå®µã®èªã‚Šå·»</p>
    </header>

    <section class="card" aria-label="ä»Šé€±ã®é€£è¼‰">
      <div class="label">
        ä»Šå®µã®èªã‚Šå·»
        <span id="statusPill" class="pill" style="margin-left:.5rem;">ç„¡æ–™ä¼šå“¡</span>
      </div>
      <div id="articles" class="grid" aria-live="polite"></div>
    </section>

    <footer>Â© é‹å‘½ã®éŠ€ç«œæš¦</footer>
  </div>

  <!-- ä¸‹éƒ¨å›ºå®šãƒŠãƒ“ï¼šã‚³ãƒ³ãƒ‘ã‚¯ãƒˆ5åˆ†å‰²ï¼ˆã‚¢ã‚¤ã‚³ãƒ³é¢¨ï¼‰ -->
  <nav class="bottom-nav" aria-label="ä¸»è¦ãƒŠãƒ“ã‚²ãƒ¼ã‚·ãƒ§ãƒ³">
    <div class="bn-grid">
      <a class="bn-btn" href="./index.html" aria-label="ãƒ›ãƒ¼ãƒ ">
        <span class="bn-icon">ğŸ </span><span>ãƒ›ãƒ¼ãƒ </span>
      </a>
      <a class="bn-btn" href="./notice.html" aria-label="ãŠçŸ¥ã‚‰ã›">
        <span class="bn-icon">ğŸ“£</span><span>ãŠçŸ¥ã‚‰ã›</span>
      </a>
      <a class="bn-btn" href="./mypage.html" aria-label="ãƒã‚¤ãƒšãƒ¼ã‚¸">
        <span class="bn-icon">ğŸ‘¤</span><span>ãƒã‚¤ãƒšãƒ¼ã‚¸</span>
      </a>
    </div>
  </nav>

<script>
/* ========== è¨­å®šï¼ˆé€£ç•ªæŠ½å‡ºãƒ»ç„¡æ–™ã¯æŠœç²‹ï¼‰ ========== */
const BASE_PATH   = "./";
const FILE_PREFIX = "articles_";   // ä¾‹: articles_001.json
const FILE_PAD    = 3;             // 001, 002, ...
const PROBE_MAX   = 200;           // å­˜åœ¨ç¢ºèªä¸Šé™
const PICK_COUNT  = 3;             // é€±ã‚ãŸã‚Šè¡¨ç¤ºæœ¬æ•°
const DEFAULT_FREE_PARAS = 2;      // ç„¡æ–™ã§è¦‹ã›ã‚‹æ®µè½æ•°

let isPremium = false; // æœ¬ç•ªã¯ã‚µãƒ¼ãƒåˆ¤å®š

/* ========== é€±æ¬¡ã‚·ãƒ¼ãƒ‰ï¼ˆåŒé€±ã¯åŒã˜é¸å‡ºï¼‰ ========== */
function getWeekKey(d=new Date()){
  const onejan = new Date(d.getFullYear(),0,1);
  const days = Math.floor((d - onejan)/86400000);
  const week = Math.floor((days + onejan.getDay()+6)/7) + 1;
  return `${d.getFullYear()}-W${week}`;
}
function hashStr(s){ let h=2166136261>>>0; for(let i=0;i<s.length;i++){ h^=s.charCodeAt(i); h=Math.imul(h,16777619);} return h>>>0; }
function mulberry32(a){ return function(){ let t=a+=0x6D2B79F5; t=Math.imul(t^(t>>>15),t|1); t^=t+Math.imul(t^(t>>>7),t|61); return ((t^(t>>>14))>>>0)/4294967296; } }
function shuffleDet(arr, seedStr){
  const rng = mulberry32(hashStr(seedStr));
  const a = arr.slice();
  for(let i=a.length-1;i>0;i--){
    const j = Math.floor(rng()*(i+1));
    [a[i],a[j]] = [a[j],a[i]];
  }
  return a;
}

/* ========== UI ========== */
const statusPill = document.getElementById("statusPill");
document.getElementById("toggleDemo").addEventListener("click", ()=>{
  isPremium = !isPremium;
  statusPill.textContent = isPremium ? "æœ‰æ–™ä¼šå“¡ï¼ˆãƒ‡ãƒ¢ï¼‰" : "ç„¡æ–™ä¼šå“¡";
  renderArticles(cachedArticles);
});

/* ========== é€£ç•ªãƒ•ã‚¡ã‚¤ãƒ«ã®æ¢ç´¢ ========== */
async function fetchJson(path){
  const res = await fetch(path, {cache:"no-cache"});
  if(!res.ok) throw new Error(res.status+" "+res.statusText);
  return res.json();
}
function pad(n, w=FILE_PAD){ return String(n).padStart(w,"0"); }

async function probeFiles(){
  const found = [];
  const BATCH = 10;
  for(let start=1; start<=PROBE_MAX; start+=BATCH){
    const tasks=[];
    for(let i=start; i<start+BATCH && i<=PROBE_MAX; i++){
      const path = `${BASE_PATH}${FILE_PREFIX}${pad(i)}.json`;
      tasks.push(fetchJson(path).then(j=>({ok:true,j,id:i,path})).catch(_=>({ok:false})));
    }
    const results = await Promise.all(tasks);
    for(const r of results){
      if(!r.ok) continue;
      // 1è¨˜äº‹å‹ or æœˆæŸå‹ï¼ˆã€Œèªã‚Šæ‰‹é…åˆ—ã€ç­‰ï¼‰ã‚’æ­£è¦åŒ–
      if(Array.isArray(r.j["èªã‚Šå·»"])){
        r.j["èªã‚Šå·»"].forEach((it, idx)=>{
          found.push({ id:`${r.id}-${idx+1}`, path:r.path, data: normalizeArticle(it, r.j) });
        });
      }else{
        found.push({ id:r.id, path:r.path, data: normalizeArticle(r.j, null) });
      }
    }
    if(found.length>=36) break;
  }
  return found;
}

/* ========== è¨˜äº‹æ­£è¦åŒ–ï¼ˆä¸–ç•Œè¦³/ç¾ä»£èªã‚­ãƒ¼ã®ä¸¡å¯¾å¿œï¼‰ ========== */
function normalizeArticle(raw, parent){
  const title  = raw.é¡Œå || raw.title || "ï¼ˆç„¡é¡Œï¼‰";
  const author = raw.èªã‚Šæ‰‹ || raw.author || "";
  const role   = raw.èªã‚Šæ‰‹ã®è‚©æ›¸ || raw.role || "";
  const lead   = raw.lead || raw.å°å…¥ || "";
  const body   = Array.isArray(raw.body) ? raw.body
                : (typeof raw.æœ¬æ–‡ === "string" ? raw.æœ¬æ–‡.split(/\n{2,}/) : []);
  const date   = raw.date || raw.æ—¥ä»˜ || raw.å…¬é–‹æ—¥ || (parent && parent.æœˆåº¦ ? parent.æœˆåº¦ : "");
  const tags   = raw.tags || raw.å° || [];
  const source_hint = raw.source_hint || raw.å‡ºå…¸ || "";
  const free_paragraphs = Number.isInteger(raw.free_paragraphs) ? raw.free_paragraphs : null;
  const avatar = raw.avatar || raw.èªã‚Šæ‰‹ã®è‚–åƒ || guessAvatar(author); // ç”»åƒãƒ‘ã‚¹

  return { title, author, role, lead, body, date, tags, source_hint, free_paragraphs, avatar };
}

/* ========== èªã‚Šæ‰‹ã‚¢ã‚¤ã‚³ãƒ³æ¨æ¸¬ï¼ˆãƒ•ã‚¡ã‚¤ãƒ«æœªæŒ‡å®šæ™‚ã®ç°¡æ˜“ãƒãƒƒãƒ”ãƒ³ã‚°ï¼‰ ========== */
function guessAvatar(author){
  if(!author) return "";
  const map = {
    "ãƒ«ãƒŠãƒ«":"assets/author-lunal.png",
    "ã‚¢ãƒ©ãƒ³":"assets/author-alan.png",
    "ãƒªãƒªã‚¢":"assets/author-lilia.png",
    "ãƒ©ã‚¤ãƒ©":"assets/author-laila.png",
    "ãƒ‰ãƒ¬ã‚¤ã‚¯":"assets/author-drake.png",
    "ãƒã‚¯ã‚µãƒ¼ãƒˆ":"assets/author-king.png",
    "ãƒã‚°ãƒŠã‚¹":"assets/author-magnus.png",
    "ãƒã‚¹ã‚¿ãƒ¼":"assets/author-nester.png",
    "ãƒŸãƒ¬ã‚¤ã‚¢":"assets/author-mireia.png"
  };
  // å‰æ–¹ä¸€è‡´ã§ã‚†ã‚‹ãåˆ¤å®š
  for(const key of Object.keys(map)){
    if(author.startsWith(key)) return map[key];
  }
  return ""; // ãªã‘ã‚Œã°ãƒ†ã‚­ã‚¹ãƒˆã‚¤ãƒ‹ã‚·ãƒ£ãƒ«ã§ãƒ•ã‚©ãƒ¼ãƒ«ãƒãƒƒã‚¯
}

/* ========== é€±æ¬¡ãƒ©ãƒ³ãƒ€ãƒ é¸å‡º ========== */
function pickArticles(pool){
  const seed = "serial|" + getWeekKey();
  const shuffled = shuffleDet(pool, seed);
  const seen = new Set();
  const picks = [];
  for(const a of shuffled){
    if(seen.has(a.id)) continue;
    picks.push(a); seen.add(a.id);
    if(picks.length>=PICK_COUNT) break;
  }
  return picks;
}

/* ========== æç”» ========== */
const listEl = document.getElementById("articles");
function esc(s){ return String(s||"").replace(/[&<>]/g, m=>({'&':'&amp;','<':'&lt;','>':'&gt;'}[m])); }

function renderItem(a){
  const d = a.data.date ? new Date(a.data.date) : null;
  const metaDate = (d && !isNaN(d)) ? `${d.getFullYear()}å¹´${d.getMonth()+1}æœˆ${d.getDate()}æ—¥` : esc(a.data.date||"");
  const tags = (a.data.tags||[]).slice(0,3).map(esc).join("ãƒ»");

  const freeN = a.data.free_paragraphs ?? DEFAULT_FREE_PARAS;
  const hasLead = !!(a.data.lead && a.data.lead.trim());
  const freeBody = (a.data.body||[]).slice(0, Math.max(0, freeN));
  const fullBody = (a.data.body||[]);

  const freeHtml = `
    ${ hasLead ? `<p class="lead">${esc(a.data.lead)}</p>` : "" }
    <div class="body">${freeBody.map(p=>`<p>${esc(p)}</p>`).join("")}</div>
  `;
  const fullHtml = `
    ${ hasLead ? `<p class="lead">${esc(a.data.lead)}</p>` : "" }
    <div class="body">${fullBody.map(p=>`<p>${esc(p)}</p>`).join("")}</div>
  `;

  // ã‚¢ãƒã‚¿ãƒ¼ï¼šç”»åƒãŒãªã‘ã‚Œã°é ­æ–‡å­—2å­—ã‚’å††å†…è¡¨ç¤º
  const av = a.data.avatar;
  const initials = (a.data.author||"").slice(0,2) || "è³¢è€…";
  const avatarHtml = av
    ? `<div class="avatar" style="background-image:url('${esc(av)}');" aria-hidden="true"></div>`
    : `<div class="avatar fallback" aria-hidden="true">${esc(initials)}</div>`;

  return `
    <article class="card">
      <div class="article-head">
        ${avatarHtml}
        <div>
          <h2 class="title">${esc(a.data.title)}</h2>
          <div class="byline meta">
            ${metaDate ? `${esc(metaDate)}` : ``}
            ${tags ? ` / ${tags}` : ``}
            ${a.data.author ? ` / èªã‚Šæ‰‹ï¼š${esc(a.data.author)}` : ``}
            ${a.data.role ? `ï¼ˆ${esc(a.data.role)}ï¼‰` : ``}
          </div>
        </div>
      </div>

      <div class="sep"></div>
      ${ isPremium ? fullHtml
                   : `${freeHtml}
                       ${ fullBody.length > freeBody.length
                           ? `<div class="sep"></div>
                              <div class="lock">ğŸ”’ ç¶šãã‚’èª­ã‚€ã«ã¯ <a class="pill" href="./signup.html" style="margin-left:.5rem;">ä¼šå“¡ç™»éŒ²</a></div>`
                           : `` }`
      }
      ${ a.data.source_hint ? `<div class="sep"></div><p class="meta">${esc(a.data.source_hint)}ï¼ˆâ€»é•·æ–‡å¼•ç”¨ã¯é¿ã‘è¦æ—¨åŒ–ï¼‰</p>` : "" }
    </article>
  `;
}

function renderArticles(arr){
  if(!arr || !arr.length){
    listEl.innerHTML = `<div class="card"><p class="meta">è¨˜äº‹ãŒè¦‹ã¤ã‹ã‚Šã¾ã›ã‚“ã§ã—ãŸã€‚</p></div>`;
    return;
  }
  const picks = pickArticles(arr);
  listEl.innerHTML = picks.map(renderItem).join("");
}

/* ========== èµ·å‹• ========== */
let cachedArticles = [];
(async function(){
  try{
    const pool = await probeFiles();
    cachedArticles = pool;
    renderArticles(pool);
  }catch(e){
    console.warn(e);
    listEl.innerHTML = `<div class="card"><p class="meta">èª­ã¿è¾¼ã¿ã«å¤±æ•—ã—ã¾ã—ãŸã€‚</p></div>`;
  }
})();
</script>
</body>
</html>

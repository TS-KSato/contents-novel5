<!doctype html>
<html lang="ja">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1, viewport-fit=cover" />
  <title>é‹å‘½ã®éŠ€ç«œæš¦ï½œé€£è¼‰</title>
  <meta name="description" content="ã‚¨ãƒ†ãƒ«ãƒŠãƒªã‚¢ã®è³¢è€…ãŸã¡ãŒç¶´ã‚‹é€£è¼‰ã€‚ç„¡æ–™ã¯æŠœç²‹ã€æœ‰æ–™ã¯å…¨æ–‡ã‚’èª­ã‚ã¾ã™ã€‚">
  <style>
    html { font-size: 16px; }
    :root{
      --bg:#0b0d12; --ink:#ffffff; --muted:#aeb7d0; --line:#27304a; --card:#151826;
      --accent:#9fd3ff; --accent-2:#1a3358; --accent-2-b:#34507c;
      --radius:.875rem; --pad:1rem; --gap:.75rem; --tap:2.75rem;
    }
    *{ box-sizing:border-box }
    body{
      margin:0; background:var(--bg); color:var(--ink);
      font-family:system-ui,-apple-system,"Segoe UI",Roboto,"Hiragino Sans","Noto Sans JP",sans-serif;
      line-height:1.8; font-size:1rem; -webkit-text-size-adjust:100%;
      text-rendering: optimizeLegibility;
    }
    .wrap{ max-width:40rem; margin:0 auto; padding:1.25rem }
    header{ text-align:center; padding:1rem .5rem; }
    header h1{ margin:.25rem 0 .25rem; font-size:clamp(1.25rem,5.5vw,1.5rem); }
    header .muted{ color:var(--muted); font-size:.875rem }
    .nav{ display:flex; gap:.75rem; flex-wrap:wrap; justify-content:center; margin:.5rem 0 1rem; }
    .pill{
      display:inline-flex; align-items:center; justify-content:center;
      color:var(--accent); text-decoration:none; background:#11172a; border:1px solid var(--line);
      padding:.375rem .625rem; border-radius:999px; font-size:.8125rem; min-height:var(--tap);
    }
    .pill:hover{ background:#18213a }
    .pill.accent{ background:var(--accent-2); border-color:var(--accent-2-b); color:#fff }

    .card{ background:var(--card); border:1px solid var(--line); border-radius:var(--radius); padding:var(--pad); margin:.75rem 0; }
    .label{ font-size:.9375rem; color:#cfe1ff; margin-bottom:.5rem }
    .title{ font-size:1.125rem; font-weight:700; line-height:1.4; margin:.25rem 0 .25rem; }
    .meta{ color:var(--muted); font-size:.8125rem; }
    .lead{ color:#e8eeff; font-size:1rem; margin:.25rem 0 .5rem; }
    .body{ color:#e0e6ff; font-size:1rem; }
    .sep{ height:1px; background:var(--line); margin:.75rem 0; }
    .grid{ display:grid; gap:.75rem; }
    .lock{
      display:inline-flex; align-items:center; gap:.375rem; font-size:.8125rem;
      color:#d7e6ff; background:#13203a; border:1px solid #2b3b61; border-radius:999px; padding:.25rem .5rem;
    }
    footer{ text-align:center; color:var(--muted); font-size:.75rem; margin:1rem 0 .5rem }
  </style>
</head>
<body>
  <div class="wrap">
    <header>
      <h1>é€£è¼‰ï¼ˆç„¡æ–™ã¯æŠœç²‹ï¼æœ‰æ–™ã¯å…¨æ–‡ï¼‰</h1>
      <p class="muted">é€±ã”ã¨ã«é¸å‡ºã•ã‚ŒãŸä¸‰æœ¬ã®èªã‚Šã€‚<br>ç„¡æ–™ã¯æŠœç²‹ã®ã¿ã€æœ‰æ–™ã¯å…¨æ–‡ã‚’ãŠæ¥½ã—ã¿ã„ãŸã ã‘ã¾ã™ã€‚</p>
      <nav class="nav">
        <a href="./index.html" class="pill">â† å ã„ãƒˆãƒƒãƒ—</a>
        <a href="./list.html" class="pill">ãŠã¾ã‘ãƒšãƒ¼ã‚¸</a>
        <span class="pill" id="statusPill">ç„¡æ–™ä¼šå“¡</span>
        <button id="toggleDemo" class="pill" aria-pressed="false">ï¼ˆãƒ‡ãƒ¢ï¼‰æœ‰æ–™/ç„¡æ–™ åˆ‡æ›¿</button>
      </nav>
    </header>

    <section class="card">
      <div class="label">ä»Šé€±ã®é¸å‡ºï¼ˆâ€»é€±ã”ã¨ã«å›ºå®šãƒ»ç¿Œé€±åˆ·æ–°ï¼‰</div>
      <div id="articles" class="grid" aria-live="polite"></div>
      <p class="meta" style="margin-top:.5rem;">â€»åˆ¶ä½œéƒ½åˆã§ãƒ•ã‚¡ã‚¤ãƒ«ãŒå°‘ãªã„å ´åˆã¯ã€åŒä¸€æœˆã®åˆ¥è©±ã‚„éå»ä½œã‚’é¸å‡ºã™ã‚‹ã“ã¨ãŒã‚ã‚Šã¾ã™ã€‚</p>
    </section>

    <footer>Â© é‹å‘½ã®éŠ€ç«œæš¦</footer>
  </div>

<script>
/* ================== åŸºæœ¬è¨­å®š ================== */
const BASE_PATH = "./";               // é€£ç•ªJSONã®é…ç½®ãƒ‘ã‚¹
const FILE_PREFIX = "articles_";      // ä¾‹: articles_001.json
const FILE_PAD = 3;                   // 001, 002, ...
const PROBE_MAX = 200;                // å­˜åœ¨ãƒã‚§ãƒƒã‚¯ä¸Šé™
const PICK_COUNT = 3;                 // 1é€±ã‚ãŸã‚Šè¡¨ç¤ºä»¶æ•°
let isPremium = false;                // æœ¬ç•ªã¯ã‚µãƒ¼ãƒå´ã§åˆ¤å®š

/* ================== ç„¡æ–™æŠœç²‹ã®ä»•æ§˜ ==================
 * 1è¨˜äº‹JSONã«ã€Œleadã€ã€Œbodyï¼ˆé…åˆ—ï¼‰ã€ãŒã‚ã‚‹å‰æã€‚
 * ç„¡æ–™ï¼šlead + bodyã®å…ˆé ­Næ®µè½ã®ã¿è¡¨ç¤ºï¼ˆN=2ã‚’æ—¢å®šï¼‰
 * æœ‰æ–™ï¼šå…¨æ–‡ï¼ˆlead + bodyå…¨æ®µè½ï¼‰
 * JSONå´ã« free_paragraphs ãŒã‚ã‚Œã°ãã®æ•°ã‚’å„ªå…ˆ
 * ä¾‹ï¼š{ "lead":"...", "body":[ "...", "...", ... ], "free_paragraphs": 1 }
 * ================================================== */
const DEFAULT_FREE_PARAS = 2;

/* ============ é€±æ¬¡ã‚·ãƒ¼ãƒ‰ï¼ˆåŒé€±ã¯åŒã˜æŠ½é¸ï¼‰ ============ */
function getWeekKey(d=new Date()){
  const onejan = new Date(d.getFullYear(),0,1);
  const days = Math.floor((d - onejan) / 86400000);
  const week = Math.floor((days + onejan.getDay()+6) / 7) + 1; // ç°¡æ˜“é€±ç•ªå·
  return `${d.getFullYear()}-W${week}`;
}
function hashStr(s){ let h=2166136261>>>0; for(let i=0;i<s.length;i++){ h^=s.charCodeAt(i); h=Math.imul(h,16777619);} return h>>>0; }
function mulberry32(a){ return function(){ let t=a+=0x6D2B79F5; t=Math.imul(t^(t>>>15),t|1); t^=t+Math.imul(t^(t>>>7),t|61); return ((t^(t>>>14))>>>0)/4294967296; } }
function shuffleDet(arr, seedStr){
  const rng = mulberry32(hashStr(seedStr));
  const a = arr.slice();
  for(let i=a.length-1;i>0;i--){
    const j = Math.floor(rng()*(i+1));
    [a[i],a[j]] = [a[j],a[i]];
  }
  return a;
}

/* ============ UI ============ */
const statusPill = document.getElementById("statusPill");
document.getElementById("toggleDemo").addEventListener("click", ()=>{
  isPremium = !isPremium;
  statusPill.textContent = isPremium ? "æœ‰æ–™ä¼šå“¡ï¼ˆãƒ‡ãƒ¢ï¼‰" : "ç„¡æ–™ä¼šå“¡";
  renderArticles(cachedArticles); // å†æç”»
});

/* ============ é€£ç•ªãƒ•ã‚¡ã‚¤ãƒ«ã®æ¢ç´¢ ============ */
async function fetchJson(path){
  const res = await fetch(path, {cache: "no-cache"});
  if(!res.ok) throw new Error(res.status+" "+res.statusText);
  return res.json();
}
function pad(n, width=FILE_PAD){ return String(n).padStart(width,"0"); }

async function probeFiles(){
  const found = [];
  const BATCH = 10; // å¸¯åŸŸã«é…æ…®ã—ã¦10æœ¬ãšã¤
  for(let start=1; start<=PROBE_MAX; start+=BATCH){
    const tasks = [];
    for(let i=start; i<start+BATCH && i<=PROBE_MAX; i++){
      const path = `${BASE_PATH}${FILE_PREFIX}${pad(i)}.json`;
      tasks.push(
        fetchJson(path).then(j=>({ok:true, j, id:i, path})).catch(_=>({ok:false}))
      );
    }
    const results = await Promise.all(tasks);
    for(const r of results){
      if(!r.ok) continue;
      // ãƒ•ã‚¡ã‚¤ãƒ«å½¢å¼ã®è¨±å®¹ï¼š
      // 1) 1è¨˜äº‹æ§‹é€ ï¼ˆtitle/lead/bodyï¼‰
      // 2) æœˆæŸæ§‹é€ ï¼ˆ"èªã‚Šå·»" é…åˆ—ã«è¤‡æ•°è¨˜äº‹ï¼‰â† å°†æ¥ã®æœˆå˜ä½ãƒ•ã‚¡ã‚¤ãƒ«ã«ã‚‚è€æ€§
      if(Array.isArray(r.j["èªã‚Šå·»"])){
        r.j["èªã‚Šå·»"].forEach((it, idx)=>{
          // æ­£è¦åŒ–
          found.push({
            id: `${r.id}-${idx+1}`,
            path: r.path,
            data: normalizeArticle(it, r.j)
          });
        });
      }else{
        found.push({
          id: r.id,
          path: r.path,
          data: normalizeArticle(r.j, null)
        });
      }
    }
    if(found.length >= 36) break; // é€±é¸å‡ºã«ã¯ååˆ†
  }
  return found;
}

/* ============ è¨˜äº‹æ­£è¦åŒ– ============ */
function normalizeArticle(raw, parent){
  // å—ã‘å…¥ã‚Œã‚‹å¯èƒ½ãªã‚­ãƒ¼ã‚’ä¸–ç•Œè¦³/ç¾ä»£èªåŒæ–¹ã§ãƒãƒƒãƒ”ãƒ³ã‚°
  const title = raw.é¡Œå || raw.title || "ï¼ˆç„¡é¡Œï¼‰";
  const author = raw.èªã‚Šæ‰‹ || raw.author || "";
  const role = raw.èªã‚Šæ‰‹ã®è‚©æ›¸ || raw.role || "";
  const lead = raw.lead || raw.å°å…¥ || ""; // ãªã‘ã‚Œã°å¾Œã§æœ¬æ–‡å…ˆé ­ã‚’ä»£ç”¨
  const body = Array.isArray(raw.body) ? raw.body
              : (typeof raw.æœ¬æ–‡ === "string" ? raw.æœ¬æ–‡.split(/\n{2,}/) : []);
  const date = raw.date || raw.æ—¥ä»˜ || raw.å…¬é–‹æ—¥ || (parent && parent.æœˆåº¦ ? parent.æœˆåº¦ : "");
  const tags = raw.tags || raw.å° || [];
  const source_hint = raw.source_hint || raw.å‡ºå…¸ || "";
  const free_paragraphs = Number.isInteger(raw.free_paragraphs) ? raw.free_paragraphs : null;

  return { title, author, role, lead, body, date, tags, source_hint, free_paragraphs };
}

/* ============ é€±æ¬¡ãƒ©ãƒ³ãƒ€ãƒ é¸å‡º ============ */
function pickArticles(pool){
  const seed = "serial|" + getWeekKey();
  const shuffled = shuffleDet(pool, seed);
  const seen = new Set();
  const picks = [];
  for(const a of shuffled){
    if(seen.has(a.id)) continue;
    picks.push(a);
    seen.add(a.id);
    if(picks.length >= PICK_COUNT) break;
  }
  return picks;
}

/* ============ æç”» ============ */
const listEl = document.getElementById("articles");
function esc(s){ return String(s||"").replace(/[&<>]/g, m=>({'&':'&amp;','<':'&lt;','>':'&gt;'}[m])); }

function renderItem(a){
  const d = a.data.date ? new Date(a.data.date) : null;
  const meta = d && !isNaN(d) ? `${d.getFullYear()}å¹´${d.getMonth()+1}æœˆ${d.getDate()}æ—¥` : esc(a.data.date||"");
  const tags = (a.data.tags||[]).slice(0,3).map(esc).join("ãƒ»");

  // æŠœç²‹é•·ï¼šJSONã® free_paragraphs ã‚’å„ªå…ˆã€ãªã‘ã‚Œã°æ—¢å®šå€¤
  const freeN = a.data.free_paragraphs ?? DEFAULT_FREE_PARAS;
  const hasLead = !!(a.data.lead && a.data.lead.trim());
  const freeBody = (a.data.body||[]).slice(0, Math.max(0, freeN));
  const fullBody = (a.data.body||[]);

  const freeHtml = `
    ${ hasLead ? `<p class="lead">${esc(a.data.lead)}</p>` : "" }
    <div class="body">${freeBody.map(p=>`<p>${esc(p)}</p>`).join("")}</div>
  `;

  const fullHtml = `
    ${ hasLead ? `<p class="lead">${esc(a.data.lead)}</p>` : "" }
    <div class="body">${fullBody.map(p=>`<p>${esc(p)}</p>`).join("")}</div>
  `;

  return `
    <article class="card">
      <div class="title">${esc(a.data.title)}</div>
      <div class="meta">
        ${(meta || "").trim() ? esc(meta) : ""}
        ${tags ? ` / ${tags}` : ""}
        ${a.data.author ? ` / èªã‚Šæ‰‹ï¼š${esc(a.data.author)}` : ""}
        ${a.data.role ? `ï¼ˆ${esc(a.data.role)}ï¼‰` : ""}
      </div>
      <div class="sep"></div>
      ${ isPremium ? fullHtml
                   : `${freeHtml}
                       ${ fullBody.length > freeBody.length
                           ? `<div class="sep"></div>
                              <div class="lock">ğŸ”’ ç¶šãã‚’èª­ã‚€ã«ã¯ <a class="pill accent" href="./signup.html" style="margin-left:.5rem;">ä¼šå“¡ç™»éŒ²</a></div>`
                           : `` }`
      }
      ${ a.data.source_hint ? `<div class="sep"></div><p class="meta">${esc(a.data.source_hint)}ï¼ˆâ€»é•·æ–‡å¼•ç”¨ã¯é¿ã‘è¦æ—¨åŒ–ï¼‰</p>` : "" }
    </article>
  `;
}

function renderArticles(arr){
  if(!arr || !arr.length){
    listEl.innerHTML = `<div class="card"><p class="meta">è¨˜äº‹ãŒè¦‹ã¤ã‹ã‚Šã¾ã›ã‚“ã§ã—ãŸã€‚æ™‚é–“ã‚’ãŠã„ã¦å†åº¦ãŠè©¦ã—ãã ã•ã„ã€‚</p></div>`;
    return;
  }
  const picks = pickArticles(arr);
  listEl.innerHTML = picks.map(renderItem).join("");
}

/* ============ èµ·å‹• ============ */
let cachedArticles = [];
(async function(){
  try{
    const pool = await probeFiles();
    cachedArticles = pool;
    renderArticles(pool);
  }catch(e){
    console.warn(e);
    listEl.innerHTML = `<div class="card"><p class="meta">èª­ã¿è¾¼ã¿ã«å¤±æ•—ã—ã¾ã—ãŸã€‚</p></div>`;
  }
})();
</script>
</body>
</html>

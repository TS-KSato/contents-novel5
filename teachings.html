<!DOCTYPE html>
<html lang="ja">
<head>
  <meta charset="UTF-8" />
  <meta
    name="viewport"
    content="width=device-width, initial-scale=1, viewport-fit=cover"
  />
  <title>聖竜教の教え</title>
  <meta name="color-scheme" content="light dark" />
  <style>
    :root {
      --bg: #ffffff;
      --fg: #1f2937;        /* slate-800 */
      --muted: #6b7280;     /* gray-500 */
      --border: #e5e7eb;    /* gray-200 */
      --primary: #334155;   /* slate-700 */
      --primary-fg: #ffffff;
      --chip: #f3f4f6;      /* gray-100 */
      --bubble-user: #f8fafc; /* slate-50 */
      --bubble-sys: #eef2ff;  /* indigo-50 */
      --shadow: 0 4px 16px rgba(0,0,0,.06);
    }
    @media (prefers-color-scheme: dark) {
      :root{
        --bg: #0b0f14;
        --fg: #e5e7eb;
        --muted: #9ca3af;
        --border: #1f2937;
        --primary: #94a3b8;
        --primary-fg: #0b0f14;
        --chip: #111827;
        --bubble-user: #0f172a;
        --bubble-sys: #111827;
        --shadow: 0 10px 25px rgba(0,0,0,.25);
      }
    }
    * { box-sizing: border-box; }
    html, body {
      height: 100%;
      margin: 0;
      background: var(--bg);
      color: var(--fg);
      font-family: system-ui, -apple-system, "Segoe UI", Roboto, "Noto Sans JP", "Hiragino Kaku Gothic ProN", "Yu Gothic", "游ゴシック体", "ヒラギノ角ゴ ProN", Meiryo, sans-serif;
    }
    header {
      position: sticky; top: 0; z-index: 20;
      background: var(--bg);
      border-bottom: 1px solid var(--border);
      backdrop-filter: saturate(180%) blur(6px);
    }
    .wrap { max-width: 1200px; margin: 0 auto; padding: 0 16px; }
    .head {
      display: flex; align-items: center; gap: 12px;
      height: 56px;
    }
    .title { font-size: 18px; font-weight: 700; letter-spacing: .02em; }
    .subtle { color: var(--muted); font-size: 12px; }

    .layout {
      display: grid; grid-template-columns: 280px 1fr; gap: 16px;
      padding: 16px; max-width: 1200px; margin: 0 auto;
    }
    @media (max-width: 860px) {
      .layout { grid-template-columns: 1fr; padding: 8px; gap: 8px; }
    }

    /* 左サイド（ルーム一覧） */
    .panel {
      border: 1px solid var(--border);
      border-radius: 14px;
      overflow: clip;
      background: var(--bg);
      box-shadow: var(--shadow);
    }
    .panel .panel-head {
      padding: 12px 14px; border-bottom: 1px solid var(--border);
      display: flex; align-items: center; justify-content: space-between; gap: 8px;
    }
    .search {
      width: 100%;
      display: flex; gap: 8px; align-items: center;
      border: 1px solid var(--border); background: var(--chip);
      padding: 8px 10px; border-radius: 10px;
    }
    .search input {
      flex: 1; border: none; outline: none; background: transparent; color: var(--fg);
      font-size: 14px;
    }
    .rooms {
      max-height: 60vh; overflow: auto;
    }
    .room-item {
      width: 100%; display: flex; gap: 10px; padding: 12px 14px;
      border: 0; outline: 0; background: transparent; text-align: left;
      cursor: pointer; border-bottom: 1px solid var(--border);
    }
    .room-item:last-child { border-bottom: none; }
    .room-item:hover { background: var(--chip); }
    .room-item.active { background: var(--bubble-sys); }
    .avatar {
      flex: 0 0 36px; height: 36px; width: 36px; border-radius: 50%;
      background: var(--primary); color: var(--primary-fg);
      display: grid; place-items: center; font-weight: 700;
    }
    .room-main { flex: 1; min-width: 0; }
    .room-name { font-weight: 700; font-size: 14px; }
    .room-meta { color: var(--muted); font-size: 12px; line-height: 1.4; }
    .chip {
      display: inline-block; font-size: 11px; padding: 2px 8px; border-radius: 999px;
      background: var(--chip); color: var(--muted); border: 1px solid var(--border);
    }

    /* メッセージ領域 */
    .thread {
      display: grid; grid-template-rows: auto 1fr; height: 100%;
      border: 1px solid var(--border);
      border-radius: 14px; overflow: clip; background: var(--bg); box-shadow: var(--shadow);
    }
    .thread-head {
      padding: 12px 16px; border-bottom: 1px solid var(--border);
      display: flex; align-items: center; justify-content: space-between; gap: 8px;
    }
    .room-title { font-weight: 800; font-size: 16px; }
    .thread-body {
      padding: 10px 12px; overflow: auto; max-height: calc(100vh - 160px);
    }
    @media (max-width: 860px) {
      .thread-body { max-height: none; }
    }
    .section-date {
      text-align: center; margin: 18px 0 12px; position: relative;
    }
    .section-date span {
      display: inline-block; background: var(--bg); padding: 2px 10px; color: var(--muted);
      font-size: 12px; border: 1px solid var(--border); border-radius: 999px;
    }

    .msg {
      display: grid; grid-template-columns: 40px 1fr; gap: 10px; align-items: flex-start;
      padding: 8px 4px;
    }
    .msg .avatar { height: 32px; width: 32px; font-size: 12px; }
    .bubble {
      padding: 10px 12px; border-radius: 12px; line-height: 1.7;
      background: var(--bubble-user); border: 1px solid var(--border);
      word-wrap: break-word; white-space: pre-wrap;
    }
    .bubble.system { background: var(--bubble-sys); }
    .meta-line {
      display: flex; flex-wrap: wrap; gap: 8px; align-items: center; margin-top: 6px;
      color: var(--muted); font-size: 12px;
    }
    .speaker { font-weight: 700; color: var(--fg); }
    .ts { font-variant-numeric: tabular-nums; letter-spacing: .02em; }

    .empty {
      padding: 32px; text-align: center; color: var(--muted);
    }

    /* 下部ナビ（モバイル優先のプロジェクト指針に沿い、簡易実装） */
    nav.bottom {
      position: sticky; bottom: 0; z-index: 15;
      border-top: 1px solid var(--border); background: var(--bg);
    }
    .bottom .navwrap {
      display: grid; grid-template-columns: repeat(3,1fr);
      max-width: 640px; margin: 0 auto;
    }
    .navbtn {
      padding: 10px 8px; border: 0; background: transparent; color: var(--muted);
      font-size: 12px;
    }
    .navbtn strong { display: block; color: var(--fg); font-size: 12px; }
  </style>
</head>
<body>
  <header>
    <div class="wrap head">
      <div class="title">聖竜教の教え</div>
      <div class="subtle">エテルナリア最古の賢人ライラが語る</div>
    </div>
  </header>

  <main class="layout" id="app">
    <!-- 左：ルーム一覧 -->
    <aside class="panel">
      <div class="panel-head">
        <div class="search" style="width:100%">
          <svg width="16" height="16" viewBox="0 0 24 24" aria-hidden="true"><path fill="currentColor" d="M15.5 14h-.79l-.28-.27a6.471 6.471 0 0 0 1.57-4.23A6.5 6.5 0 1 0 9.5 15a6.471 6.471 0 0 0 4.23-1.57l.27.28v.79l5 5l1.5-1.5l-5-5zm-6 0C7.01 14 5 11.99 5 9.5S7.01 5 9.5 5S14 7.01 14 9.5S11.99 14 9.5 14"/></svg>
          <input id="q" type="search" placeholder="キャラ・要約で絞り込み" aria-label="検索" />
        </div>
      </div>
      <div class="rooms" id="rooms"></div>
    </aside>

    <!-- 右：スレッド -->
    <section class="thread">
      <div class="thread-head">
        <div>
          <div class="room-title" id="roomTitle">ルームを選択</div>
          <div class="subtle" id="roomSummary"></div>
        </div>
        <div class="subtle"><span id="count"></span></div>
      </div>
      <div class="thread-body" id="threadBody">
        <div class="empty">左の一覧からルームを選んでください。</div>
      </div>
    </section>
  </main>

  <nav class="bottom" aria-label="主要ナビ">
    <div class="navwrap">
      <button class="navbtn" type="button" onclick="location.href='index.html'"><strong>ホーム</strong>Top</button>
      <button class="navbtn" type="button" onclick="location.href='notice.html'"><strong>お知らせ</strong>Notice</button>
      <button class="navbtn" type="button" onclick="location.href='mypage.html'"><strong>マイページ</strong>My</button>
    </div>
  </nav>

  <script>
    // 方針：
    // - teachings_unified.json の ts を「エテルナリア歴の ISO 風文字列」としてそのまま表示
    // - 並びは JSON 配列順で固定
    // - 変換やジッター、曜日生成等は一切行わない

    const state = {
      items: [],
      filtered: [],
      activeIndex: -1,
    };

    const els = {
      rooms: document.getElementById('rooms'),
      q: document.getElementById('q'),
      roomTitle: document.getElementById('roomTitle'),
      roomSummary: document.getElementById('roomSummary'),
      threadBody: document.getElementById('threadBody'),
      count: document.getElementById('count'),
    };

    // 安全にテキストノードを生成
    function textNode(str) { return document.createTextNode(str ?? ''); }

    function initials(name) {
      if (!name) return '—';
      // 日本語名・英名どちらでも、最初の2文字程度を丸アイコンに
      return [...name].slice(0,2).join('');
    }

    function createRoomItem(item, idx) {
      const btn = document.createElement('button');
      btn.type = 'button';
      btn.className = 'room-item';
      btn.setAttribute('data-index', idx);

      const av = document.createElement('div');
      av.className = 'avatar';
      av.appendChild(textNode(initials(item.name)));

      const main = document.createElement('div');
      main.className = 'room-main';

      const name = document.createElement('div');
      name.className = 'room-name';
      name.appendChild(textNode(item.name ?? '（無題）'));

      const meta = document.createElement('div');
      meta.className = 'room-meta';
      const chip = document.createElement('span');
      chip.className = 'chip';
      chip.appendChild(textNode(item.role ?? ''));
      meta.appendChild(chip);
      if (item.summary) {
        meta.appendChild(textNode('　'));
        meta.appendChild(textNode(item.summary));
      }

      main.appendChild(name);
      main.appendChild(meta);

      btn.appendChild(av);
      btn.appendChild(main);

      btn.addEventListener('click', () => {
        setActive(idx);
      });

      return btn;
    }

    function renderRooms() {
      els.rooms.innerHTML = '';
      state.filtered.forEach((item, i) => {
        const realIndex = state.items.indexOf(item);
        const node = createRoomItem(item, realIndex);
        if (realIndex === state.activeIndex) node.classList.add('active');
        els.rooms.appendChild(node);
      });
    }

    function renderThread(item) {
      els.threadBody.innerHTML = '';
      if (!item) {
        const div = document.createElement('div');
        div.className = 'empty';
        div.appendChild(textNode('左の一覧からルームを選んでください。'));
        els.threadBody.appendChild(div);
        els.roomTitle.textContent = 'ルームを選択';
        els.roomSummary.textContent = '';
        els.count.textContent = '';
        return;
      }
      els.roomTitle.textContent = item.name ?? '（無題）';
      els.roomSummary.textContent = item.summary ?? '';
      els.count.textContent = `${item.messages?.length ?? 0} 件`;

      // ルーム内メッセージは JSON 配列順のまま
      let lastDate = '';
      for (const m of (item.messages ?? [])) {
        // ts は文字列のまま扱う（Date 変換しない）
        const ts = m.ts ?? '';
        const datePart = (ts.split('T')[0] || '').trim(); // YYYY-MM-DD（エテルナリア歴の文字列）
        if (datePart && datePart !== lastDate) {
          const sec = document.createElement('div');
          sec.className = 'section-date';
          const span = document.createElement('span');
          span.appendChild(textNode(datePart));
          sec.appendChild(span);
          els.threadBody.appendChild(sec);
          lastDate = datePart;
        }

        const row = document.createElement('div');
        row.className = 'msg';

        const av = document.createElement('div');
        av.className = 'avatar';
        av.appendChild(textNode(initials(m.speaker || '—')));

        const right = document.createElement('div');

        const bubble = document.createElement('div');
        bubble.className = 'bubble' + ((m.speaker || '').match(/^(ライラ|Laila)/) ? ' system' : '');
        // テキストは安全に挿入（改行維持）
        // すでに CSS の white-space: pre-wrap を指定しているため、そのまま textContent でOK
        bubble.textContent = m.text ?? '';

        const meta = document.createElement('div');
        meta.className = 'meta-line';
        const sp = document.createElement('span');
        sp.className = 'speaker';
        sp.appendChild(textNode(m.speaker ?? '—'));
        const tsSpan = document.createElement('span');
        tsSpan.className = 'ts';
        tsSpan.appendChild(textNode(ts));
        meta.appendChild(sp);
        meta.appendChild(textNode('・'));
        meta.appendChild(tsSpan);

        right.appendChild(bubble);
        right.appendChild(meta);

        row.appendChild(av);
        row.appendChild(right);

        els.threadBody.appendChild(row);
      }

      if (!item.messages || item.messages.length === 0) {
        const div = document.createElement('div');
        div.className = 'empty';
        div.appendChild(textNode('このルームにはメッセージがありません。'));
        els.threadBody.appendChild(div);
      }
    }

    function setActive(index) {
      state.activeIndex = index;
      renderRooms();
      renderThread(state.items[index]);
    }

    function applyFilter() {
      const q = (els.q.value || '').trim();
      if (!q) {
        state.filtered = [...state.items];
      } else {
        state.filtered = state.items.filter(it => {
          const hay = `${it.name ?? ''} ${it.role ?? ''} ${it.summary ?? ''}`.toLowerCase();
          return hay.includes(q.toLowerCase());
        });
      }
      // アクティブがフィルタで消えた場合は解除
      if (state.activeIndex >= 0 && !state.filtered.includes(state.items[state.activeIndex])) {
        state.activeIndex = -1;
      }
      renderRooms();
      renderThread(state.items[state.activeIndex]);
    }

    async function boot() {
      try {
        const res = await fetch('./teachings_unified.json', { cache: 'no-store' });
        if (!res.ok) throw new Error('teachings_unified.json の取得に失敗しました');
        const json = await res.json();

        // 期待構造：{ version, items: [ { id, name, role, summary, page, messages:[{speaker,text,ts}], meta }, ... ] }
        state.items = Array.isArray(json.items) ? json.items : [];
        state.filtered = [...state.items];

        renderRooms();

        // 初期選択：最初の要素
        if (state.items.length > 0) {
          setActive(0);
        } else {
          renderThread(null);
        }

        els.q.addEventListener('input', applyFilter);
      } catch (err) {
        console.error(err);
        els.threadBody.innerHTML = '';
        const div = document.createElement('div');
        div.className = 'empty';
        div.appendChild(textNode('データの読み込みに失敗しました。teachings_unified.json を確認してください。'));
        els.threadBody.appendChild(div);
      }
    }

    boot();
  </script>
</body>
</html>

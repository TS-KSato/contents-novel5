<!doctype html>
<html lang="ja">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1, viewport-fit=cover" />
  <title>聖竜教の教え｜相談部屋</title>
  <meta name="description" content="古老ライラがエテルナリアの来訪者に応じて語る対話記録。">
  <style>
    :root{
      --bg:#0b0d12; --ink:#ffffff; --muted:#aeb7d0; --line:#27304a; --card:#151826;
      --accent:#9fd3ff; --accent-2:#1a3358; --accent-2-b:#34507c;
      --radius:.875rem; --pad:1rem; --gap:.75rem; --tap:2.75rem;
      --success:#6bd8a6; --warning:#ffd27e;
    }
    *{ box-sizing: border-box }
    html{ font-size:16px }
    body{ margin:0; background:var(--bg); color:var(--ink); font-family: system-ui, -apple-system, "Segoe UI", Roboto, "Hiragino Kaku Gothic ProN", "Yu Gothic", "Noto Sans JP", "Meiryo", sans-serif; line-height:1.75 }
    a{ color:inherit; text-decoration:none; -webkit-tap-highlight-color:transparent }
    .wrap{ max-width:40rem; margin:0 auto; padding:var(--pad) }
    header.appbar{ position:sticky; top:0; z-index:10; background:#10162a; border-bottom:1px solid var(--line); backdrop-filter: blur(8px) }
    .appbar .inner{ display:flex; align-items:center; gap:.75rem; padding:.75rem var(--pad) }
    .appbar .avatar{ width:36px; height:36px; border-radius:50%; display:grid; place-items:center; background:linear-gradient(135deg,#1a3358 0%, #0f1a34 100%); color:#cfe1ff; font-weight:700; border:1px solid var(--line) }
    .appbar h1{ margin:0; font-size:1rem; letter-spacing:.02em }
    .appbar .sub{ display:block; color:var(--muted); font-size:.78rem }
    .grid{ display:grid; grid-template-columns:1fr; gap:var(--gap) }
    .card{ background:var(--card); border:1px solid var(--line); border-radius:var(--radius); padding:var(--pad) }
    .search{ display:flex; gap:.5rem; align-items:center; border:1px solid var(--line); background:#10162a; border-radius:.675rem; padding:.5rem .75rem }
    .search input{ flex:1; border:0; background:transparent; color:var(--ink); outline:none; font-size:.95rem }

    /* Old block to be replaced programmatically; leave placeholders */
    
    .rooms{ display:grid; gap:.5rem; max-height:45vh; overflow:auto }
    .room-item{
      display:flex; gap:.75rem; align-items:center; width:100%;
      background:#0f162b; border:1px solid var(--line); border-radius:.75rem;
      padding:.625rem .875rem; position:relative;
      transition:background .2s ease,border-color .2s ease, box-shadow .2s ease;
    }
    .room-item:hover{ background:#14203a; border-color:#34507c }
    .room-item:focus-visible{ outline:2px solid var(--accent); outline-offset:2px }
    .room-item.active{ background:#16233c; border-color:#3a4b78; }

    .r-name{
      font-weight:800; font-size:1.05rem; letter-spacing:.01em; line-height:1.25;
      color:#ffffff; overflow:hidden; text-overflow:ellipsis; white-space:nowrap;
    }
    .r-meta{ color:var(--muted); font-size:.84rem; margin-top:.125rem; overflow:hidden; text-overflow:ellipsis; white-space:nowrap }
    

    .thread{ display:grid; gap:.75rem }
    .section-date{ text-align:center; color:#c0cbed; font-size:.78rem }
    .msg{ max-width:78%; background:#121829; border:1px solid var(--line); border-radius:.75rem; padding:.5rem .75rem }
    .msg .who{ font-weight:700; font-size:.85rem }
    .msg .text{ white-space:pre-wrap; word-break:break-word }
    .msg .meta{ color:var(--muted); font-size:.75rem; margin-top:.25rem }
    .msg.laila{ margin-left:auto; background:#16233c; border-color:#2f3b63 }
    .empty{ text-align:center; color:var(--muted); padding:1.25rem }
    .bottom-nav{ position:fixed; left:0; right:0; bottom:0; z-index:999; background:rgba(15,22,40,.85); backdrop-filter:blur(8px); border-top:1px solid var(--line) }
    .bn-grid{ max-width:40rem; margin:0 auto; display:grid; grid-template-columns:repeat(3,1fr); }
    .bn-btn{ appearance:none; background:none; border:0; color:#aeb7d0; display:flex; flex-direction:column; align-items:center; justify-content:center; padding:.375rem 0; min-height:3.25rem; font-size:.75rem }
    .bn-btn:focus-visible{ outline:2px solid var(--accent); outline-offset:2px }
    .bn-icon{ width:20px; height:20px; margin-bottom:.125rem; border:1px solid var(--line); border-radius:4px; display:inline-grid; place-items:center }
    .bn-accent{ color:#fff }
    footer{ height:3.5rem }
    @media (max-width: 820px){ .grid{ grid-template-columns:1fr } .rooms{ max-height:32vh } }
  
@media (prefers-contrast: more){
  .r-name{ color:#ffffff }
  .room-item{ border-color:#3f4b78 }
  .room-item.active{ box-shadow: inset 4px 0 0 0 var(--accent) }
}
  </style>

</head>
<body>
  <header class="appbar">
    <div class="inner">
      <div class="avatar">教</div>
      <div>
        <h1>聖竜教の教え</h1>
        <span class="sub">エルフの古老ライラの相談部屋</span>
      </div>
    </div>
  </header>

  <main class="wrap">
    <div class="grid">
      <section class="card">
        <div class="search">
          <svg width="18" height="18" viewBox="0 0 24 24" aria-hidden="true"><path fill="currentColor" d="M15.5 14h-.79l-.28-.27a6.471 6.471 0 0 0 1.57-4.23A6.5 6.5 0 1 0 9.5 15a6.471 6.471 0 0 0 4.23-1.57l.27.28v.79l5 5l1.5-1.5l-5-5zm-6 0C7.01 14 5 11.99 5 9.5S7.01 5 9.5 5S14 7.01 14 9.5S11.99 14 9.5 14"/></svg>
          <input id="q" type="search" placeholder="キャラ・要約で絞り込み" aria-label="検索">
        </div>
      </section>

      <section class="card">
        <div id="rooms" class="rooms" aria-label="ルーム一覧"></div>
      </section>

      <section class="card">
        <div id="thread" class="thread">
          <div class="empty">左の一覧からルームを選んでください。</div>
        </div>
      </section>
    </div>
  </main>

  <nav class="bottom-nav" aria-label="主要ナビゲーション">
    <div class="bn-grid">
      <a class="bn-btn" href="index.html"><span class="bn-icon">🏠</span><span>ホーム</span></a>
      <a class="bn-btn" href="notice.html"><span class="bn-icon">📰</span><span>お知らせ</span></a>
      <a class="bn-btn" href="mypage.html"><span class="bn-icon">👤</span><span>マイページ</span></a>
    </div>
  </nav>

  <script>
    const $ = sel => document.querySelector(sel);
    function getDisplayName(name){ if(!name) return "（無名）"; if(typeof name==="string") return name; return name.display||name.short||"（無名）"; }
    const state = { items:[], filtered:[], activeIndex:-1 };
    function renderRooms(){
      const el=$("#rooms"); el.innerHTML="";
      state.filtered.forEach((it,idx)=>{
        const b=document.createElement("button"); b.type="button"; b.className="room-item"; b.addEventListener("click",()=>setActive(idx));
        const info=document.createElement("div");
        const n=document.createElement("div"); n.className="r-name"; n.textContent=getDisplayName(it.name);
        const m=document.createElement("div"); m.className="r-meta"; m.textContent=it.summary||"";
        info.appendChild(n); info.appendChild(m); b.appendChild(info);
        if(idx===state.activeIndex) b.classList.add("active"); el.appendChild(b);
      });
    }
    function renderThread(it){
      const el=$("#thread"); el.innerHTML="";
      if(!it){ const d=document.createElement("div"); d.className="empty"; d.textContent="左の一覧からルームを選んでください。"; el.appendChild(d); return; }
      let last=""; (it.messages||[]).forEach(msg=>{
        const ts=msg.ts||"", date=ts.split("T")[0]||"";
        if(date && date!==last){ const s=document.createElement("div"); s.className="section-date"; s.textContent=date; el.appendChild(s); last=date; }
        const row=document.createElement("div"); row.className="msg"+((msg.speaker||'').startsWith("ライラ")?" laila":"");
        const who=document.createElement("div"); who.className="who"; who.textContent=msg.speaker||"—";
        const body=document.createElement("div"); body.className="text"; body.textContent=msg.text||"";
        const meta=document.createElement("div"); meta.className="meta"; meta.textContent=ts;
        row.appendChild(who); row.appendChild(body); row.appendChild(meta); el.appendChild(row);
      });
      if(!it.messages || !it.messages.length){ const d=document.createElement("div"); d.className="empty"; d.textContent="このルームにはメッセージがありません。"; el.appendChild(d); }
    }
    function setActive(i){ state.activeIndex=i; renderRooms(); renderThread(state.filtered[i]); }
    $("#q").addEventListener("input", ()=>{
      const q=($("#q").value||"").trim().toLowerCase();
      state.filtered = !q ? [...state.items] : state.items.filter(it=>{
        const hay=`${getDisplayName(it.name)} ${it.role||""} ${it.summary||""}`.toLowerCase();
        return hay.includes(q);
      });
      if(state.activeIndex>=0 && !state.filtered.includes(state.items[state.activeIndex])) state.activeIndex=-1;
      renderRooms(); renderThread(state.filtered[state.activeIndex]);
    });
    (async()=>{
      try{
        const res=await fetch("./teachings_unified.json",{cache:"no-store"});
        if(!res.ok) throw 0; const json=await res.json();
        state.items=Array.isArray(json.items)?json.items:[]; state.filtered=[...state.items];
        renderRooms(); if(state.items.length) setActive(0); else renderThread(null);
      }catch(e){
        const el=$("#thread"); el.innerHTML=""; const div=document.createElement("div"); div.className="empty"; div.textContent="データの読み込みに失敗しました。teachings_unified.json を確認してください。"; el.appendChild(div);
      }
    })();
    (function(){
      var path = location.pathname.split('/').pop() || 'index.html';
      document.querySelectorAll('.bottom-nav a').forEach(function(a){
        var href = a.getAttribute('href') || '';
        if (href.endsWith(path)) { a.classList.add('bn-accent'); a.setAttribute('aria-current','page'); }
        else { a.classList.remove('bn-accent'); a.removeAttribute('aria-current'); }
      });
    })();
  </script>
</body>
</html>

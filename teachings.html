<!doctype html>
<html lang="ja">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1, viewport-fit=cover" />
  <title>聖竜教の教え｜相談部屋</title>
  <meta name="description" content="古老ライラがエテルナリアの来訪者に応じて語る対話記録。">
  <style>
    /* ===== Brand tokens (match index.html) ===== */
    :root{
      --bg:#0b0d12; --ink:#ffffff; --muted:#aeb7d0; --line:#27304a; --card:#151826;
      --accent:#9fd3ff; --accent-2:#1a3358; --accent-2-b:#34507c;
      --radius:.875rem; --pad:1rem; --gap:.75rem; --tap:2.75rem;
      --success:#6bd8a6; --warning:#ffd27e;
    }

    *{ box-sizing: border-box }
    html{ font-size:16px }
    body{
      margin:0; background:var(--bg); color:var(--ink);
      font-family: system-ui, -apple-system, "Segoe UI", Roboto, "Hiragino Kaku Gothic ProN", "Yu Gothic", "Noto Sans JP", "Meiryo", sans-serif;
      line-height:1.75; text-rendering:optimizeLegibility;
    }
    a{ color:inherit; text-decoration:none; -webkit-tap-highlight-color:transparent }

    .wrap{ max-width:40rem; margin:0 auto; padding:var(--pad) }

    /* ===== App bar (card-like like index tiles) ===== */
    header.appbar{
      position:sticky; top:0; z-index:10;
      background:#10162a; border-bottom:1px solid var(--line);
      backdrop-filter: blur(8px);
    }
    .appbar .inner{ display:flex; align-items:center; gap:.75rem; padding:.75rem var(--pad) }
    .appbar .avatar{
      width:36px; height:36px; border-radius:50%; display:grid; place-items:center;
      background:linear-gradient(135deg,#1a3358 0%, #0f1a34 100%); color:#cfe1ff; font-weight:700;
      border:1px solid var(--line);
    }
    .appbar h1{ margin:0; font-size:1rem; letter-spacing:.02em }
    .appbar .sub{ display:block; color:var(--muted); font-size:.78rem }

    /* ===== Room list / thread ===== */
    .grid{ display:grid; grid-template-columns:1fr; gap:var(--gap) }
    .card{ background:var(--card); border:1px solid var(--line); border-radius:var(--radius); padding:var(--pad) }

    .search{
      display:flex; gap:.5rem; align-items:center; border:1px solid var(--line);
      background:#10162a; border-radius:.675rem; padding:.5rem .75rem;
    }
    .search input{ flex:1; border:0; background:transparent; color:var(--ink); outline:none; font-size:.95rem }

    .rooms{ display:grid; gap:.5rem; max-height:45vh; overflow:auto }
    .room-item{ display:flex; gap:.75rem; align-items:center; width:100%; background:#11172a; border:1px solid var(--line); border-radius:.75rem; padding:.5rem .75rem; }
    .room-item:hover{ background:#15203a }
    .room-item.active{ outline:2px solid var(--accent-2-b) }
    .r-name{ font-weight:700 }
    .r-meta{ color:var(--muted); font-size:.82rem }

    .thread{ display:grid; gap:.75rem }
    .section-date{ text-align:center; color:#c0cbed; font-size:.78rem }
    .msg{ max-width:78%; background:#121829; border:1px solid var(--line); border-radius:.75rem; padding:.5rem .75rem }
    .msg .who{ font-weight:700; font-size:.85rem }
    .msg .text{ white-space:pre-wrap; word-break:break-word }
    .msg .meta{ color:var(--muted); font-size:.75rem; margin-top:.25rem }
    .msg.laila{ margin-left:auto; background:#16233c; border-color:#2f3b63 }
    .empty{ text-align:center; color:var(--muted); padding:1.25rem }

    /* ===== Bottom nav (exact class names as index) ===== */
    .bottom-nav{ position:fixed; left:0; right:0; bottom:0; z-index:999;
      background:rgba(15,22,40,.85); backdrop-filter:blur(8px); border-top:1px solid var(--line) }
    .bn-grid{ max-width:40rem; margin:0 auto; display:grid; grid-template-columns:repeat(3,1fr); }
    .bn-btn{ appearance:none; background:none; border:0; color:#aeb7d0; text-decoration:none;
      display:flex; flex-direction:column; align-items:center; justify-content:center;
      padding:.375rem 0; min-height:3.25rem; font-size:.75rem }
    .bn-btn:focus-visible{ outline:2px solid var(--accent); outline-offset:2px }
    .bn-icon{ width:20px; height:20px; margin-bottom:.125rem; border:1px solid var(--line); border-radius:4px; display:inline-grid; place-items:center }
    .bn-accent{ color:#fff }
    footer{ height:3.5rem } /* spacer for bottom-nav */

    @media (max-width: 820px){
      .grid{ grid-template-columns:1fr }
      .rooms{ max-height:32vh }
    }
  </style>
</head>
<body>
  <header class="appbar">
    <div class="inner">
      <div class="avatar">教</div>
      <div>
        <h1>聖竜教の教え</h1>
        <span class="sub">最古の賢人ライラが聖竜教の教えから説く</span>
      </div>
    </div>
  </header>

  <main class="wrap">
    <div class="grid">
      <section class="card">
        <div class="search">
          <svg width="18" height="18" viewBox="0 0 24 24" aria-hidden="true"><path fill="currentColor" d="M15.5 14h-.79l-.28-.27a6.471 6.471 0 0 0 1.57-4.23A6.5 6.5 0 1 0 9.5 15a6.471 6.471 0 0 0 4.23-1.57l.27.28v.79l5 5l1.5-1.5l-5-5zm-6 0C7.01 14 5 11.99 5 9.5S7.01 5 9.5 5S14 7.01 14 9.5S11.99 14 9.5 14"/></svg>
          <input id="q" type="search" placeholder="キャラ・要約で絞り込み" aria-label="検索">
        </div>
      </section>

      <section class="card">
        <div id="rooms" class="rooms" aria-label="ルーム一覧"></div>
      </section>

      <section class="card">
        <div id="thread" class="thread">
          <div class="empty">左の一覧からルームを選んでください。</div>
        </div>
      </section>
    </div>
  </main>

  <!-- Bottom nav: follow index.html structure/classes -->
  <nav class="bottom-nav" aria-label="主要ナビゲーション">
    <div class="bn-grid">
      <a class="bn-btn" href="index.html">
        <span class="bn-icon">🏠</span>
        <span>ホーム</span>
      </a>
      <a class="bn-btn" href="notice.html">
        <span class="bn-icon">📰</span>
        <span>お知らせ</span>
      </a>
      <a class="bn-btn" href="mypage.html">
        <span class="bn-icon">👤</span>
        <span>マイページ</span>
      </a>
    </div>
  </nav>

  <script>
    // ===== Utilities =====
    const $ = sel => document.querySelector(sel);
    const $$ = sel => Array.from(document.querySelectorAll(sel));

    function safe(txt){ return txt ?? "" }
    function text(node, s){ node.textContent = s }

    function getDisplayName(nameField){
      // name can be string or object {display,...}
      if (!nameField) return "（無名）";
      if (typeof nameField === "string") return nameField;
      return nameField.display || nameField.short || "（無名）";
    }

    // ===== Rendering =====
    const state = { items: [], filtered: [], activeIndex: -1 };

    function renderRooms(){
      const $rooms = $("#rooms");
      $rooms.innerHTML = "";
      state.filtered.forEach((item, idx) => {
        const btn = document.createElement("button");
        btn.type = "button";
        btn.className = "room-item";
        btn.addEventListener("click", ()=> setActive(idx));

        const info = document.createElement("div");
        const n = document.createElement("div");
        n.className = "r-name";
        n.textContent = getDisplayName(item.name);
        const m = document.createElement("div");
        m.className = "r-meta";
        m.textContent = safe(item.summary || "");
        info.appendChild(n); info.appendChild(m);

        btn.appendChild(info);
        if (idx === state.activeIndex) btn.classList.add("active");
        $rooms.appendChild(btn);
      });
    }

    function renderThread(item){
      const $t = $("#thread");
      $t.innerHTML = "";
      if (!item){
        const div = document.createElement("div");
        div.className = "empty";
        div.textContent = "左の一覧からルームを選んでください。";
        $t.appendChild(div);
        return;
      }
      // Header-like line could be added if needed
      let lastDate = "";
      (item.messages || []).forEach(msg => {
        const ts = msg.ts || "";
        const datePart = ts.split("T")[0] || "";
        if (datePart && datePart !== lastDate){
          const d = document.createElement("div");
          d.className = "section-date";
          d.textContent = datePart;
          $t.appendChild(d);
          lastDate = datePart;
        }
        const row = document.createElement("div");
        row.className = "msg" + ((msg.speaker||"").startsWith("ライラ") ? " laila" : "");

        const who = document.createElement("div");
        who.className = "who";
        who.textContent = msg.speaker || "—";

        const body = document.createElement("div");
        body.className = "text";
        body.textContent = msg.text || "";

        const meta = document.createElement("div");
        meta.className = "meta";
        meta.textContent = ts;

        row.appendChild(who); row.appendChild(body); row.appendChild(meta);
        $t.appendChild(row);
      });

      if (!item.messages || item.messages.length === 0){
        const div = document.createElement("div");
        div.className = "empty";
        div.textContent = "このルームにはメッセージがありません。";
        $t.appendChild(div);
      }
    }

    function setActive(idx){
      state.activeIndex = idx;
      renderRooms();
      renderThread(state.filtered[idx]);
      // scroll to top of thread
      $("#thread").scrollTo?.({top:0, behavior:"smooth"});
    }

    function applyFilter(){
      const q = ($("#q").value || "").trim().toLowerCase();
      state.filtered = !q ? [...state.items] :
        state.items.filter(it => {
          const hay = `${getDisplayName(it.name)} ${it.role||""} ${it.summary||""}`.toLowerCase();
          return hay.includes(q);
        });
      // reset active if filtered out
      if (state.activeIndex >= 0 && !state.filtered.includes(state.items[state.activeIndex])){
        state.activeIndex = -1;
      }
      renderRooms();
      renderThread(state.filtered[state.activeIndex]);
    }

    async function boot(){
      try{
        const res = await fetch("./teachings_unified.json", { cache:"no-store" });
        if(!res.ok) throw new Error("teachings_unified.json の取得に失敗しました");
        const json = await res.json();
        state.items = Array.isArray(json.items) ? json.items : [];
        state.filtered = [...state.items];
        renderRooms();
        if (state.items.length) setActive(0); else renderThread(null);
        $("#q").addEventListener("input", applyFilter);
      }catch(err){
        const $t = $("#thread");
        $t.innerHTML = "";
        const div = document.createElement("div");
        div.className = "empty";
        div.textContent = "データの読み込みに失敗しました。teachings_unified.json を確認してください。";
        $t.appendChild(div);
        console.error(err);
      }
    }
    boot();

    // ===== Bottom nav current-page highlight (same behavior as index) =====
    (function(){
      var path = location.pathname.split('/').pop() || 'index.html';
      document.querySelectorAll('.bottom-nav a').forEach(function(a){
        var href = a.getAttribute('href') || '';
        if (href.endsWith(path)) {
          a.classList.add('bn-accent');
          a.setAttribute('aria-current','page');
        } else {
          a.classList.remove('bn-accent');
          a.removeAttribute('aria-current');
        }
      });
    })();
  </script>
</body>
</html>

<!DOCTYPE html>
<html lang="ja">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>再生｜運命の銀竜暦</title>
  <meta name="description" content="楽曲の詳細と再生" />
  <style>
    :root { --bg:#0d0f14; --card:#151922; --text:#e7ecf3; --muted:#9aa3b2; --acc:#6aa8ff; }
    *{box-sizing:border-box}
    body{margin:0;background:var(--bg);color:var(--text);font-family:system-ui,-apple-system,Segoe UI,Roboto,Helvetica,Arial,"Noto Sans JP","Hiragino Kaku Gothic ProN",Meiryo,sans-serif}
    header{position:sticky;top:0;background:linear-gradient(180deg,#0d0f14 70%,#0d0f1400);padding:12px 12px 0;z-index:10}
    .back{display:inline-block;padding:8px 10px;border-radius:10px;background:#1b2230;text-decoration:none;color:#cfe1ff;border:1px solid #273144}
    main.wrap{padding:14px;display:grid;gap:14px;max-width:760px;margin:0 auto 80px}
    .art{
      width:100%;aspect-ratio:1/1;border-radius:16px;
      background:linear-gradient(135deg,#2b3446,#3c5076);
      background-size:cover;background-position:center;
      display:grid;place-items:center;font-size:28px;color:#cfe1ff;overflow:hidden;user-select:none;
    }
    .art.fallback::after{content:"♪";font-weight:800}
    .title{font-weight:800;font-size:22px}
    .sub{color:var(--muted);font-size:13px}
    .player{display:grid;gap:10px;padding:12px;border-radius:14px;background:var(--card);border:1px solid #212838}
    .btns{display:flex;gap:8px}
    .btn{border:0;border-radius:10px;padding:10px 12px;background:#22324d;color:#cfe1ff;font-weight:700}
    .meta2{color:var(--muted);font-size:12px}
    nav.gnav{position:fixed;left:0;right:0;bottom:0;display:flex;gap:8px;justify-content:space-around;
      padding:10px 8px;background:#111;color:#fff;z-index:1000}
    nav.gnav a{flex:1;text-align:center;text-decoration:none;color:#fff;font-weight:700;line-height:44px;
      border-radius:10px;background:#222;outline-offset:2px}
    nav.gnav a[aria-current="page"]{background:#444}
    @media(hover:hover){nav.gnav a:hover{background:#333}}
    body{padding-bottom:72px}
  </style>
</head>
<body>
  <header>
    <a class="back" id="back" href="music.html" aria-label="一覧へ戻る">← 一覧へ</a>
  </header>

  <main class="wrap">
    <div class="art" id="art" aria-hidden="true"></div>
    <div class="title" id="title">—</div>
    <div class="sub" id="meta">—</div>

    <section class="player" aria-label="プレイヤー">
      <audio id="audio" preload="metadata" controls style="width:100%"></audio>
      <div class="btns">
        <button class="btn" type="button" id="play">再生/一時停止</button>
        <button class="btn" type="button" id="back15">⟲ 15s</button>
        <button class="btn" type="button" id="fwd15">15s ⟳</button>
      </div>
      <div class="meta2" id="extra">—</div>
    </section>
  </main>

  <nav class="gnav" role="navigation" aria-label="下部ナビ">
    <a href="index.html">ホーム</a>
    <a href="notice.html">お知らせ</a>
    <a href="mypage.html">マイページ</a>
  </nav>

<script>
  // クエリ取得
  const params = new URLSearchParams(location.search);
  const id = params.get('id');

  // util
  const sec = n => !Number.isFinite(n) ? "—" : `${Math.floor(n/60)}:${String(Math.floor(n%60)).padStart(2,'0')}`;
  const label = m => (m || "—");
  function artOf(t){
    if (t.art) return t.art;
    if (t.url && /\.mp3(?:\?.*)?$/i.test(t.url)) return t.url.replace(/\.mp3(?:\?.*)?$/i, ".jpg");
    return null;
  }

  // 要素
  const artEl   = document.getElementById('art');
  const titleEl = document.getElementById('title');
  const metaEl  = document.getElementById('meta');
  const extraEl = document.getElementById('extra');
  const audioEl = document.getElementById('audio');

  // 読み込み
  fetch('tracks.json')
    .then(r=>r.json())
    .then(list=>{
      const data = (id && list.find(t=>t.id===id)) || list[0];
      if(!data || !data.url){ throw new Error('track not found'); }

      titleEl.textContent = data.name ?? '—';
      metaEl.textContent  = [data.archetype, label(data.mood), (data.bpm?`${data.bpm} BPM`:null), sec(data.duration)]
                              .filter(Boolean).join(' ／ ');
      extraEl.textContent = data.origin ? `出自：${data.origin}` : '—';

      audioEl.src = data.url;
      audioEl.preload = 'metadata';

      const art = artOf(data);
      if (art){
        artEl.style.backgroundImage = `url('${art}')`;
        artEl.classList.remove('fallback');
        artEl.setAttribute('aria-label','アートワーク');
      } else {
        artEl.style.backgroundImage = '';
        artEl.classList.add('fallback');
        artEl.removeAttribute('aria-label');
      }
    })
    .catch(()=>{
      titleEl.textContent = 'わかりません／情報が不足しています';
      metaEl.textContent  = '';
      extraEl.textContent = '';
    });

  // コントロール
  document.getElementById('play').addEventListener('click', ()=>{
    if (audioEl.paused) audioEl.play(); else audioEl.pause();
  });
  document.getElementById('back15').addEventListener('click', ()=>{ audioEl.currentTime = Math.max(0, audioEl.currentTime - 15); });
  document.getElementById('fwd15').addEventListener('click',  ()=>{ audioEl.currentTime = Math.min((audioEl.duration||1e9), audioEl.currentTime + 15); });
</script>
</body>
</html>

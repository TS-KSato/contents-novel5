<!doctype html>
<html lang="ja">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1, viewport-fit=cover" />
  <title>聖竜教の教え｜最古の賢人ライラが語る</title>
  <meta name="description" content="この世界の宗教『聖竜教』の教えを、最古の賢人ライラが一問一答で語る。ライラ自身は信徒ではなく、長命ゆえの知見で中立に解き明かす。">
  <style>
    :root{
      --bg:#0b0d12; --ink:#ffffff; --muted:#aeb7d0; --line:#27304a; --card:#151826;
      --accent:#9fd3ff; --accent-2:#1a3358; --accent-2-b:#34507c; --pill:#11172a;
      --radius:1rem; --pad:1rem; --gap:.75rem; --tap:2.75rem;
    }
    *{ box-sizing:border-box }
    html,body{ height:100%; }
    body{ margin:0; background:var(--bg); color:var(--ink);
      font-family:system-ui,-apple-system,"Segoe UI",Roboto,"Hiragino Sans","Noto Sans JP",sans-serif;
      line-height:1.75; -webkit-text-size-adjust:100%; text-rendering:optimizeLegibility; }
    .wrap{ max-width:40rem; margin:0 auto; padding:1rem; }

    header{ text-align:center; margin-bottom:.75rem; }
    header h1{ margin:.25rem 0 0; font-size:clamp(1.25rem,6vw,1.6rem); }
    header .sub{ color:#cfe1ff; font-size:.95rem; opacity:.95; margin:.25rem 0 .5rem; }
    header .note{ color:var(--muted); font-size:.8rem; }

    .card{ background:var(--card); border:1px solid var(--line); border-radius:var(--radius); padding:var(--pad); margin:.75rem 0; }

    /* Chat */
    .chat{ display:flex; flex-direction:column; gap:.65rem; height:55vh; min-height:22rem; overflow:auto; padding:.25rem; scroll-behavior:smooth; }
    .msg{ display:flex; align-items:flex-end; gap:.5rem; }
    .msg .bubble{ max-width:75%; padding:.6rem .9rem; border-radius:1rem; line-height:1.6; font-size:.95rem; }
    .msg.user{ justify-content:flex-start; }
    .msg.user .bubble{ background:#141b30; border:1px solid #223054; border-top-left-radius:.45rem; }
    .msg.laila{ justify-content:flex-end; }
    .msg.laila .bubble{ background:#23365e; border:1px solid #2e4677; border-top-right-radius:.45rem; }
    .avatar{ width:2.2rem; height:2.2rem; border-radius:50%; border:1px solid var(--line); background:#10172a center/cover no-repeat; display:flex; align-items:center; justify-content:center; font-size:.8rem; color:#cfe1ff; flex:0 0 auto; }
    .meta{ color:var(--muted); font-size:.8rem; margin-top:.25rem; }

    /* Dynamic questions & tags */
    .toolbar{ display:flex; gap:.5rem; flex-wrap:wrap; }
    .pill{ display:inline-flex; align-items:center; gap:.35rem; border:1px solid var(--line); background:var(--pill); color:#d7e6ff; border-radius:999px; padding:.35rem .65rem; font-size:.82rem; cursor:pointer; user-select:none; }
    .pill[aria-pressed="true"]{ outline:2px solid var(--accent); }

    .qgrid{ display:grid; gap:.5rem; grid-template-columns:repeat(2,1fr); margin-top:.5rem; }
    @media (max-width:480px){ .qgrid{ grid-template-columns:1fr } }
    .qbtn{ text-align:left; border:1px solid var(--line); background:#11172a; color:#cfe1ff; border-radius:.7rem; padding:.6rem .7rem; font-size:.9rem; cursor:pointer; }
    .qbtn:hover{ background:#16203a; }

    footer{ text-align:center; color:var(--muted); font-size:.75rem; margin:1rem 0 .25rem; }
  </style>
</head>
<body>
  <div class="wrap">
    <header>
      <h1>聖竜教の教え</h1>
      <div class="sub">最古の賢人ライラが語る</div>
      <div class="note">※聖竜教が崇める聖竜は既に大地へ還った古の竜。ライラは信徒ではなく、長命ゆえの知見で中立に解き明かします。</div>
    </header>

    <!-- Chat window -->
    <section class="card" aria-label="ライラの語り">
      <div id="chat" class="chat" role="log" aria-live="polite"></div>
      <div class="meta" id="contextLine"></div>
    </section>

    <!-- Dynamic tag toolbar & question list -->
    <section class="card" aria-label="質問を選ぶ">
      <div class="toolbar" id="toolbar" role="group" aria-label="教義カテゴリ"></div>
      <div id="qgrid" class="qgrid" style="margin-top:.6rem"></div>
    </section>

    <footer>© 運命の銀竜暦 — 世界観・教義は物語世界に基づく架空設定です。</footer>
  </div>

<script>
// ===== JSON fetch (religion-only taxonomy) =====
let QA = [];
let TAGS = [];

async function loadQA(){
  const res = await fetch('./laila_teachings.json', {cache:'no-cache'});
  if(!res.ok) throw new Error('fetch failed');
  const json = await res.json();
  const arr = Array.isArray(json) ? json : (Array.isArray(json.items) ? json.items : []);
  // Normalize ids & collect tags (order of first appearance)
  const seen = new Set();
  TAGS = ['すべて'];
  QA = arr.map((x,i)=>({ id: x.id ?? i+1, ...x }));
  for(const x of QA){
    const t = String(x.tag||'その他');
    if(!seen.has(t)) { seen.add(t); TAGS.push(t); }
  }
}

// ===== Helpers =====
const $ = (s,el=document)=>el.querySelector(s);
function esc(s){ return String(s||"").replace(/[&<>]/g, m=>({'&':'&amp;','<':'&lt;','>':'&gt;'}[m])); }
function avatarText(asker){ return (asker?.race||"?").slice(0,2); }

// ===== Render =====
const chat = $('#chat');
const qgrid = $('#qgrid');
const toolbar = $('#toolbar');
const contextLine = $('#contextLine');
let currentTag = 'すべて';

function renderToolbar(){
  toolbar.innerHTML = TAGS.map((t,idx)=>`<button class="pill" data-tag="${esc(t)}" aria-pressed="${idx===0}">${esc(t)}</button>`).join('');
}

function renderQGrid(tag='すべて'){
  const list = QA.filter(x=> tag==='すべて' ? true : x.tag===tag);
  qgrid.innerHTML = list.map(x=>{
    const cap = `${x.asker.race}／${x.asker.age}・${x.asker.name}`;
    return `<button class="qbtn" data-id="${x.id}">❓ ${esc(x.q)}<div class="meta" style="margin-top:.25rem">${esc(cap)}・分類：${esc(x.tag)}</div></button>`;
  }).join('');
  contextLine.textContent = tag==='すべて' ? '質問を選ぶか、上の分類で絞り込みができます。' : `分類：${tag} — 関連する問いが並びます。`;
}

function pushUser(q, asker){
  const who = `${asker.race}／${asker.age}`;
  chat.insertAdjacentHTML('beforeend', `
    <div class="msg user">
      <div class="avatar" title="${esc(who)}">${esc(avatarText(asker))}</div>
      <div>
        <div class="bubble">${esc(q)}</div>
        <div class="meta">${esc(who)} の問い</div>
      </div>
    </div>`);
}

function pushLaila(a){
  chat.insertAdjacentHTML('beforeend', `
    <div class="msg laila">
      <div>
        <div class="bubble">${esc(a)}<div class="meta" style="margin-top:.35rem; opacity:.85">— ライラ（私は信徒ではない。だが古記と長い歳月が教えることを話そう）</div></div>
      </div>
      <div class="avatar" style="background-image:url('./assets/avatar-laila.png')" title="ライラ">ラ</div>
    </div>`);
  chat.scrollTop = chat.scrollHeight;
}

function ask(id){
  const item = QA.find(x=> String(x.id)===String(id)); if(!item) return;
  pushUser(item.q, item.asker);
  setTimeout(()=> pushLaila(item.a), 420);
}

// ===== Init =====
(async function init(){
  try{
    await loadQA();
    renderToolbar();
    renderQGrid('すべて');
    // 初回デモ
    if(QA.length) ask(QA[0].id);

    qgrid.addEventListener('click', e=>{
      const btn = e.target.closest('.qbtn'); if(!btn) return;
      ask(btn.dataset.id);
    });

    toolbar.addEventListener('click', e=>{
      const pill = e.target.closest('.pill'); if(!pill) return;
      document.querySelectorAll('.pill').forEach(p=> p.setAttribute('aria-pressed','false'));
      pill.setAttribute('aria-pressed','true');
      currentTag = pill.dataset.tag;
      renderQGrid(currentTag);
    });
  }catch(err){
    contextLine.textContent = '教えの資料を読み込めませんでした。しばらくしてから再読み込みしてください。';
    console.warn(err);
  }
})();
</script>
</body>
</html>

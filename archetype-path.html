<!DOCTYPE html>
<html lang="ja">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>é‹å‘½ã®éŠ€ç«œæš¦ï½œé­‚ã®ç¾…é‡ç›¤ï¼ˆå…ƒå‹è¨ºæ–­ï¼‹ä»Šæ—¥ã®å½¹å‰²ï¼‰</title>
  <meta name="description" content="åˆå›ã®å…ƒå‹ï¼ˆã‚¢ãƒ¼ã‚­ã‚¿ã‚¤ãƒ—ï¼‰è¨ºæ–­ã§ã‚ãªãŸã®é­‚ã®æ€§è³ªã‚’ç¢ºç«‹ã—ã€æ¯æ—¥ã®10å•ã§ä»Šæ—¥ã®ã€å½¹å‰²ï¼ˆãƒ‘ã‚¹ï¼‰ã€ã‚’æˆã‘ã¾ã™ã€‚">
  <style>
    :root{--bg:#0b0f14;--panel:#121821;--ink:#e9f1ff;--muted:#97a7c2;--line:#2a344d;--accent:#8dd0ff;--r:16px;--tap:48px}
    *{box-sizing:border-box}
    body{margin:0;background:var(--bg);color:var(--ink);font-family:system-ui,-apple-system,"Segoe UI",Roboto,"Noto Sans JP","Hiragino Kaku Gothic ProN","Yu Gothic",sans-serif;line-height:1.7}
    .wrap{max-width:760px;margin:auto;padding:16px 16px 92px}
    h1{font-size:clamp(22px,5vw,28px);margin:6px 0 8px}
    .lead{color:var(--muted);margin:0 0 12px}
    .card{background:var(--panel);border:1px solid var(--line);border-radius:var(--r);margin:12px 0;box-shadow:0 8px 24px rgba(0,0,0,.25)}
    .card-h{padding:12px 14px;font-weight:800;border-bottom:1px dashed rgba(141,208,255,.25)}
    .card-c{padding:12px 14px}
    .btn{appearance:none;border:none;cursor:pointer;width:100%;min-height:var(--tap);padding:12px;border-radius:12px;background:#17325a;border:1px solid #2e4c79;color:#fff;font-weight:800}
    .btn:hover{filter:brightness(1.05)}
    .btn.ghost{background:#121829}
    .grid2{display:grid;grid-template-columns:1fr;gap:10px}
    @media(min-width:640px){.grid2{grid-template-columns:1fr 1fr}}

    .q{margin:10px 0}
    .q .t{font-weight:700}

    /* 2æŠã‚¹ã‚¤ãƒƒãƒ */
    .toggle{display:grid;grid-template-columns:1fr auto 1fr;align-items:center;gap:8px;margin-top:8px}
    .toggle .opt{display:block;text-align:center;font-size:14px;color:#cfe1ff}
    .switch{position:relative;width:66px;height:34px;background:#0f1626;border:1px solid var(--line);border-radius:999px;cursor:pointer}
    .switch input{display:none}
    .knob{position:absolute;top:2px;left:2px;width:28px;height:28px;border-radius:50%;background:#2b446d;transition:transform .2s}
    .switch input:checked + .knob{transform:translateX(32px)}

    /* ã‚¢ãƒã‚¿ãƒ¼ï¼ˆã‚­ãƒ£ãƒ©ã‚¢ã‚¤ã‚³ãƒ³ï¼‰ */
    .avatar{width:48px;height:48px;border-radius:50%;display:inline-grid;place-items:center;font-weight:800;color:#0b0f14}
    .av-alan{background:linear-gradient(135deg,#a8d8ff,#e6f3ff)}
    .av-drake{background:linear-gradient(135deg,#ff9a9e,#fecfef)}
    .av-nester{background:linear-gradient(135deg,#c2ffd8,#465efb)}
    .av-lilia{background:linear-gradient(135deg,#f6d365,#fda085)}
    .av-laila{background:linear-gradient(135deg,#d4c5ff,#8fb4ff)}

    .pill{display:inline-flex;gap:6px;align-items:center;padding:6px 10px;border-radius:999px;background:rgba(141,208,255,.12);border:1px solid rgba(141,208,255,.25)}

    .result{animation:fade .6s ease both}
    @keyframes fade{from{opacity:0;transform:translateY(8px)}to{opacity:1;transform:none}}

    .bottom-nav{position:fixed;left:0;right:0;bottom:0;background:#121821;border-top:1px solid rgba(141,208,255,.25)}
    .bn-grid{display:grid;grid-template-columns:repeat(3,1fr);max-width:40rem;margin:0 auto}
    .bn-btn{display:flex;flex-direction:column;align-items:center;gap:2px;padding:10px 0;color:var(--ink);text-decoration:none;font-size:14px}
    .bn-accent{background:rgba(141,208,255,.15)}

    .note{font-size:13px;color:var(--muted)}
    details.help{background:rgba(141,208,255,.06);border:1px solid rgba(141,208,255,.18);border-radius:12px;padding:10px 12px}
    details.help summary{cursor:pointer;font-weight:700}
    details.help + details.help{margin-top:8px}
  </style>
</head>
<body>
  <main class="wrap">
    <header>
      <h1>é­‚ã®ç¾…é‡ç›¤</h1>
      <p class="lead">ã€Œãƒ«ãƒŠãƒ«ã®æ•™ãˆã‚’å—ã‘ç¶™ã„ã æ–°æ™‚ä»£ã®æ‹…ã„æ‰‹ã€ã¨ã—ã¦ã€<strong>åˆå›ã¯å…ƒå‹ï¼ˆã‚¢ãƒ¼ã‚­ã‚¿ã‚¤ãƒ—ï¼‰</strong>ã‚’ç¢ºç«‹ã—ã€<strong>ä»¥å¾Œã¯æ¯æ—¥ã®10å•</strong>ã§ä»Šæ—¥ã®å½¹å‰²ï¼ˆãƒ‘ã‚¹ï¼‰ã‚’æˆã‹ã‚Šã¾ã™ã€‚</p>
      <details class="help"><summary>ä¸–ç•Œè¦³ãŒã‚ã‹ã‚‰ãªã„æ–¹ã¸</summary>
        <p class="note">ã“ã®ä½œå“ã§ã¯ã€éŠ€è‰²ã®å¤ä»£ç«œã€Œãƒ«ãƒŠãƒ«ã€ã®æ•™ãˆã‚’äººã€…ãŒå—ã‘ç¶™ãæ™‚ä»£ãŒèˆå°ã§ã™ã€‚<br>å…ƒå‹ï¼ã‚ãªãŸã®â€œç‰©èªä¸Šã®æ€§è³ªâ€ã€å½¹å‰²ï¼ˆãƒ‘ã‚¹ï¼‰ï¼â€œä»Šæ—¥ã®æ­©ãæ–¹â€ã€‚é›£ã—ãè€ƒãˆãšã€ç›´æ„Ÿã§é¸ã‚“ã§ãã ã•ã„ã€‚</p>
        <ul class="note" style="margin:.25rem 0 0 1rem">
          <li><strong>ã‚¢ãƒ©ãƒ³</strong>ï¼šäºŒã¤ã®ä¸–ç•Œã®æ¶ã‘æ©‹</li>
          <li><strong>ãƒ‰ãƒ¬ã‚¤ã‚¯</strong>ï¼šä»²é–“ã‚’å®ˆã‚‹å‹‡è€…</li>
          <li><strong>ãƒã‚¹ã‚¿ãƒ¼</strong>ï¼šé¢¨ã‚’èª­ã‚€è¦³å¯Ÿè€…</li>
          <li><strong>ãƒªãƒªã‚¢</strong>ï¼šè‡ªç”±ã«èˆã†ç²¾éœŠ</li>
          <li><strong>ãƒ©ã‚¤ãƒ©</strong>ï¼šå¤ãçŸ¥ã®èªã‚Šéƒ¨</li>
        </ul>
      </details>
    </header>

    <!-- Phase 1: å…ƒå‹è¨ºæ–­ï¼ˆåˆå›ã®ã¿è¡¨ç¤ºï¼‰ -->
    <section id="phase1" class="card" aria-labelledby="p1h" hidden>
      <div id="p1h" class="card-h">Phase 1ï¼šé­‚ã®å…±é³´è¨ºæ–­ï¼ˆåˆå›ï¼‰</div>
      <div class="card-c">
        <p class="note">ç›´æ„Ÿã§4å•ã«ãŠç­”ãˆãã ã•ã„ã€‚çµæœã¯ã€Œã‚¢ãƒ©ãƒ³ï¼ãƒ‰ãƒ¬ã‚¤ã‚¯ï¼ãƒã‚¹ã‚¿ãƒ¼ï¼ãƒªãƒªã‚¢ï¼ãƒ©ã‚¤ãƒ©ã€ã®ã„ãšã‚Œã‹ã«ãªã‚Šã¾ã™ã€‚</p>

        <div class="q">
          <div class="t">Q1. äºŒã¤ã®ä¾¡å€¤ãŒå¯¾ç«‹ã™ã‚‹ã¨ãã€ã‚ãªãŸã¯ä½•ã‚’å„ªå…ˆã—ã¾ã™ã‹ï¼Ÿ</div>
          <div class="toggle" data-axis="logic">
            <span class="opt">èª¿å’Œ</span>
            <label class="switch"><input type="checkbox"><span class="knob"></span></label>
            <span class="opt">æ­£ã—ã•</span>
          </div>
        </div>
        <div class="q">
          <div class="t">Q2. é€²ã‚€ã¹ãé“ã‚’æ±ºã‚ã‚‹ã¨ãã€ã‚ãªãŸã¯ï¼Ÿ</div>
          <div class="toggle" data-axis="spirit">
            <span class="opt">é¢¨ã®å›ã</span>
            <label class="switch"><input type="checkbox"><span class="knob"></span></label>
            <span class="opt">å¤åœ°å›³</span>
          </div>
        </div>
        <div class="q">
          <div class="t">Q3. é¸ã³ã‚„ã™ã„è¡Œå‹•ã¯ï¼Ÿ</div>
          <div class="toggle" data-axis="vector">
            <span class="opt">å†…çœ</span>
            <label class="switch"><input type="checkbox"><span class="knob"></span></label>
            <span class="opt">è¡Œå‹•</span>
          </div>
        </div>
        <div class="q">
          <div class="t">Q4. äººã¨ã®è·é›¢æ„Ÿã¯ï¼Ÿ</div>
          <div class="toggle" data-axis="social">
            <span class="opt">ç‹¬ã‚Šã§æ•´ãˆã‚‹</span>
            <label class="switch"><input type="checkbox"><span class="knob"></span></label>
            <span class="opt">ä»²é–“ã¨å‹•ã</span>
          </div>
        </div>

        <div class="grid2" style="margin-top:10px">
          <button id="btnP1" class="btn">å…ƒå‹ã‚’ç¢ºå®šã™ã‚‹</button>
          <button id="btnP1Reset" class="btn ghost" type="button">å…¥åŠ›ã‚’ã‚¯ãƒªã‚¢</button>
        </div>
        <p class="note">â€» å…ƒå‹ã¯ <code>localStorage.userArchetype</code> ã«ä¿å­˜ã•ã‚Œã¾ã™ï¼ˆç«¯æœ«ãƒ­ãƒ¼ã‚«ãƒ«ï¼‰ã€‚</p>
      </div>
    </section>

    <!-- Phase 1 çµæœï¼ˆç¢ºå®šå¾Œå¸¸ã«è¡¨ç¤ºï¼‰ -->
    <section id="archetypeBox" class="card result" aria-live="polite" hidden>
      <div class="card-h">ã‚ãªãŸã®å…ƒå‹ï¼ˆã‚¢ãƒ¼ã‚­ã‚¿ã‚¤ãƒ—ï¼‰</div>
      <div class="card-c" id="archText"></div>
    </section>

    <!-- Phase 2: æ¯æ—¥ã®10å•ï¼ˆ2æŠUIï¼‰ â†’ å½¹å‰²æ±ºå®š -->
    <section id="phase2" class="card" aria-labelledby="p2h" hidden>
      <div id="p2h" class="card-h">Phase 2ï¼šé­‚ã¸ã®åã®è³ªå•ï¼ˆä»Šæ—¥ã®å½¹å‰²ã‚’æ±ºã‚ã‚‹ï¼‰</div>
      <div class="card-c" id="qList"></div>
      <div class="card-c">
        <div class="grid2">
          <button id="btnEval" class="btn">ä»Šæ—¥ã®å½¹å‰²ï¼ˆãƒ‘ã‚¹ï¼‰ã‚’æˆã‹ã‚‹</button>
          <button id="btnClearQ" class="btn ghost" type="button">å›ç­”ã‚¯ãƒªã‚¢</button>
        </div>
        <p class="note" style="margin-top:6px">â€» 2æŠã§è¿·ã£ãŸã‚‰ã€Œç›´æ„Ÿã€ã‚’å„ªå…ˆã—ã¦ãã ã•ã„ã€‚æ—¥ã€…ã®å›ç­”ã¯ä¿å­˜ã—ã¾ã›ã‚“ã€‚</p>
      </div>
    </section>

    <!-- Phase 3+4: å½¹å‰²ï¼‹ç¥è¨— -->
    <section id="resultBox" class="card result" hidden>
      <div class="card-h">ä»Šæ—¥ã®æˆä¸ï¼šå½¹å‰²ï¼ˆãƒ‘ã‚¹ï¼‰ã¨éŠ€ç«œã®è¨€è‘‰</div>
      <div class="card-c" id="roleText"></div>
    </section>
  </main>

  <!-- Bottom Nav (3 tabs) -->
  <nav class="bottom-nav" aria-label="ä¸»è¦ãƒŠãƒ“ã‚²ãƒ¼ã‚·ãƒ§ãƒ³">
    <div class="bn-grid">
      <a class="bn-btn" href="./index.html">ğŸ  ãƒ›ãƒ¼ãƒ </a>
      <a class="bn-btn" href="./notice.html">ğŸ“£ ãŠçŸ¥ã‚‰ã›</a>
      <a class="bn-btn" href="./mypage.html">ğŸ‘¤ ãƒã‚¤ãƒšãƒ¼ã‚¸</a>
    </div>
  </nav>

<script>
// ========== ã‚°ãƒ­ãƒ¼ãƒãƒ«å¤‰æ•° ==========
let FORTUNE_DATA = null; // å ã„ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸ãƒ‡ãƒ¼ã‚¿
let LOADING_ERROR = false; // èª­ã¿è¾¼ã¿ã‚¨ãƒ©ãƒ¼ãƒ•ãƒ©ã‚°

// ========== ãƒ‡ãƒ¼ã‚¿èª­ã¿è¾¼ã¿ ==========
async function loadFortuneMessages() {
  try {
    const response = await fetch('./archetype_fortune.json', {
      cache: 'no-cache' // é–‹ç™ºä¸­ã¯ã‚­ãƒ£ãƒƒã‚·ãƒ¥ç„¡åŠ¹
    });
    if (!response.ok) throw new Error('ãƒ‡ãƒ¼ã‚¿èª­ã¿è¾¼ã¿å¤±æ•—');
    return await response.json();
  } catch (error) {
    console.error('å ã„ãƒ‡ãƒ¼ã‚¿ã®èª­ã¿è¾¼ã¿ã‚¨ãƒ©ãƒ¼:', error);
    LOADING_ERROR = true;
    return null;
  }
}

// ========== ãƒ‡ãƒ¼ã‚¿ ==========
const ARCHETYPES = [
  {id:'alan',   name:'ã‚¢ãƒ©ãƒ³ã®é­‚ï¼ˆæ¶ã‘æ©‹ï¼‰', desc:'äºŒã¤ã®ä¸–ç•Œã®é–“ã«ç«‹ã¡ã€èª¿å’Œã¨ç†è§£ã‚’æ±‚ã‚ã‚‹è€…ã€‚', av:'av-alan', initials:'ã‚¢ãƒ©'},
  {id:'drake',  name:'ãƒ‰ãƒ¬ã‚¤ã‚¯ã®é­‚ï¼ˆå®ˆè­·è€…ï¼‰', desc:'æ„›ã™ã‚‹è€…ã‚’å®ˆã‚‹ãŸã‚ã«ã€å›°é›£ã«ç«‹ã¡å‘ã‹ã†å¼·ã•ã¨è„†ã•ã‚’æŒã¤è€…ã€‚', av:'av-drake', initials:'ãƒ‰ãƒ¬'},
  {id:'nester', name:'ãƒã‚¹ã‚¿ãƒ¼ã®é­‚ï¼ˆè¦³å¯Ÿè€…ï¼‰', desc:'é«˜ãè¦–ç‚¹ã‹ã‚‰æœ¬è³ªã‚’è¦‹æŠœãã€æµã‚Œã«èº«ã‚’ä»»ã›ã‚‹çŸ¥æµã‚’æŒã¤è€…ã€‚', av:'av-nester', initials:'ãƒã‚¹'},
  {id:'lilia',  name:'ãƒªãƒªã‚¢ã®é­‚ï¼ˆè‡ªç”±ãªã‚‹é¢¨ï¼‰', desc:'å¥½å¥‡å¿ƒã«æº€ã¡ã€è‡ªç„¶ã¨å…±é³´ã—ã€å½¢ã«ç¸›ã‚‰ã‚ŒãšçœŸå®Ÿã‚’ä¼ãˆã‚‹è€…ã€‚', av:'av-lilia', initials:'ãƒªãƒª'},
  {id:'laila',  name:'ãƒ©ã‚¤ãƒ©ã®é­‚ï¼ˆèªã‚Šéƒ¨ï¼‰', desc:'å¤ãçŸ¥æµã‚’å°Šã³ã€éå»ã‹ã‚‰å­¦ã³ã€æœªæ¥ã¸ç‰©èªã‚’ç¹‹ãè€…ã€‚', av:'av-laila', initials:'ãƒ©ã‚¤'}
];

// å½¹å‰²ï¼ˆãƒ‘ã‚¹ï¼‰å®šç¾©ï¼š4è»¸ãƒ™ã‚¯ãƒˆãƒ«ï¼ˆvector/basis/mood/socialï¼‰å„ -1..+1
const ROLES = [
  {id:'disciple', name:'éŠ€ç«œã®å¾’ (Disciple)', v:[-1,-1,-1,-1], desc:'è–åŸŸã«ç•™ã¾ã‚Šã€æ•™ãˆã‚’å†…çœã—ã¦åŠ›ã‚’è“„ãˆã‚‹ã¹ãæ—¥ã€‚'},
  {id:'stormblade', name:'ã‚¹ãƒˆãƒ¼ãƒ ãƒ–ãƒ¬ã‚¤ãƒ‰ (Stormblade)', v:[+1,+1,+1,+1], desc:'ä»²é–“ã‚’å®ˆã‚Šã€æ­£é¢ã‹ã‚‰å›°é›£ã«æŒ‘ã‚€ã¹ãæ—¥ã€‚'},
  {id:'wind_guide', name:'é¢¨ã®å°ãæ‰‹ (Wind Guide)', v:[-1,-1,-1,+0], desc:'é«˜ãè¦–ç‚¹ã§è¦³å¯Ÿã—ã€æµã‚Œã«é€†ã‚‰ã‚ãšæœ¬è³ªã‚’è¦‹æŠœãæ—¥ã€‚'},
  {id:'lorekeeper', name:'å¤ãèªã‚Šéƒ¨ (Lorekeeper)', v:[-1,+1,-1,-1], desc:'æ›¸ã‚’é–‹ãã€çŸ¥ã®ç¶™æ‰¿ã‹ã‚‰æœªæ¥ã‚’è¦‹å‡ºã™æ—¥ã€‚'},
  {id:'knight', name:'ç‹å›½ã®é¨å£« (Knight)', v:[+1,+1,+1,+1], desc:'çµ„ç¹”ã®ä¸­ã§å½¹ç›®ã‚’æœãŸã—ã€ç§©åºã‚’å®ˆã‚‹æ—¥ã€‚'},
  {id:'healer', name:'è–åŸŸã®ç™’ã—æ‰‹ (Healer)', v:[-1,-1,-1,+1], desc:'ä»–è€…ã®ç—›ã¿ã«å¯„ã‚Šæ·»ã„ã€è‡ªç„¶ã®åŠ›ã§å’Œã‚‰ã’ã‚‹æ—¥ã€‚'}
];

// Phase2 è³ªå•ï¼ˆ2æŠUIï¼‰ï¼šè»¸ãƒãƒƒãƒ”ãƒ³ã‚°
const QUESTIONS = [
  { id:1, text:'ä»Šæ—¥ã®ã‚ãªãŸã¯ã€ãƒ«ãƒŠãƒ«ã®å·£ã«ç•™ã¾ã‚‹ã‹ã€ãƒã‚¯ã‚µãƒ¼ãƒˆã®ç”ºã¸å‘ã‹ã†ã‹ï¼Ÿ', axis:'vector', left:'å·£ã«ç•™ã¾ã‚‹', right:'ç”ºã¸å‘ã‹ã†' },
  { id:2, text:'é“ã‚’é¸ã¶ãªã‚‰ã€é¢¨ã®å›ãã«è€³ã‚’æ¾„ã¾ã™ã‹ã€ãƒ©ã‚¤ãƒ©ã®å¤åœ°å›³ã‚’é ¼ã‚‹ã‹ï¼Ÿ', axis:'basis', left:'é¢¨ã®å›ã', right:'å¤åœ°å›³' },
  { id:3, text:'ã‚ãªãŸã®å¿ƒã¯ã€é™ã‹ãªè–åŸŸã®æ³‰ã‹ã€è’ã‚Œç‹‚ã†åµã®å‰£ã‹ï¼Ÿ', axis:'mood', left:'é™ã‹ãªæ³‰', right:'åµã®å‰£' },
  { id:4, text:'åŠ›ã‚’å¾—ã‚‹ãªã‚‰ã€ä¸€äººã§ç‘æƒ³ã™ã‚‹ã‹ã€ä»²é–“ã¨å…±ã«å„€å¼ã‚’è¡Œã†ã‹ï¼Ÿ', axis:'social', left:'ä¸€äººã§ç‘æƒ³', right:'ä»²é–“ã¨å„€å¼' },
  { id:5, text:'ä»Šã€å‘ãåˆã†ã¹ãã¯ã€è‡ªã‚‰ã®ææ€–ã‹ã€ç‹ã®é‡æœ›ã‹ï¼Ÿ', axis:'vector', left:'è‡ªã‚‰ã®ææ€–', right:'ç‹ã®é‡æœ›' },
  { id:6, text:'é­”æ³•ã‚’ç´¡ããªã‚‰ã€ãƒªãƒªã‚¢ã®ã‚ˆã†ã«èˆã†ã‹ã€ãƒã‚°ãƒŠã‚¹ã®ã‚ˆã†ã«è© å”±ã™ã‚‹ã‹ï¼Ÿ', axis:'basis', left:'ãƒªãƒªã‚¢ã®ã‚ˆã†ã«', right:'ãƒã‚°ãƒŠã‚¹ã®ã‚ˆã†ã«' },
  { id:7, text:'ãƒ«ãƒŠãƒ«ã®ã€Œå¤§åœ°å¸°é‚„ã€ã‚’å‰ã«ã—ãŸæ™‚ã€ã‚ãªãŸã¯ä½•ã‚’æ„Ÿã˜ã‚‹ã‹ï¼Ÿ', axis:'mood', left:'é™ã‹ãªå—å®¹', right:'é‹å‘½ã¸ã®æŠµæŠ—' },
  { id:8, text:'çŸ¥æµã‚’æ±‚ã‚ã‚‹ãªã‚‰ã€ãƒã‚¹ã‚¿ãƒ¼ã¨ã®å¯¾è©±ã‹ã€å­¦é™¢ã§ã®è­°è«–ã‹ï¼Ÿ', axis:'social', left:'ãƒã‚¹ã‚¿ãƒ¼ã¨ã®å¯¾è©±', right:'å­¦é™¢ã§ã®è­°è«–' },
  { id:9, text:'ä»Šæ—¥ã®ã‚ãªãŸã®æ‰‹ã¯ã€ä½•ã‚’æ±‚ã‚ã¦ã„ã‚‹ã‹ï¼Ÿ', axis:'vector', left:'é±—ã®ãŠå®ˆã‚Šã‚’æ¡ã‚‹', right:'å‰£ã®æŸ„ã‚’æ¡ã‚‹' },
  { id:10, text:'æœ‰é™ã®å‘½ã‚’å‰ã«ã—ã¦ã€ä½•ã‚’æ€ã†ã‹ï¼Ÿ', axis:'basis', left:'ç„¡é™ã®ä¾¡å€¤ã‚’è¦‹å‡ºã™', right:'æ°¸é ã‚’æ¸‡æœ›ã™ã‚‹' }
];

// ========== ãƒ¦ãƒ¼ãƒ†ã‚£ãƒªãƒ†ã‚£é–¢æ•° ==========
const $ = (s, r=document)=>r.querySelector(s);
const $$ = (s, r=document)=>Array.from(r.querySelectorAll(s));

function getArchetype(){ 
  try{ 
    return JSON.parse(localStorage.getItem('userArchetype')); 
  }catch{
    return null;
  } 
}

function setArchetype(obj){ 
  localStorage.setItem('userArchetype', JSON.stringify(obj)); 
}

function normalize2(checked){ 
  // å·¦: -1, å³: +1
  return checked ? +1 : -1;
}

// ========== è£œåŠ©é–¢æ•° ==========
// è©³ç´°ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸å–å¾—
function getDetailMessage(archId, roleId) {
  if (!FORTUNE_DATA) return null;
  const key = `${archId}_${roleId}`;
  return FORTUNE_DATA.base_patterns?.find(p => p.id === key);
}

// æ›œæ—¥åˆ¥ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸å–å¾—
function getDailyMessage(archId) {
  if (!FORTUNE_DATA) return null;
  const dayOfWeek = ['sunday','monday','tuesday','wednesday','thursday','friday','saturday'][new Date().getDay()];
  const key = `${archId}_${dayOfWeek}`;
  return FORTUNE_DATA.daily_patterns?.find(p => p.id === key);
}

// ç‰¹åˆ¥ãªæ—¥ã®ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸å–å¾—
function getSpecialMessage(archId) {
  if (!FORTUNE_DATA) return null;
  
  const today = new Date();
  const date = today.getDate();
  
  // æœˆåˆï¼ˆ1-3æ—¥ï¼‰
  if (date <= 3) {
    return FORTUNE_DATA.special_patterns?.month_start?.find(p => p.archetype === archId);
  }
  // æœˆåŠã°ï¼ˆ14-16æ—¥ï¼‰
  if (date >= 14 && date <= 16) {
    return FORTUNE_DATA.special_patterns?.month_middle?.find(p => p.archetype === archId);
  }
  // æœˆæœ«ï¼ˆæœˆã®æœ€çµ‚3æ—¥ï¼‰
  const lastDay = new Date(today.getFullYear(), today.getMonth() + 1, 0).getDate();
  if (date >= lastDay - 2) {
    return FORTUNE_DATA.special_patterns?.month_end?.find(p => p.archetype === archId);
  }
  
  // ä»–ã®ç‰¹åˆ¥ãªæ—¥ã®åˆ¤å®šã‚‚è¿½åŠ å¯èƒ½
  return null;
}

// ========== UIæ§‹ç¯‰é–¢æ•° ==========
function renderArchetypeBox(){
  const a = getArchetype();
  if(!a){ 
    $('#archetypeBox').hidden = true; 
    return; 
  }
  $('#archetypeBox').hidden = false;
  $('#archText').innerHTML = `<div class="pill">ç¢ºå®šæ¸ˆã¿ã®å…ƒå‹</div>
    <div style="display:flex;align-items:center;gap:10px;margin-top:6px">
      <span class="avatar ${a.av}" aria-hidden="true">${a.initials}</span>
      <div>
        <h3 style="margin:.25rem 0 0">${a.name}</h3>
        <p class="note" style="margin:.25rem 0 0">${a.desc}</p>
      </div>
    </div>
    <div class="grid2" style="margin-top:10px">
      <button class="btn ghost" id="btnChange">å…ƒå‹ã‚’ã‚„ã‚Šç›´ã™ï¼ˆã“ã®ç«¯æœ«ã®ã¿ï¼‰</button>
      <a class="btn" href="#p2h">åã®è³ªå•ã¸é€²ã‚€</a>
    </div>`;
  $('#btnChange').addEventListener('click', ()=>{
    if(confirm('å…ƒå‹ã‚’æœªè¨­å®šã«æˆ»ã—ã¾ã™ã‹ï¼Ÿï¼ˆã“ã®ç«¯æœ«ã®ã¿ï¼‰')){ 
      localStorage.removeItem('userArchetype'); 
      apply(); 
    }
  });
}

function showPhase1IfNeeded(){
  const has = !!getArchetype();
  $('#phase1').hidden = has; // åˆå›ã®ã¿è¡¨ç¤º
  $('#phase2').hidden = !has; // å…ƒå‹ãŒã‚ã‚Œã°è³ªå•ã‚’è¡¨ç¤º
}

function pickArchetypeFromAnswers(ans){
  const s = {alan:0, drake:0, nester:0, lilia:0, laila:0};
  const {logic, spirit, vector, social} = ans;
  if(logic>0){ 
    s.drake+=1; s.laila+=1; 
  } else { 
    s.alan+=1; s.nester+=1; s.lilia+=1; 
  }
  if(vector>0){ 
    s.drake+=1; 
  } else { 
    s.laila+=0.5; s.nester+=0.5; s.alan+=0.5; 
  }
  if(spirit<0){ 
    s.lilia+=1; s.nester+=0.5; 
  } else { 
    s.laila+=0.7; 
  }
  if(social>0){ 
    s.alan+=0.4; s.drake+=0.4; 
  } else { 
    s.nester+=0.4; s.laila+=0.4; 
  }
  const bestId = Object.entries(s).sort((a,b)=>b[1]-a[1])[0][0];
  return ARCHETYPES.find(a=>a.id===bestId);
}

function buildP1(){
  $('#btnP1').addEventListener('click', ()=>{
    const vals = {logic:null, spirit:null, vector:null, social:null};
    $$('#phase1 .toggle').forEach(el=>{
      const axis = el.getAttribute('data-axis');
      const checked = el.querySelector('input')?.checked || false;
      vals[axis] = normalize2(checked);
    });
    if(Object.values(vals).some(v=>v===null)){
      alert('å…¨ã¦ã®è¨­å•ã«ãŠç­”ãˆãã ã•ã„'); 
      return;
    }
    const a = pickArchetypeFromAnswers(vals);
    setArchetype(a); 
    apply();
    window.scrollTo({top:0, behavior:'smooth'});
  });
  $('#btnP1Reset').addEventListener('click', ()=>{
    $$('#phase1 .toggle input').forEach(i=>i.checked=false);
  });
}

function buildPhase2(){
  const box = $('#qList'); 
  box.innerHTML='';
  QUESTIONS.forEach(q=>{
    const row = document.createElement('div'); 
    row.className='q';
    row.innerHTML = `<div class="t">${q.id}. ${q.text}</div>`;
    const tog = document.createElement('div'); 
    tog.className='toggle'; 
    tog.setAttribute('data-axis', q.axis);
    tog.innerHTML = `
      <span class="opt">${q.left}</span>
      <label class="switch"><input type="checkbox" id="p2q${q.id}"><span class="knob"></span></label>
      <span class="opt">${q.right}</span>`;
    row.appendChild(tog); 
    box.appendChild(row);
  });

  $('#btnEval').addEventListener('click', ()=>{
    const axes = { vector:0, basis:0, mood:0, social:0 };
    let answered = true;
    $$('#qList .toggle').forEach(sc=>{
      const ch = sc.querySelector('input');
      if(!ch){ 
        answered=false; 
        return; 
      }
      const axis = sc.getAttribute('data-axis');
      axes[axis]+= normalize2(ch.checked);
    });
    if(!answered){ 
      alert('ã¾ã æœªå›ç­”ã®è¨­å•ãŒã‚ã‚Šã¾ã™'); 
      return; 
    }
    // æ­£è¦åŒ–ï¼ˆå¹³å‡ï¼‰
    axes.vector/=3; 
    axes.basis/=3; 
    axes.mood/=2; 
    axes.social/=2;

    // è¿‘ã„å½¹å‰²ã‚’é¸ã¶ï¼ˆãƒ¦ãƒ¼ã‚¯ãƒªãƒƒãƒ‰è·é›¢ï¼‰
    const vec = [axes.vector, axes.basis, axes.mood, axes.social];
    let best=ROLES[0], bestDist=1e9;
    for(const r of ROLES){
      const d = Math.hypot(r.v[0]-vec[0], r.v[1]-vec[1], r.v[2]-vec[2], r.v[3]-vec[3]);
      if(d<bestDist){ 
        best=r; 
        bestDist=d; 
      }
    }

    // ç¥è¨—ãƒ†ã‚­ã‚¹ãƒˆç”Ÿæˆ
    const arch = getArchetype() || ARCHETYPES[0];
    const oracle = buildOracle(arch.id, best.id);
    
    // è©³ç´°ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸ã®å–å¾—ï¼ˆJSONã‹ã‚‰ï¼‰
    const detailMessage = getDetailMessage(arch.id, best.id);
    const dailyMessage = getDailyMessage(arch.id);
    const specialMessage = getSpecialMessage(arch.id);

    $('#resultBox').hidden=false;
    $('#roleText').innerHTML = `
      <div class="pill">ä»Šæ—¥ã®å½¹å‰²ï¼ˆãƒ‘ã‚¹ï¼‰</div>
      <h3 style="margin:.5rem 0 0">${best.name}</h3>
      <p class="note" style="margin:.25rem 0 8px">${best.desc}</p>
      
      <div class="pill">ã‚ãªãŸã®å…ƒå‹</div>
      <div style="display:flex;align-items:center;gap:10px;margin-top:6px">
        <span class="avatar ${arch.av}" aria-hidden="true">${arch.initials}</span>
        <strong>${arch.name}</strong>
      </div>
      
      <hr style="border:0;border-top:1px dashed rgba(141,208,255,.25);margin:10px 0">
      
      <h3 style="margin:.25rem 0 .5rem">éŠ€ç«œã®ç¥è¨—</h3>
      <blockquote style="margin:0;border-left:3px solid rgba(141,208,255,.4);padding:8px 10px;background:#0f1626">
        ${oracle}
      </blockquote>
      
      ${detailMessage ? `
      <div style="margin-top:12px">
        <h4 style="margin:.25rem 0 .5rem;color:var(--accent)">è©³ç´°ãªãƒ¡ãƒƒã‚»ãƒ¼ã‚¸</h4>
        <p style="margin:.5rem 0">${detailMessage.message}</p>
        <p class="note"><strong>ä»Šæ—¥ã®å°ãï¼š</strong>${detailMessage.guidance}</p>
        <div style="margin-top:8px">
          ${detailMessage.power_words?.map(w => `<span class="pill" style="margin-right:4px">${w}</span>`).join('') || ''}
        </div>
      </div>
      ` : ''}
      
      ${dailyMessage ? `
      <div style="margin-top:12px;padding:8px;background:rgba(141,208,255,.06);border-radius:8px">
        <h5 style="margin:0 0 4px;color:var(--accent)">${dailyMessage.title}</h5>
        <p class="note" style="margin:0">${dailyMessage.message}</p>
      </div>
      ` : ''}
      
      ${specialMessage ? `
      <div style="margin-top:12px;padding:8px;background:rgba(255,208,141,.08);border-radius:8px">
        <h5 style="margin:0 0 4px;color:#ffd08d">âœ¨ ${specialMessage.title}</h5>
        <p class="note" style="margin:0">${specialMessage.message}</p>
      </div>
      ` : ''}
    `;

    $('#resultBox').scrollIntoView({behavior:'smooth', block:'start'});
    window.dataLayer = window.dataLayer || []; 
    window.dataLayer.push({event:'eval_path', role:best.id});
  });

  $('#btnClearQ').addEventListener('click', ()=>{
    $$('#qList input').forEach(i=>i.checked=false);
  });
}

function buildOracle(archId, roleId) {
  // ãƒ‡ãƒ¼ã‚¿æœªèª­ã¿è¾¼ã¿æ™‚ã®ãƒ•ã‚©ãƒ¼ãƒ«ãƒãƒƒã‚¯
  if (!FORTUNE_DATA || LOADING_ERROR) {
    const archName = (ARCHETYPES.find(a=>a.id===archId)||ARCHETYPES[0]).name.split('ï¼ˆ')[0];
    const roleName = (ROLES.find(r=>r.id===roleId)||ROLES[0]).name.split(' ')[0];
    return `ã€Œ${archName}ã‚ˆã€‚ä»Šæ—¥ã¯ã€${roleName}ã€ã¨ã—ã¦æ­©ã‚ã€‚ææ€–ã§ã¯ãªãæ„›ã‚’é¸ã³ã€æµã‚Œã¨èª¿å’Œã—ãªãŒã‚‰ä¸€æ­©ã‚’é€²ã‚ã€‚æœ‰é™ã®æ™‚ã«ã“ãã€åŠ›ã¯æ­£ã—ãè¼ãã€‚ã€`;
  }

  // åŸºæœ¬ãƒ‘ã‚¿ãƒ¼ãƒ³ã®å–å¾—
  const baseKey = `${archId}_${roleId}`;
  const basePattern = FORTUNE_DATA.base_patterns?.find(p => p.id === baseKey);
  
  if (!basePattern) {
    // åŸºæœ¬ãƒ‘ã‚¿ãƒ¼ãƒ³ãŒè¦‹ã¤ã‹ã‚‰ãªã„å ´åˆã®ãƒ•ã‚©ãƒ¼ãƒ«ãƒãƒƒã‚¯
    return buildGenericOracle(archId, roleId);
  }

  // ç¥è¨—ãƒ†ã‚­ã‚¹ãƒˆã®çµ„ã¿ç«‹ã¦
  let oracleText = `ã€Œ${basePattern.oracle}ã€`;
  
  return oracleText;
}

// æ±ç”¨ç¥è¨—ç”Ÿæˆï¼ˆãƒ•ã‚©ãƒ¼ãƒ«ãƒãƒƒã‚¯ç”¨ï¼‰
function buildGenericOracle(archId, roleId) {
  const archData = ARCHETYPES.find(a=>a.id===archId) || ARCHETYPES[0];
  const roleData = ROLES.find(r=>r.id===roleId) || ROLES[0];
  const archName = archData.name.split('ï¼ˆ')[0];
  const roleName = roleData.name.split(' ')[0];
  return `ã€Œ${archName}ã‚ˆã€‚ä»Šæ—¥ã¯ã€${roleName}ã€ã¨ã—ã¦æ­©ã‚ã€‚ææ€–ã§ã¯ãªãæ„›ã‚’é¸ã³ã€æµã‚Œã¨èª¿å’Œã—ãªãŒã‚‰ä¸€æ­©ã‚’é€²ã‚ã€‚ã€`;
}

function apply(){
  renderArchetypeBox();
  showPhase1IfNeeded();
}

// ========== èµ·å‹•é–¢æ•° ==========
async function start(){
  // ãƒ­ãƒ¼ãƒ‡ã‚£ãƒ³ã‚°è¡¨ç¤º
  const loadingDiv = document.createElement('div');
  loadingDiv.id = 'loadingMsg';
  loadingDiv.innerHTML = '<div class="card"><div class="card-c">å ã„ãƒ‡ãƒ¼ã‚¿ã‚’èª­ã¿è¾¼ã¿ä¸­...</div></div>';
  $('.wrap').prepend(loadingDiv);
  
  // ãƒ‡ãƒ¼ã‚¿èª­ã¿è¾¼ã¿
  FORTUNE_DATA = await loadFortuneMessages();
  
  // ãƒ­ãƒ¼ãƒ‡ã‚£ãƒ³ã‚°è¡¨ç¤ºã‚’å‰Šé™¤
  loadingDiv.remove();
  
  // ã‚¨ãƒ©ãƒ¼æ™‚ã®è­¦å‘Šè¡¨ç¤º
  if (LOADING_ERROR) {
    const errorDiv = document.createElement('div');
    errorDiv.className = 'card';
    errorDiv.style.background = 'rgba(255,100,100,0.1)';
    errorDiv.innerHTML = '<div class="card-c note">âš ï¸ å ã„ãƒ‡ãƒ¼ã‚¿ã®èª­ã¿è¾¼ã¿ã«å¤±æ•—ã—ã¾ã—ãŸã€‚åŸºæœ¬æ©Ÿèƒ½ã®ã¿åˆ©ç”¨å¯èƒ½ã§ã™ã€‚</div>';
    $('.wrap').prepend(errorDiv);
  }
  
  // æ—¢å­˜ã®åˆæœŸåŒ–å‡¦ç†
  buildP1();
  buildPhase2();
  apply();
  
  // Bottom Nav ç¾åœ¨åœ°
  const path = location.pathname.split('/').pop() || 'index.html';
  document.querySelectorAll('.bottom-nav a').forEach(a=>{
    const href = a.getAttribute('href')||'';
    if(href.endsWith(path)){ 
      a.classList.add('bn-accent'); 
      a.setAttribute('aria-current','page');
    }
  });
}

// starté–¢æ•°ã‚’å‘¼ã³å‡ºã—
start();
</script>
</body>
</html>
